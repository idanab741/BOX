<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ארנק חכם – v12 Pro (Mobile)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: radial-gradient(1200px 600px at 80% -10%, #0ea5e922 0%, transparent 60%),
            radial-gradient(1000px 500px at 10% 0%, #10b98122 0%, transparent 55%),
            linear-gradient(to bottom,#0a0f1e,#0c1123 40%,#0b1020);
      --card:#0f172aee;
      --ink:#e5e7eb;
      --muted:#95a4b9;
      --accent:#10b981;
      --accent-2:#34d399;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ring: 0 0 0 1px rgba(255,255,255,.06), 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      --radius:16px;
      --tap:44px;
    }
    html,body{height:100%}
    html{font-size:16px}
    body{
      font-family:'Rubik',ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      padding-bottom:calc(env(safe-area-inset-bottom) + 84px);
    }
    .container{max-width:28rem;margin-inline:auto}
    .card{border-radius:var(--radius); background:var(--card); box-shadow:var(--ring); backdrop-filter:saturate(120%) blur(6px)}
    .chip{border-radius:9999px;padding:.35rem .6rem;background:#0b1224;color:#bfe7d8;font-weight:700;font-size:.8rem;border:1px solid rgba(16,185,129,.35)}
    .row{min-height:var(--tap); padding:.6rem .75rem; border-radius:12px}
    .row:hover{background:#0b1224}
    .btn{border-radius:12px; font-weight:800; min-height:var(--tap); padding:.65rem .9rem}
    .btn-prim{background:var(--accent);color:#012417}
    .btn-ghost{background:#0b1224;color:var(--ink);border:1px solid rgba(255,255,255,.06)}
    .btn-danger{background:#7f1d1d;color:#fecaca;border:1px solid rgba(239,68,68,.45)}
    .kpi{background:#0b1224;border-radius:14px;padding:.6rem .75rem}
    .progress{height:8px;border-radius:999px;background:#1f2937;overflow:hidden}
    .progress > div{height:100%;background:var(--accent)}
    .progress.warn > div{background:var(--warn)}
    .progress.danger > div{background:var(--danger)}
    *{touch-action:manipulation}
    :focus-visible{outline:3px solid var(--accent-2); outline-offset:2px}
    ::placeholder{color:#6b7d96}
    .seg{background:#0b1224;padding:4px;border-radius:12px;display:flex;gap:4px;border:1px solid rgba(255,255,255,.06)}
    .seg button{flex:1;border-radius:10px;padding:.5rem .75rem;font-weight:800;color:#9bb2cc;font-size:.9rem}
    .seg .on{background:#0f172a;color:#cdeee3;box-shadow:0 1px 2px rgba(0,0,0,.25);border:1px solid rgba(16,185,129,.35)}
    .input{border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0b1224;color:var(--ink);padding:.8rem .9rem}
    .label{color:var(--muted);font-size:.8rem}
    .badge{font-size:.7rem;border:1px solid rgba(255,255,255,.12);padding:.15rem .45rem;border-radius:999px;background:#0b1224}
  </style>
</head>
<body>
  <main class="container p-3 space-y-4">
    <!-- HEADER -->
    <section class="card p-4" aria-label="שם אפליקציה">
      <div class="flex items-center justify-between gap-2">
        <div class="flex items-center gap-2">
          <div class="size-8 rounded-xl bg-emerald-500/20 grid place-items-center text-emerald-300">₪</div>
          <h1 class="text-[clamp(1rem,3.6vw,1.2rem)] font-extrabold tracking-tight">ארנק חכם</h1>
        </div>
        <button id="btnMonthPicker" class="chip text-xs" type="button">בחר חודש ▾</button>
      </div>
      <div id="currentMonthLabel" class="text-[.76rem] text-slate-400 mt-2"></div>
    </section>

    <!-- TABS -->
    <nav class="seg card p-1" role="tablist" aria-label="ניווט">
      <button class="on" role="tab" aria-selected="true" aria-controls="view-home" data-view="home" type="button">ניהול מעקב</button>
      <button role="tab" aria-selected="false" aria-controls="view-expenses" data-view="expenses" type="button">הוצאות</button>
      <button role="tab" aria-selected="false" aria-controls="view-savings" data-view="savings" type="button">חיסכון</button>
    </nav>

    <!-- HOME -->
    <section id="view-home" class="space-y-4" data-view-panel="home">
      <!-- CASH (עו״ש) with minimize -->
      <section class="card p-4" role="region" aria-labelledby="sec-cash">
        <div class="flex items-center justify-between">
          <h3 id="sec-cash" class="text-[.95rem] font-semibold">עובר ושב</h3>
          <div class="flex items-center gap-2">
            <span id="cashNow" class="text-xl font-extrabold">₪0</span>
            <button id="cashToggle" class="btn btn-ghost text-xs min-h-[36px]" type="button" title="מזער/הצג">–</button>
          </div>
        </div>
        <div id="cashBody" class="mt-3 space-y-2">
          <form id="formCash" class="space-y-2">
            <div class="text-[.8rem] text-slate-400">הזנת יתרת עו״ש לחודש הנוכחי (עוגן לחישוב קדימה)</div>
            <div class="flex gap-2">
              <input id="cashInput" class="input w-full text-base text-right" placeholder="לדוגמה: 75000" inputmode="decimal" />
              <button class="btn btn-prim">שמור</button>
            </div>
          </form>
          <div class="text-[.72rem] text-slate-500">ברירת מחדל: יתרה מתגלגלת קדימה אוטומטית. הזנה ידנית מחליפה אותה לחודש זה והלאה.</div>
        </div>
      </section>

      <!-- KPIs -->
      <header class="card p-4 flex flex-col gap-3" role="banner">
        <div class="grid grid-cols-2 gap-2 text-[.9rem]" role="group" aria-label="מדדים חודשיים">
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">הוצאות</span><b id="kpiCurExp">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">תקציב</span><b id="kpiBudget">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">עו״ש</span><b id="kpiCash">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">עודף</span><b id="kpiSurplus">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">חיסכון</span><b id="kpiSavingsSum">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">פנסיה</span><b id="kpiPensionSum">₪0</b></div>
        </div>
      </header>

      <!-- Gauge + budget input at top -->
      <section class="grid grid-cols-1 gap-4">
        <div class="card p-4" role="region" aria-label="מד ניצול חודשי">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <span class="chip text-[.7rem]">ניצול חודשי</span>
              <span id="gaugePctText" class="text-xs font-extrabold">0%</span>
            </div>
            <form id="formBudget" class="flex items-center gap-2">
              <input id="budgetInput" class="input text-right text-sm w-36" placeholder="תקציב לחודש" inputmode="decimal" />
              <button class="btn btn-prim text-xs min-h-[36px]">שמור</button>
            </form>
          </div>
          <div class="relative w-full" style="aspect-ratio:2/1" aria-hidden="true">
            <svg id="gsvg" class="absolute inset-0" viewBox="0 0 100 60" preserveAspectRatio="xMidYMid meet">
              <defs>
                <linearGradient id="gg" x1="0" x2="1"><stop offset="0" stop-color="#10b981"/><stop offset="1" stop-color="#34d399"/></linearGradient>
              </defs>
              <path id="gTrack" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="#1f2937" stroke-width="12" stroke-linecap="round"/>
              <path id="gValue" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="url(#gg)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999"/>
              <text id="centerPct" x="50" y="42" text-anchor="middle" style="font-size:14px;fill:#e5e7eb;font-weight:800">0%</text>
            </svg>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-2 text-[.84rem]">
            <div class="bg-[#0b1224] rounded-lg p-2">הוצא עד כה: <b id="spentLabel">₪0</b></div>
            <div class="bg-[#0b1224] rounded-lg p-2 text-right">נותר/חריגה: <b id="leftLabel">₪0</b></div>
          </div>
        </div>
      </section>

      <!-- INCOMES -->
      <section class="card p-4" role="region" aria-labelledby="sec-income">
        <div class="flex items-center justify-between mb-3">
          <h3 id="sec-income" class="text-[.95rem] font-semibold">הכנסות</h3>
          <button id="btnAddIncomeInline" type="button" class="btn btn-prim text-xs">+ מקור</button>
        </div>
        <div class="flex items-center justify-between mb-2 text-[.9rem]">
          <div class="space-y-1">
            <div class="text-xs text-slate-400">ברוטו</div>
            <div id="grossSum" class="text-lg font-semibold">₪0</div>
          </div>
          <div class="space-y-1 text-right">
            <div class="text-xs text-slate-400">נטו</div>
            <div id="netSum" class="text-lg font-semibold">₪0</div>
          </div>
        </div>
        <form id="formIncomeInline" class="hidden space-y-2 mb-3" role="form">
          <input id="incomeNet" class="input w-full text-right" placeholder="נטו" inputmode="decimal" />
          <input id="incomeGross" class="input w-full text-right" placeholder="ברוטו (אופציונלי)" inputmode="decimal" />
          <input id="incomeSource" class="input w-full" placeholder="מקור (שכר/פרילנס...)" />
          <input type="date" id="incomeDate" class="input w-full" />
          <button class="btn btn-prim w-full">הוסף הכנסה</button>
        </form>
        <ul id="incomeList" class="text-[.9rem] space-y-1 max-h-40 overflow-auto" role="list"></ul>
      </section>
    </section>

    <!-- EXPENSES -->
    <section id="view-expenses" class="space-y-4 hidden" data-view-panel="expenses">
      <div class="seg card p-1" role="tablist" aria-label="סוג הוצאות">
        <button class="on" data-subview="exp-var" aria-selected="true" type="button">משתנות</button>
        <button data-subview="exp-fixed" aria-selected="false" type="button">קבועות</button>
      </div>

      <!-- Variable -->
      <div id="exp-var" class="space-y-3" data-subpanel="exp-var">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-[.95rem] font-semibold">הוצאות</h3>
            <div id="catBadge" class="chip hidden text-[.7rem]" aria-live="polite"></div>
          </div>
          <form id="formExpense" class="grid grid-cols-1 gap-3 mb-3" role="form">
            <input id="expAmount" class="input text-right" placeholder="סכום (למשל 129.9)" inputmode="decimal" required />
            <input id="expMerchant" class="input" placeholder="ספק/תיאור" />
            <select id="catSelect" class="input" required></select>
            <input type="date" id="expDate" class="input" />
            <button class="btn btn-prim">הוסף הוצאה</button>
          </form>

          <div class="rounded-xl p-3 mb-3 grid grid-cols-1 gap-2 bg-[#0b1224]" role="group" aria-label="מסננים">
            <input id="filterText" class="input" placeholder="חיפוש ספק/תיאור" aria-label="חיפוש" />
            <select id="filterCat" class="input" aria-label="סינון לפי קטגוריה"></select>
            <div class="grid grid-cols-2 gap-2">
              <input type="date" id="filterFrom" class="input" aria-label="מתאריך" />
              <input type="date" id="filterTo" class="input" aria-label="עד תאריך" />
            </div>
            <select id="sortBy" class="input" aria-label="מיון">
              <option value="date_desc">מיין: תאריך ↓</option>
              <option value="date_asc">מיין: תאריך ↑</option>
              <option value="amt_desc">מיין: סכום ↓</option>
              <option value="amt_asc">מיין: סכום ↑</option>
            </select>
            <label class="text-[.8rem] text-slate-400 flex items-center gap-2">
              <input type="checkbox" id="toggleFixedInList" class="accent-emerald-500" checked>
              הצג גם חיובים קבועים ברשימה
            </label>
          </div>

          <ul id="expenseList" class="text-[.92rem] space-y-1 max-h-[60vh] overflow-auto mt-1" role="list" aria-live="polite"></ul>
        </div>
      </div>

      <!-- Fixed -->
      <div id="exp-fixed" class="space-y-3 hidden" data-subpanel="exp-fixed">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">הוצאות קבועות חודשיות</h3>
          <form id="formFixedAdd" class="grid grid-cols-2 gap-2 mb-3">
            <input type="hidden" id="fixId" />
            <select id="fixGroup" class="input"></select>
            <input id="fixLabel" class="input" placeholder="תיאור (נטפליקס/ביטוח רכב...)" />
            <input id="fixAmount" class="input text-right" placeholder="סכום חודשי" inputmode="decimal" />
            <input type="date" id="fixStart" class="input" />
            <div class="grid grid-cols-2 gap-2 col-span-2">
              <input type="date" id="fixUntil" class="input" placeholder="עד תאריך (אופציונלי)" />
              <input type="number" id="fixPayday" class="input" placeholder="יום חיוב (1–31)" min="1" max="31" />
            </div>
            <div class="col-span-2 flex gap-2">
              <button class="btn btn-prim w-full" type="submit">הוסף/עדכן</button>
              <button class="btn btn-ghost w-full" type="button" id="fixReset">ניקוי</button>
            </div>
          </form>
          <div class="space-y-4" id="fixedGroupsWrap"></div>
        </div>
      </div>
    </section>

    <!-- SAVINGS -->
    <section id="view-savings" class="space-y-4 hidden" data-view-panel="savings">
      <div class="seg card p-1" role="tablist" aria-label="חיסכון – סוגים">
        <button class="on" data-subview="sav-pension" aria-selected="true" type="button">פנסיה</button>
        <button data-subview="sav-kran" aria-selected="false" type="button">קרן השתלמות</button>
        <button data-subview="sav-deposit" aria-selected="false" type="button">פיקדון כללי</button>
        <button data-subview="sav-goal" aria-selected="false" type="button">תוכנית חיסכון</button>
      </div>

      <div id="sav-pension" data-subpanel="sav-pension" class="space-y-3">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">פנסיה</h3>
          <form id="formPensionAdd" class="grid grid-cols-2 gap-2 mb-2">
            <input id="penOwner" class="input col-span-2" placeholder="בעל/ת החשבון" />
            <input id="penBase" class="input text-right" inputmode="decimal" placeholder="יתרה בחודש בסיס" />
            <input id="penMonthly" class="input text-right" inputmode="decimal" placeholder="הפקדה חודשית" />
            <input id="penBaseMonth" class="input" type="month" />
            <button class="btn btn-prim col-span-2">הוסף/עדכן</button>
          </form>
          <div class="kpi flex items-center justify-between"><span>סה״כ פנסיה</span><b id="penTotal">₪0</b></div>
          <ul id="pensionList" class="text-sm space-y-2 mt-2 max-h-48 overflow-auto"></ul>
        </div>
      </div>

      <div id="sav-kran" data-subpanel="sav-kran" class="space-y-3 hidden">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">קרן השתלמות</h3>
          <form id="formKeren" class="grid grid-cols-2 gap-2 mb-2">
            <input id="krName" class="input col-span-2" placeholder="שם הקרן" />
            <input id="krBase" class="input text-right" inputmode="decimal" placeholder="יתרה בחודש בסיס" />
            <input id="krMonthly" class="input text-right" inputmode="decimal" placeholder="הפקדה חודשית" />
            <input id="krBaseMonth" class="input" type="month" />
            <button class="btn btn-prim col-span-2">שמור</button>
          </form>
          <ul id="krList" class="space-y-2"></ul>
        </div>
      </div>

      <div id="sav-deposit" data-subpanel="sav-deposit" class="space-y-3 hidden">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">פיקדון כללי / קרן כספית</h3>
          <form id="formDeposit" class="grid grid-cols-2 gap-2 mb-2">
            <input id="depName" class="input col-span-2" placeholder="שם החשבון" />
            <input id="depBase" class="input text-right" inputmode="decimal" placeholder="יתרה בחודש בסיס" />
            <input id="depMonthly" class="input text-right" inputmode="decimal" placeholder="הפקדה חודשית" />
            <input id="depBaseMonth" class="input" type="month" />
            <button class="btn btn-prim col-span-2">שמור</button>
          </form>
          <ul id="depList" class="space-y-2"></ul>
        </div>
      </div>

      <div id="sav-goal" data-subpanel="sav-goal" class="space-y-3 hidden">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">תכנית חיסכון ייעודית</h3>
          <form id="formGoal" class="grid grid-cols-2 gap-2 mb-2">
            <input id="goalName" class="input col-span-2" placeholder="מטרה (חופשה/רכב/שיפוץ)" />
            <input id="goalTarget" class="input text-right" inputmode="decimal" placeholder="יעד ₪" />
            <input id="goalMonthly" class="input text-right" inputmode="decimal" placeholder="הפקדה חודשית" />
            <input id="goalBaseMonth" class="input" type="month" />
            <button class="btn btn-prim col-span-2">שמור</button>
          </form>
          <ul id="goalList" class="space-y-2"></ul>
        </div>
      </div>
    </section>

    <footer class="text-center text-[.7rem] text-slate-500 py-14" role="contentinfo">
      v12 • מובייל • RTL • Dark • דינאמי קדימה • מינימייז עו״ש • Gauge+תקציב • עיצוב חדש
    </footer>
  </main>

  <!-- QUICK BAR -->
  <nav class="fixed inset-x-0 bottom-0 bg-[#0b1224]/95 backdrop-blur border-t border-slate-800 p-3 z-30" role="navigation" aria-label="פעולות מהירות">
    <div class="container flex items-center justify-around gap-2">
      <button id="quickAddExpense" class="btn btn-prim text-sm w-full" type="button">+ הוצאה</button>
      <button id="quickAddIncome" class="btn btn-ghost text-sm w-full" type="button">+ הכנסה</button>
      <button id="quickAddRecurring" class="btn btn-ghost text-sm w-full" type="button">+ חיוב ↻</button>
    </div>
  </nav>

  <!-- TOASTS -->
  <div id="toastWrap" class="fixed bottom-[92px] right-4 flex flex-col gap-2 z-40" aria-live="polite" aria-atomic="true"></div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="hidden fixed inset-0 z-40 items-end md:items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative card w-full md:w-[520px] p-5 m-0 md:mx-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 id="editTitle" class="text-base font-semibold">עריכת רשומה</h3>
        <button id="editClose" class="min-h-[44px] min-w-[44px] text-slate-300 hover:text-white" aria-label="סגור" type="button">✕</button>
      </div>
      <form id="formEdit" class="grid grid-cols-2 gap-2" role="form">
        <input type="hidden" name="id" id="editId" />
        <label class="label" for="editType">סוג</label>
        <select name="type" id="editType" class="input">
          <option value="expense">הוצאה</option>
          <option value="income">הכנסה</option>
        </select>
        <label class="label" for="editAmount">סכום</label>
        <input name="amount" id="editAmount" class="input text-right" inputmode="decimal" />
        <label class="label" for="editMerchant">ספק/תיאור</label>
        <input name="merchant" id="editMerchant" class="input" />
        <label class="label" for="editCategory">קטגוריה</label>
        <select name="category" id="editCategory" class="input"></select>
        <label class="label" for="editDate">תאריך</label>
        <input type="date" name="date" id="editDate" class="input" />
        <div class="col-span-2 flex justify-between mt-2">
          <button id="editDelete" type="button" class="btn btn-danger">מחק</button>
          <div class="flex gap-2">
            <button type="button" id="editCancel" class="btn btn-ghost">בטל</button>
            <button class="btn btn-prim">שמור</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- MONTH PICKER -->
  <div id="monthPicker" class="hidden fixed inset-0 z-40 items-end md:items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="mpTitle">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative card w-full md:w-[520px] p-5 m-0 md:mx-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 id="mpTitle" class="text-base font-semibold">בחירת חודש</h3>
        <button id="mpClose" class="min-h-[44px] min-w-[44px] text-slate-300 hover:text-white" aria-label="סגור" type="button">✕</button>
      </div>
      <div id="mpGrid" class="grid grid-cols-3 gap-2"></div>
    </div>
  </div>

  <script>
    /* ========= UTIL ========= */
    const ILS = new Intl.NumberFormat('he-IL',{ style:'currency', currency:'ILS', minimumFractionDigits:0, maximumFractionDigits:0 });
    const ils = n => ILS.format(Math.round(Number(n||0)));
    const pad = n => String(n).padStart(2,'0');
    const ym = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
    const monthsDiff = (fromYM, toYM) => {
      const [fy,fm]=fromYM.split('-').map(Number);
      const [ty,tm]=toYM.split('-').map(Number);
      return (ty-fy)*12 + (tm-fm);
    };
    const toInputDate = iso => { const d=new Date(iso); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    const toNumber = v => { if (v==null) return 0; const s=String(v).replace(/[₪,\s]/g,''); const n=Number(s); return Number.isFinite(n)?n:0; };
    const uuid = () => (crypto?.randomUUID?.() || 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);} ));
    const esc = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    const prevYM = key => { const [y,m]=key.split('-').map(Number); const d=new Date(y,m-2,1); return ym(d); };

    function toast(msg){
      const wrap=document.getElementById('toastWrap');
      const t=document.createElement('div');
      t.className='card p-3 text-sm flex items-center gap-3';
      t.textContent=msg; wrap.appendChild(t);
      setTimeout(()=>{t.remove();},2500);
    }

    /* ========= DATA ========= */
    const ROOT_KEY = 'smartwallet_v12_root';

    // Groups for recurring (fixed) expenses
    const FIXED_GROUPS = ["שכירות","ארנונה","ועד בית","אינטרנט","חשמל","מים","סלולרי","ביטוחים","מנויים","חנייה","חינוך/גן","רכב – ביטוח/טסט/דלק","אחר"];
    const VARIABLE = ["מזון","מסעדות/בילויים/חיי לילה","קניות/אופנה","פארם/טיפוח","שונות","מתנות","תחבורה ציבורית/מוניות","נסיעות/טיסות","תחזוקת בית","בריאות/תרופות"];

    function defaultMonth(){
      return {
        budget: null,           // תקציב לחודש (אם null – משתמשים בערך אחרון אחורה)
        cashAnchor: null,       // יתרת עו״ש ידנית לחודש זה (אם null – חישוב אוטומטי)
        transactions: []        // {id,date,type:'income'|'expense',amount,gross?,category,merchant}
      };
    }

    function load(){ try{ return JSON.parse(localStorage.getItem(ROOT_KEY)) || {}; } catch{ return {}; } }
    function save(){ localStorage.setItem(ROOT_KEY, JSON.stringify(ROOT)); }

    let ROOT = load();
    if(!ROOT.version) ROOT.version = 12;
    if(!ROOT.start)   ROOT.start   = '2025-08';
    if(!ROOT.current) ROOT.current = '2025-08';
    if(!ROOT.months)  ROOT.months  = {};
    if(!ROOT.recurring) ROOT.recurring = []; // {id,group,label,amount,start,until,payday}
    if(!ROOT.savings) ROOT.savings = { krans:[], deposits:[], goals:[] }; // each: {id,name,base,monthly,baseMonth}
    if(!ROOT.pensions) ROOT.pensions = []; // {id,owner,base,monthly,baseMonth}
    if(!ROOT.ui) ROOT.ui = { cashCollapsed:false };

    function M(key=ROOT.current){ if(!ROOT.months[key]) ROOT.months[key] = defaultMonth(); return ROOT.months[key]; }

    /* ========= MONTH PICKER ========= */
    function monthLabel(key){ const d=new Date(key+'-01'); return d.toLocaleDateString('he-IL',{month:'long',year:'numeric'}); }
    function buildMonthPicker(){
      const grid = document.getElementById('mpGrid'); grid.innerHTML='';
      const start = new Date(2025,7,1);
      const end = new Date(new Date().getFullYear(), new Date().getMonth()+11, 1);
      for(let d=new Date(start); d<=end; d.setMonth(d.getMonth()+1)){
        const key=ym(d);
        const b=document.createElement('button');
        b.type='button'; b.className='btn btn-ghost';
        b.textContent=d.toLocaleDateString('he-IL',{month:'long',year:'2-digit'});
        b.addEventListener('click',()=>{ ROOT.current=key; save(); renderAll(); toggleMP(false); });
        grid.appendChild(b);
      }
    }
    function toggleMP(show){
      const m=document.getElementById('monthPicker');
      if(show){ buildMonthPicker(); m.classList.remove('hidden'); m.classList.add('flex');}
      else {m.classList.add('hidden'); m.classList.remove('flex');}
    }

    /* ========= RECURRING / SAVINGS / PENSION HELPERS ========= */
    function recurringForMonth(key){
      const startOf = new Date(key+'-01');
      return (ROOT.recurring||[]).filter(r=>{
        const s=new Date(r.start); const u=r.until? new Date(r.until) : null;
        return s<=startOf && (!u || u>=startOf);
      });
    }
    function recurringSum(key){ return recurringForMonth(key).reduce((s,r)=> s + toNumber(r.amount||0), 0); }

    function savingsMonthlyTotal(){
      const s1=(ROOT.savings?.krans||[]).reduce((s,x)=> s+toNumber(x.monthly||0),0);
      const s2=(ROOT.savings?.deposits||[]).reduce((s,x)=> s+toNumber(x.monthly||0),0);
      const s3=(ROOT.savings?.goals||[]).reduce((s,x)=> s+toNumber(x.monthly||0),0);
      return s1+s2+s3;
    }
    function accountBalance(base, monthly, baseMonth, key){
      const diff = Math.max(0, monthsDiff(baseMonth||ROOT.start, key));
      return toNumber(base||0) + toNumber(monthly||0)*diff;
    }
    function pensionsTotal(key=ROOT.current){
      return (ROOT.pensions||[]).reduce((s,p)=> s + accountBalance(p.base,p.monthly,p.baseMonth||ROOT.start,key), 0);
    }
    function savingsTotals(key=ROOT.current){
      const kr = (ROOT.savings.krans||[]).reduce((s,x)=> s+accountBalance(x.base,x.monthly,x.baseMonth||ROOT.start,key),0);
      const dp = (ROOT.savings.deposits||[]).reduce((s,x)=> s+accountBalance(x.base,x.monthly,x.baseMonth||ROOT.start,key),0);
      const gl = (ROOT.savings.goals||[]).reduce((s,x)=> s+Math.min(toNumber(x.target||Infinity), accountBalance(x.base||0,x.monthly,x.baseMonth||ROOT.start,key)),0);
      return {kr,dp,gl,total:kr+dp+gl};
    }

    /* ========= BUDGET (carry forward last set) ========= */
    function budgetFor(key){
      if(M(key).budget!=null) return Number(M(key).budget);
      // search backward for last non-null budget
      let cur = key;
      for(let i=0;i<240;i++){
        cur = prevYM(cur);
        if(!cur) break;
        if(ROOT.months[cur]?.budget!=null) return Number(ROOT.months[cur].budget);
        if(cur === ROOT.start) break;
      }
      return 0;
    }

    /* ========= TRANSACTIONS & TOTALS ========= */
    const isSameMonth = (iso, key=ROOT.current) => { const d=new Date(iso); const [y,m]=key.split('-').map(Number); return d.getFullYear()===y && (d.getMonth()+1)===m; };

    function totals(key=ROOT.current){
      let net=0, gross=0, expVar=0; const incomes=[], expenses=[];
      const tx = (M(key).transactions||[]).filter(t=> isSameMonth(t.date,key));
      for(const t of tx){
        if(t.type==='income'){ net += toNumber(t.amount); gross += toNumber(t.gross || t.amount); incomes.push(t); }
        else { expVar += toNumber(t.amount); expenses.push(t); }
      }
      const expFixed = recurringSum(key);
      return {net,gross,expVar,expFixed,incomes,expenses};
    }

    /* ========= CASH (auto-forward with anchors) ========= */
    function findEarliestAnchor(){
      // the first month having a manual cashAnchor; else treat ROOT.start as implicit 0
      const keys = Object.keys(ROOT.months).sort();
      for(const k of keys){ if(ROOT.months[k]?.cashAnchor!=null) return {key:k, value:Number(ROOT.months[k].cashAnchor)}; }
      return {key:ROOT.start, value:0};
    }
    function cashFor(key){
      // compute sequentially month by month from earliest anchor up to required key
      const anchor = findEarliestAnchor();
      let cur = anchor.key;
      let cash = Number(anchor.value||0);
      // if requested key equals anchor key: return anchor value
      if(key===cur) return cash;

      function nextYM(x){
        const [y,m]=x.split('-').map(Number); const d=new Date(y,m,1); return ym(d);
      }

      // accumulate forward
      for(let i=0;i<300;i++){
        const t = totals(cur);
        const budgetIgnore = budgetFor(cur); // not used in cash, only for gauge
        cash = cash + t.net - (t.expVar + t.expFixed); // auto rule
        const n = nextYM(cur);
        // apply manual override if exists on next month (becomes new anchor)
        if(ROOT.months[n]?.cashAnchor!=null) cash = Number(ROOT.months[n].cashAnchor);
        if(n===key) return cash;
        cur = n;
      }
      return cash;
    }

    /* ========= RENDER ========= */
    function setGauge(p, spent, left){
      const clamped = Math.max(0, Math.min(1.3, Number.isFinite(p)? p : 0));
      const path = document.getElementById('gValue');
      const len = path.getTotalLength ? path.getTotalLength() : 125.6;
      const draw = Math.min(len, len * Math.min(1, clamped));
      path.setAttribute('stroke-dasharray', `${draw} 999`);
      const pct = Math.round((clamped||0)*100);
      document.getElementById('gaugePctText').textContent = pct+'%';
      document.getElementById('centerPct').textContent = pct+'%';
      document.getElementById('spentLabel').textContent = ils(spent);
      const leftEl = document.getElementById('leftLabel');
      leftEl.textContent = ils(left);
      leftEl.className = (left < 0 ? 'text-red-400 ' : '') + 'font-extrabold';
    }

    function initCategorySelects(){
      const selAdd = document.getElementById('catSelect');
      const selEdit = document.getElementById('editCategory');
      const selFilter = document.getElementById('filterCat');
      [selAdd, selEdit, selFilter].forEach((sel)=>{
        if(!sel || sel.dataset.inited) return;
        const list = sel===selFilter ? ["כל הקטגוריות", ...VARIABLE, ...FIXED_GROUPS] : ["— בחר קטגוריה —", ...VARIABLE];
        list.forEach((c,i)=>{ const o=document.createElement('option'); o.value=i?c:''; o.textContent=c; sel.appendChild(o);});
        sel.dataset.inited='1';
      });
    }
    function updateCatBadge(){
      const sel = document.getElementById('catSelect'); const badge = document.getElementById('catBadge');
      if(!sel || !badge) return;
      const cat = sel.value;
      badge.classList.toggle('hidden', !cat);
      if(cat){ badge.textContent = `קטגוריה: "${cat}"`; }
    }

    function renderIncomeList(){
      const {incomes} = totals();
      const ul = document.getElementById('incomeList'); ul.innerHTML='';
      incomes.sort((a,b)=> new Date(b.date) - new Date(a.date));
      incomes.forEach(x=>{
        const li=document.createElement('li'); li.className='row flex items-center justify-between gap-2';
        li.innerHTML = `
          <div class="flex flex-col">
            <span class="text-emerald-300">הכנסה • ${esc(x.category||'')}</span>
            <span class="text-slate-500 text-xs">${new Date(x.date).toLocaleDateString('he-IL')}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-extrabold">${ils(x.amount)} · ברוטו ${ils(x.gross||x.amount)}</span>
            <button class="btn btn-ghost text-xs min-h-[36px]" data-edit="${esc(x.id)}" type="button">⋯</button>
          </div>`;
        li.querySelector('[data-edit]')?.addEventListener('click', ()=> openEdit(x.id));
        ul.appendChild(li);
      });
      document.getElementById('grossSum').textContent = ils(totals().gross);
      document.getElementById('netSum').textContent   = ils(totals().net);
    }

    function renderExpensesList(){
      const ul = document.getElementById('expenseList'); ul.innerHTML='';
      const q = (document.getElementById('filterText').value||'').trim().toLowerCase();
      const fcat = document.getElementById('filterCat').value||'';
      const df = document.getElementById('filterFrom').value||'';
      const dt = document.getElementById('filterTo').value||'';
      const sortBy = document.getElementById('sortBy').value||'date_desc';
      const showFixed = document.getElementById('toggleFixedInList')?.checked;

      const {expenses:varExp} = totals();
      const fixedTx = recurringForMonth(ROOT.current).map(r=>({
        id:`rec-${r.id}@${ROOT.current}`,
        date:new Date(ROOT.current+'-01').toISOString(),
        type:'expense',
        amount:r.amount,
        category:r.group,
        merchant:r.label,
        synthetic:true
      }));

      let list = [...varExp, ...(showFixed? fixedTx : [])];
      if(q) list = list.filter(x=> (x.merchant||'').toLowerCase().includes(q) || (x.category||'').toLowerCase().includes(q));
      if(fcat) list = list.filter(x=> x.category===fcat);
      if(df){ const from = new Date(df); list = list.filter(x=> new Date(x.date)>=from); }
      if(dt){ const to = new Date(dt); to.setHours(23,59,59,999); list = list.filter(x=> new Date(x.date)<=to); }

      list.sort((a,b)=>{
        if(sortBy==='date_desc') return new Date(b.date) - new Date(a.date);
        if(sortBy==='date_asc') return new Date(a.date) - new Date(b.date);
        if(sortBy==='amt_desc') return toNumber(b.amount) - toNumber(a.amount);
        if(sortBy==='amt_asc') return toNumber(a.amount) - toNumber(b.amount);
        return 0;
      });

      list.forEach(x=>{
        const li=document.createElement('li'); li.className='row flex items-center justify-between gap-2';
        li.innerHTML = `
          <div class="flex flex-col">
            <span>${esc(x.category)}${x.merchant ? ' • '+esc(x.merchant) : ''} ${x.synthetic? '<span class="badge">קבוע</span>':''}</span>
            <span class="text-slate-500 text-xs">${new Date(x.date).toLocaleDateString('he-IL')}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-extrabold">${ils(x.amount)}</span>
            ${x.synthetic? '<span class="text-slate-600 text-xs">—</span>' : '<button class="btn btn-ghost text-xs min-h-[36px]" data-edit="'+esc(x.id)+'" type="button">⋯</button>'}
          </div>`;
        if(!x.synthetic) li.querySelector('[data-edit]')?.addEventListener('click', ()=> openEdit(x.id));
        ul.appendChild(li);
      });

      document.getElementById('kpiCurExp').textContent = ils(totals().expVar + totals().expFixed);
    }

    function renderFixed(){
      const wrap=document.getElementById('fixedGroupsWrap'); if(!wrap) return; wrap.innerHTML='';
      const groupsMap = {}; for(const g of FIXED_GROUPS) groupsMap[g] = [];
      (ROOT.recurring||[]).forEach(r=>{ if(!groupsMap[r.group]) groupsMap[r.group]=[]; groupsMap[r.group].push(r); });

      for(const g of FIXED_GROUPS){
        const items = groupsMap[g];
        const sec = document.createElement('section');
        sec.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold">${esc(g)}</h4>
            <span class="text-xs text-slate-400">${items.length} רשומות</span>
          </div>
          <ul class="space-y-2"></ul>
        `;
        const ul = sec.querySelector('ul');
        items.forEach(r=>{
          const li = document.createElement('li');
          li.className='row card p-3 flex items-center justify-between';
          const period = `מ-${new Date(r.start).toLocaleDateString('he-IL')}${r.until? ' עד '+new Date(r.until).toLocaleDateString('he-IL'):''}`;
          li.innerHTML = `
            <div>
              <div class="font-medium">${esc(r.label||r.group)}</div>
              <div class="text-xs text-slate-500">${period} • יום חיוב: ${r.payday||1}</div>
            </div>
            <div class="flex items-center gap-2">
              <div class="text-sm">${ils(r.amount)} לחודש</div>
              <button class="btn btn-ghost text-xs" data-edit="${esc(r.id)}" type="button">ערוך</button>
              <button class="btn btn-danger text-xs" data-del="${esc(r.id)}" type="button">מחק</button>
            </div>
          `;
          li.querySelector('[data-edit]')?.addEventListener('click', ()=> editFixedPrefill(r.id));
          li.querySelector('[data-del]')?.addEventListener('click', ()=>{
            const i=ROOT.recurring.findIndex(x=>x.id===r.id);
            if(i>-1){ROOT.recurring.splice(i,1); save(); renderAll(); toast('חיוב קבוע הוסר');}
          });
          ul.appendChild(li);
        });
        wrap.appendChild(sec);
      }
    }

    function renderSavings(){
      // Pensions
      const pTotal = pensionsTotal(ROOT.current);
      document.getElementById('penTotal').textContent = ils(pTotal);
      const pList = document.getElementById('pensionList'); pList.innerHTML='';
      if((ROOT.pensions||[]).length===0){
        pList.innerHTML='<li class="text-slate-400 text-sm">אין חשבונות—הוסיפו למעלה.</li>';
      } else {
        ROOT.pensions.forEach(p=>{
          const bal = accountBalance(p.base,p.monthly,p.baseMonth||ROOT.start,ROOT.current);
          const li=document.createElement('li'); li.className='row card p-3 flex items-center justify-between';
          li.innerHTML=`<div><div class="font-medium">${esc(p.owner)}</div><div class="text-xs text-slate-500">חודש בסיס: ${esc(p.baseMonth||ROOT.start)}</div></div>
                        <div class="text-sm">יתרה: ${ils(bal)} · חודשי: ${ils(p.monthly||0)}</div>`;
          pList.appendChild(li);
        });
      }

      // Savings
      const krList=document.getElementById('krList'); if(krList){
        krList.innerHTML='';
        (ROOT.savings.krans||[]).forEach(k=>{
          const bal=accountBalance(k.base,k.monthly,k.baseMonth||ROOT.start,ROOT.current);
          const li=document.createElement('li');
          li.className='row card p-3 flex items-center justify-between';
          li.innerHTML=`<div class="font-medium">${esc(k.name)}</div><div class="text-sm">יתרה: ${ils(bal)} · חודשי: ${ils(k.monthly||0)}</div>`;
          krList.appendChild(li);
        });
      }
      const depList=document.getElementById('depList'); if(depList){
        depList.innerHTML='';
        (ROOT.savings.deposits||[]).forEach(d=>{
          const bal=accountBalance(d.base,d.monthly,d.baseMonth||ROOT.start,ROOT.current);
          const li=document.createElement('li');
          li.className='row card p-3 flex items-center justify-between';
          li.innerHTML=`<div class="font-medium">${esc(d.name)}</div><div class="text-sm">יתרה: ${ils(bal)} · חודשי: ${ils(d.monthly||0)}</div>`;
          depList.appendChild(li);
        });
      }
      const goalList=document.getElementById('goalList'); if(goalList){
        goalList.innerHTML='';
        (ROOT.savings.goals||[]).forEach(g=>{
          const current = Math.min(toNumber(g.target||Infinity), accountBalance(g.base||0,g.monthly,g.baseMonth||ROOT.start,ROOT.current));
          const pct=Math.min(100, Math.round((toNumber(current)/Math.max(1,toNumber(g.target||0)))*100));
          const li=document.createElement('li');
          li.className='card p-3';
          li.innerHTML=`<div class="flex items-center justify-between mb-1"><div class="font-medium">${esc(g.name)}</div><div class="text-sm">${ils(current)} / ${ils(g.target||0)} · ${pct}%</div></div><div class="progress ${pct>100?'danger':pct>90?'warn':''}"><div style="width:${pct}%"></div></div>`;
          goalList.appendChild(li);
        });
      }
    }

    function renderHeaderAndGauge(){
      const t = totals();
      const budget = budgetFor(ROOT.current);
      const cash   = cashFor(ROOT.current);
      const sav    = savingsTotals(ROOT.current).total;
      const pens   = pensionsTotal(ROOT.current);
      const spent  = t.expVar + t.expFixed;
      const surplus = t.net - spent;

      const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = ils(val); };
      set('kpiBudget', budget);
      set('kpiCurExp', spent);
      set('kpiCash',   cash);
      set('kpiSurplus', surplus);
      set('kpiSavingsSum', sav);
      set('kpiPensionSum', pens);

      document.getElementById('cashNow').textContent = ils(cash);

      const left  = budget - spent;
      const pct   = budget>0 ? spent/budget : 0;
      setGauge(pct, spent, left);
    }

    function renderAll(){
      document.getElementById('currentMonthLabel').textContent = monthLabel(ROOT.current);
      initCategorySelects();
      initCategoryFilters();
      initFixedGroupSelect();
      syncTodayInputs();
      renderHeaderAndGauge();
      renderIncomeList();
      renderExpensesList();
      renderFixed();
      renderSavings();
      // cash collapse state
      document.getElementById('cashBody').style.display = ROOT.ui.cashCollapsed ? 'none' : 'block';
      document.getElementById('cashToggle').textContent = ROOT.ui.cashCollapsed ? '+' : '–';
    }

    /* ========= FORMS / EVENTS ========= */
    function initCategoryFilters(){
      const selFilter = document.getElementById('filterCat');
      if(!selFilter || selFilter.dataset.initedFilter) return;
      ["כל הקטגוריות", ...VARIABLE, ...FIXED_GROUPS].forEach((c,i)=>{
        const o=document.createElement('option'); o.value=i?c:''; o.textContent=c; selFilter.appendChild(o);
      });
      selFilter.dataset.initedFilter='1';
    }
    function initFixedGroupSelect(){
      const sel=document.getElementById('fixGroup'); if(!sel || sel.dataset.inited) return;
      FIXED_GROUPS.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; sel.appendChild(o); });
      sel.dataset.inited='1';
    }

    function syncTodayInputs(){
      const d = new Date(ROOT.current+'-01');
      const dateStr = `${d.getFullYear()}-${pad(d.getMonth()+1)}-01`;
      ['incomeDate','expDate','fixStart'].forEach(id=>{
        const el=document.getElementById(id); if(el) el.value=dateStr;
      });
      document.getElementById('budgetInput').value = '';
      document.getElementById('cashInput').value = '';
    }

    // Tabs
    document.querySelectorAll('.seg [data-view]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const seg = btn.closest('.seg');
        seg.querySelectorAll('button').forEach(b=>{ b.classList.remove('on'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('on'); btn.setAttribute('aria-selected','true');
        const view = btn.getAttribute('data-view');
        document.querySelectorAll('[data-view-panel]').forEach(p=>{
          p.classList.toggle('hidden', p.getAttribute('data-view-panel')!==view);
        });
      });
    });

    // Expenses subtabs
    document.querySelectorAll('#view-expenses .seg [data-subview]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const seg = btn.closest('.seg');
        seg.querySelectorAll('button').forEach(b=>{ b.classList.remove('on'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('on'); btn.setAttribute('aria-selected','true');
        const v=btn.getAttribute('data-subview');
        document.querySelectorAll('#view-expenses [data-subpanel]').forEach(p=>{
          p.classList.toggle('hidden', p.getAttribute('data-subpanel')!==v);
        });
      });
    });

    // Savings subtabs
    document.querySelectorAll('#view-savings .seg [data-subview]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const seg = btn.closest('.seg');
        seg.querySelectorAll('button').forEach(b=>{ b.classList.remove('on'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('on'); btn.setAttribute('aria-selected','true');
        const v=btn.getAttribute('data-subview');
        document.querySelectorAll('#view-savings [data-subpanel]').forEach(p=>{
          p.classList.toggle('hidden', p.getAttribute('data-subpanel')!==v);
        });
      });
    });

    // Month picker
    document.getElementById('btnMonthPicker')?.addEventListener('click', ()=> toggleMP(true));
    document.getElementById('mpClose')?.addEventListener('click', ()=> toggleMP(false));

    // Cash (anchor)
    document.getElementById('cashToggle')?.addEventListener('click', ()=>{
      ROOT.ui.cashCollapsed = !ROOT.ui.cashCollapsed; save(); renderAll();
    });
    document.getElementById('formCash')?.addEventListener('submit', e=>{
      e.preventDefault();
      const v=toNumber(document.getElementById('cashInput').value);
      M().cashAnchor = v;
      save(); renderAll(); toast('יתרת עו״ש עודכנה (עוגן לחישוב קדימה)');
      e.currentTarget.reset();
    });

    // Budget (carry-forward)
    document.getElementById('formBudget')?.addEventListener('submit', e=>{
      e.preventDefault();
      const v=toNumber(document.getElementById('budgetInput').value);
      M().budget = v;
      save(); renderAll(); toast('תקציב חודשי נשמר');
      e.currentTarget.reset();
    });

    // Income add
    document.getElementById('btnAddIncomeInline')?.addEventListener('click', ()=>{
      const f=document.getElementById('formIncomeInline');
      f.classList.toggle('hidden');
      if(!f.classList.contains('hidden')) document.getElementById('incomeNet').focus();
    });
    document.getElementById('formIncomeInline')?.addEventListener('submit', e=>{
      e.preventDefault();
      const f=e.currentTarget;
      const amountNet   = Math.max(0, toNumber(f.querySelector('#incomeNet').value));
      const amountGross = Math.max(0, toNumber(f.querySelector('#incomeGross').value || amountNet));
      const src = String(f.querySelector('#incomeSource').value||'הכנסה').trim().slice(0,60);
      const dt  = f.querySelector('#incomeDate').value ? new Date(f.querySelector('#incomeDate').value) : new Date();
      M().transactions.unshift({ id: uuid(), date: dt.toISOString(), type:'income', amount: amountNet, gross: amountGross, category: src, merchant: src });
      save(); renderAll(); toast('הכנסה נוספה');
      f.reset(); f.classList.add('hidden');
    });

    // Expense add (variable)
    document.getElementById('formExpense')?.addEventListener('submit', e=>{
      e.preventDefault();
      const f=e.currentTarget;
      if(!f.querySelector('#catSelect').value){ toast('בחר קטגוריה'); f.querySelector('#catSelect').focus(); return; }
      if(!f.querySelector('#expAmount').value){ toast('מלא/י סכום'); f.querySelector('#expAmount').focus(); return; }
      const a = Math.max(0, toNumber(f.querySelector('#expAmount').value));
      const cat = String(f.querySelector('#catSelect').value).trim().slice(0,60);
      const mer = String(f.querySelector('#expMerchant').value||'').trim().slice(0,80);
      const dt = f.querySelector('#expDate').value ? new Date(f.querySelector('#expDate').value) : new Date();
      M().transactions.unshift({ id: uuid(), date: dt.toISOString(), type:'expense', amount:a, category:cat, merchant:mer });
      save(); renderAll(); toast('הוצאה נוספה');
      f.reset(); updateCatBadge();
    });

    // Filters
    ['filterText','filterCat','filterFrom','filterTo','sortBy','toggleFixedInList'].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      el.addEventListener('input', renderExpensesList);
      el.addEventListener('change', renderExpensesList);
    });

    // Fixed add/update
    function editFixedPrefill(id){
      const r=ROOT.recurring.find(x=>x.id===id); if(!r) return;
      document.getElementById('fixId').value = r.id;
      document.getElementById('fixGroup').value = r.group;
      document.getElementById('fixLabel').value = r.label || '';
      document.getElementById('fixAmount').value = r.amount;
      document.getElementById('fixStart').value = toInputDate(r.start);
      document.getElementById('fixUntil').value = r.until ? toInputDate(r.until) : '';
      document.getElementById('fixPayday').value = r.payday || 1;
      document.querySelector('#view-expenses .seg [data-subview="exp-fixed"]').click();
      toast('עריכת חיוב קבוע');
    }
    document.getElementById('formFixedAdd')?.addEventListener('submit', e=>{
      e.preventDefault();
      const id = document.getElementById('fixId').value || uuid();
      const group=document.getElementById('fixGroup').value;
      const label=(document.getElementById('fixLabel').value||'').trim();
      const amount=toNumber(document.getElementById('fixAmount').value);
      const start=document.getElementById('fixStart').value || (ROOT.current+'-01');
      const until=document.getElementById('fixUntil').value || null;
      const payday = Number(document.getElementById('fixPayday').value)||1;
      if(!group || !amount){ toast('קבוצה וסכום נדרשים'); return; }
      const exIndex = ROOT.recurring.findIndex(r=>r.id===id);
      const rec = {id, group, label, amount, start:new Date(start).toISOString(), until:until? new Date(until).toISOString():null, payday};
      if(exIndex>-1){ ROOT.recurring[exIndex]=rec; toast('חיוב קבוע עודכן'); }
      else { ROOT.recurring.push(rec); toast('חיוב קבוע נוסף'); }
      save(); renderAll();
      document.getElementById('fixId').value=''; document.getElementById('fixLabel').value=''; document.getElementById('fixAmount').value=''; document.getElementById('fixUntil').value=''; document.getElementById('fixPayday').value='';
    });
    document.getElementById('fixReset')?.addEventListener('click', ()=>{
      document.getElementById('fixId').value=''; document.getElementById('fixLabel').value=''; document.getElementById('fixAmount').value=''; document.getElementById('fixUntil').value=''; document.getElementById('fixPayday').value='';
    });

    // Savings forms
    document.getElementById('formPensionAdd')?.addEventListener('submit', e=>{
      e.preventDefault();
      const owner=(document.getElementById('penOwner').value||'').trim(); if(!owner){ toast('שם נדרש'); return; }
      const base=toNumber(document.getElementById('penBase').value);
      const monthly=toNumber(document.getElementById('penMonthly').value);
      const baseMonth=(document.getElementById('penBaseMonth').value||ROOT.start);
      const ex=ROOT.pensions.find(x=>x.owner===owner);
      if(ex){ ex.base=base; ex.monthly=monthly; ex.baseMonth=baseMonth; toast('עודכן'); }
      else { ROOT.pensions.push({id:uuid(), owner, base, monthly, baseMonth}); toast('נוסף'); }
      save(); renderAll(); e.currentTarget.reset();
    });
    document.getElementById('formKeren')?.addEventListener('submit', e=>{
      e.preventDefault();
      const name=(document.getElementById('krName').value||'').trim(); if(!name){ toast('שם קרן נדרש'); return; }
      const base=toNumber(document.getElementById('krBase').value);
      const monthly=toNumber(document.getElementById('krMonthly').value);
      const baseMonth=(document.getElementById('krBaseMonth').value||ROOT.start);
      const ex=ROOT.savings.krans.find(x=>x.name===name);
      if(ex){ ex.base=base; ex.monthly=monthly; ex.baseMonth=baseMonth; }
      else { ROOT.savings.krans.push({id:uuid(), name, base, monthly, baseMonth}); }
      save(); renderAll(); toast('קרן השתלמות נשמרה'); e.currentTarget.reset();
    });
    document.getElementById('formDeposit')?.addEventListener('submit', e=>{
      e.preventDefault();
      const name=(document.getElementById('depName').value||'').trim(); if(!name){ toast('שם חשבון נדרש'); return; }
      const base=toNumber(document.getElementById('depBase').value);
      const monthly=toNumber(document.getElementById('depMonthly').value);
      const baseMonth=(document.getElementById('depBaseMonth').value||ROOT.start);
      const ex=ROOT.savings.deposits.find(x=>x.name===name);
      if(ex){ ex.base=base; ex.monthly=monthly; ex.baseMonth=baseMonth; }
      else { ROOT.savings.deposits.push({id:uuid(), name, base, monthly, baseMonth}); }
      save(); renderAll(); toast('פיקדון נשמר'); e.currentTarget.reset();
    });
    document.getElementById('formGoal')?.addEventListener('submit', e=>{
      e.preventDefault();
      const name=(document.getElementById('goalName').value||'').trim(); if(!name){ toast('שם מטרה נדרש'); return; }
      const target=toNumber(document.getElementById('goalTarget').value);
      const monthly=toNumber(document.getElementById('goalMonthly').value);
      const baseMonth=(document.getElementById('goalBaseMonth').value||ROOT.start);
      const ex=ROOT.savings.goals.find(x=>x.name===name);
      if(ex){ ex.target=target; ex.monthly=monthly; ex.baseMonth=baseMonth; ex.base=ex.base||0; }
      else { ROOT.savings.goals.push({id:uuid(), name, target, monthly, baseMonth, base:0}); }
      save(); renderAll(); toast('תכנית חיסכון נשמרה'); e.currentTarget.reset();
    });

    // Edit modal (only manual tx)
    function openEdit(id){
      const t = M().transactions.find(x=> x.id===id); if(!t) return;
      document.getElementById('editId').value = t.id;
      document.getElementById('editType').value = t.type;
      document.getElementById('editAmount').value = t.amount;
      document.getElementById('editMerchant').value = t.merchant||'';
      document.getElementById('editCategory').value = t.category||'';
      document.getElementById('editDate').value = toInputDate(t.date);
      toggleModal(true);
    }
    function toggleModal(show){
      const m = document.getElementById('editModal');
      if(show){ m.classList.remove('hidden'); m.classList.add('flex'); }
      else { m.classList.add('hidden'); m.classList.remove('flex'); }
    }
    document.getElementById('editClose')?.addEventListener('click', ()=> toggleModal(false));
    document.getElementById('editCancel')?.addEventListener('click', ()=> toggleModal(false));
    document.getElementById('formEdit')?.addEventListener('submit', e=>{
      e.preventDefault();
      const f=e.currentTarget;
      const id = f.querySelector('#editId').value;
      const t = M().transactions.find(x=> x.id===id); if(!t) return;
      t.type     = f.type.value==='income' ? 'income' : 'expense';
      t.amount   = Math.max(0, toNumber(f.amount.value));
      t.merchant = String(f.merchant.value||'').slice(0,80);
      t.category = String(f.category.value||'').slice(0,60);
      t.date     = new Date(f.date.value||new Date()).toISOString();
      if (t.type==='income' && !t.gross) t.gross = t.amount;
      save(); renderAll(); toast('עודכן'); toggleModal(false);
    });
    document.getElementById('editDelete')?.addEventListener('click', ()=>{
      const id=document.getElementById('editId').value;
      const idx = M().transactions.findIndex(x=> x.id===id);
      if(idx>-1){ M().transactions.splice(idx,1); save(); renderAll(); toast('נמחק'); toggleModal(false); }
    });

    // Quick bar
    document.getElementById('quickAddExpense')?.addEventListener('click', ()=>{
      document.querySelector('.seg [data-view="expenses"]').click();
      document.getElementById('expAmount').focus();
    });
    document.getElementById('quickAddIncome')?.addEventListener('click', ()=>{
      document.querySelector('.seg [data-view="home"]').click();
      const f=document.getElementById('formIncomeInline'); if(f && f.classList.contains('hidden')) f.classList.remove('hidden');
      document.getElementById('incomeNet').focus();
    });
    document.getElementById('quickAddRecurring')?.addEventListener('click', ()=>{
      document.querySelector('.seg [data-view="expenses"]').click();
      document.querySelector('#view-expenses .seg [data-subview="exp-fixed"]').click();
      document.getElementById('fixLabel').focus();
    });

    /* ========= START ========= */
    document.getElementById('btnMonthPicker')?.addEventListener('click', ()=> toggleMP(true));
    renderAll();
  </script>
</body>
</html>
