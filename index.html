<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ארנק חכם – v10 Mobile (iPhone 14)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- ========= Supabase SDK ========= -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ========= Supabase Config (הערכים שנתת) ========= -->
  <script>
    const SUPABASE_URL  = 'https://zxzopuruaccfjfhrjxqg.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4em9wdXJ1YWNjZmpmaHJqeHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzgwMTUsImV4cCI6MjA3MDkxNDAxNX0.Fk80JHLEFe4W1UDGRABnxRqI1roDOv2dNGOLKqmRV5k';
    const HOUSEHOLD_ID  = 'idan-lital'; // מזהה משותף לשני המכשירים
  </script>

  <style>
    :root{
      --card:#111827; /* dark slate-900 */
      --page:linear-gradient(to bottom,#0b1020,#0d1324);
      --ink:#e5e7eb; /* text slate-200 */
      --muted:#94a3b8; /* slate-400 */
      --accent:#10b981; /* emerald-500 */
      --accent-2:#34d399; /* emerald-400 */
      --danger:#ef4444; /* red-500 */
      --warn:#f59e0b; /* amber-500 */
      --radius:16px;
      --tap:44px;
    }
    html{font-size:16px}
    body{
      font-family:'Rubik',ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--page);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:calc(env(safe-area-inset-bottom) + 84px);
    }
    .container{max-width:28rem;margin-inline:auto}
    .card{border-radius:var(--radius);background:var(--card);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .chip{border-radius:9999px;padding:.35rem .6rem;background:#0f172a;color:#a7f3d0;font-weight:600;font-size:.8rem;white-space:nowrap;border:1px solid rgba(16,185,129,.35)}
    .row{min-height:var(--tap); padding:.55rem .75rem; border-radius:12px}
    .row:hover{background:#0f172a}
    .btn{border-radius:12px; font-weight:700; min-height:var(--tap); padding:.625rem .9rem}
    .btn-prim{background:var(--accent);color:#001b12}
    .btn-ghost{background:#0f172a;color:var(--ink);border:1px solid rgba(255,255,255,.06)}
    .btn-danger{background:#7f1d1d;color:#fecaca;border:1px solid rgba(239,68,68,.45)}
    .kpi{background:#0f172a;border-radius:14px;padding:.55 рем .75rem}
    .progress{height:8px;border-radius:999px;background:#1f2937;overflow:hidden}
    .progress > div{height:100%;background:var(--accent)}
    .progress.warn > div{background:var(--warn)}
    .progress.danger > div{background:var(--danger)}
    *{touch-action:manipulation}
    :focus-visible{outline:3px solid var(--accent-2); outline-offset:2px}
    ::placeholder{color:#64748b}
    .seg{background:#0f172a;padding:4px;border-radius:12px;display:flex;gap:4px;border:1px solid rgba(255,255,255,.06)}
    .seg button{flex:1;border-radius:10px;padding:.5rem .75rem;font-weight:700;color:var(--muted);font-size:.9rem}
    .seg .on{background:var(--card);color:#a7f3d0;box-shadow:0 1px 2px rgba(0,0,0,.25);border:1px solid rgba(16,185,129,.35)}
    .months::-webkit-scrollbar{display:none}
    .months{scrollbar-width:none}
    .input{border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0f172a;color:var(--ink);padding:.75rem .85rem}
    .label{color:var(--muted);font-size:.8rem}
  </style>
</head>
<body>
  <main class="container p-3 space-y-4">
    <!-- APP NAME BOX -->
    <section class="card p-4" aria-label="שם אפליקציה">
      <div class="flex items-center justify-between">
        <h1 class="text-[clamp(1rem,3.6vw,1.2rem)] font-bold tracking-tight">ארנק חכם</h1>
        <button id="btnMonthPicker" class="chip text-xs" title="בחר חודש" type="button">בחר חודש ▾</button>
      </div>
      <!-- Row of month chips -->
      <div class="months flex gap-2 overflow-x-auto mt-3">
        <div id="monthsWrap" class="flex gap-2 w-full"></div>
      </div>
      <div id="currentMonthLabel" class="text-[.72rem] text-slate-400 mt-2"></div>
    </section>

    <!-- MAIN TABS -->
    <nav class="seg card p-1" role="tablist" aria-label="ניווט">
      <button class="on" role="tab" aria-selected="true" aria-controls="view-home" data-view="home" type="button">ניהול מעקב</button>
      <button role="tab" aria-selected="false" aria-controls="view-expenses" data-view="expenses" type="button">הוצאות</button>
      <button role="tab" aria-selected="false" aria-controls="view-savings" data-view="savings" type="button">חיסכון</button>
    </nav>

    <!-- VIEW: HOME -->
    <section id="view-home" class="space-y-4" data-view-panel="home">
      <!-- Budget at top -->
      <section class="card p-4" role="region" aria-labelledby="sec-budget2">
        <h3 id="sec-budget2" class="text-[.95rem] font-semibold mb-2">תקציב כללי</h3>
        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-400">תקציב חודשי</div>
          <div id="totalBudget" class="text-xl font-semibold">₪0</div>
        </div>
        <form id="formTotalBudget" class="mt-3 space-y-2">
          <div class="flex gap-2">
            <input name="amount" id="totalBudgetInput" class="input w-full text-base text-right" placeholder="לדוגמה: 12000" inputmode="decimal" />
            <button class="btn btn-prim">שמור</button>
          </div>
        </form>

        <!-- ===== NEW: עובר ושב (מופיע רק כשאין תקציב) ===== -->
        <div id="overdraftRow" class="mt-3 flex items-center justify-between">
          <span class="text-slate-400 text-sm">עובר ושב</span>
          <span id="overdraftVal" class="font-semibold">₪0</span>
        </div>
        <!-- ===== END NEW ===== -->
      </section>

      <!-- KPIs -->
      <header class="card p-4 flex flex-col gap-3" role="banner">
        <div class="grid grid-cols-2 gap-2 text-[.9rem]" role="group" aria-label="מדדים חודשיים">
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">הוצאות</span><b id="kpiCurExp">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">תקציב</span><b id="kpiBudget">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">נטו</span><b id="kpiNet">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">עודף חודשי</span><b id="kpiSavings">₪0</b></div>
        </div>
      </header>

      <!-- Gauge -->
      <section class="grid grid-cols-1 gap-4">
        <div class="card p-4" role="region" aria-label="ניצול חודשי">
          <!-- ===== NEW: כפתור עובר ושב (נראה רק כשיש תקציב) ===== -->
          <button id="btnOverdraft" class="hidden chip text-xs mb-2" type="button">עובר ושב ▾</button>
          <!-- ===== END NEW ===== -->

          <div class="flex items-center justify-between mb-2">
            <span class="chip text-[.7rem]">ניצול חודשי</span>
            <span id="gaugePctText" class="text-xs font-bold">0%</span>
          </div>
          <div class="relative w-full" style="aspect-ratio:2/1" aria-hidden="true">
            <svg id="gsvg" class="absolute inset-0" viewBox="0 0 100 60" preserveAspectRatio="xMidYMid meet">
              <path id="gTrack" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="#1f2937" stroke-width="12" stroke-linecap="round"/>
              <path id="gValue" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999"/>
              <text id="centerPct" x="50" y="42" text-anchor="middle" style="font-size:14px;fill:#e5e7eb;font-weight:800">0%</text>
            </svg>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-2 text-[.8rem]">
            <div class="bg-[#0f172a] rounded-lg p-2">הוצא עד כה: <b id="spentLabel">₪0</b></div>
            <div class="bg-[#0f172a] rounded-lg p-2 text-right">נותר/חריגה: <b id="leftLabel">₪0</b></div>
          </div>
        </div>
      </section>

      <!-- Incomes -->
      <div class="grid grid-cols-1 gap-4">
        <div class="card p-4" role="region" aria-labelledby="sec-income">
          <div class="flex items-center justify-between mb-3">
            <h3 id="sec-income" class="text-[.95rem] font-semibold">הכנסות</h3>
            <button id="btnAddIncomeInline" type="button" class="btn btn-prim text-xs">+ מקור</button>
          </div>
          <div class="flex items-center justify-between mb-2 text-[.9rem]">
            <div class="space-y-1">
              <div class="text-xs text-slate-400">ברוטו</div>
              <div id="grossSum" class="text-lg font-semibold">₪0</div>
            </div>
            <div class="space-y-1 text-right">
              <div class="text-xs text-slate-400">נטו</div>
              <div id="netSum" class="text-lg font-semibold">₪0</div>
            </div>
          </div>
          <form id="formIncomeInline" class="hidden space-y-2 mb-3" role="form">
            <input id="incomeNet" class="input w-full text-right" placeholder="נטו" inputmode="decimal" />
            <input id="incomeGross" class="input w-full text-right" placeholder="ברוטו (אופציונלי)" inputmode="decimal" />
            <input id="incomeSource" class="input w-full" placeholder="מקור (שכר/פרילנס...)" />
            <input type="date" id="incomeDate" class="input w-full" />
            <button class="btn btn-prim w-full">הוסף הכנסה</button>
          </form>
          <ul id="incomeList" class="text-[.9rem] space-y-1 max-h-40 overflow-auto" role="list"></ul>
        </div>
      </div>
    </section>

    <!-- VIEW: EXPENSES -->
    <section id="view-expenses" class="space-y-4 hidden" data-view-panel="expenses">
      <div class="seg card p-1" role="tablist" aria-label="סוג הוצאות">
        <button class="on" data-subview="exp-var" aria-selected="true" type="button">משתנות</button>
        <button data-subview="exp-fixed" aria-selected="false" type="button">קבועות</button>
      </div>

      <!-- Variable -->
      <div id="exp-var" class="space-y-3" data-subpanel="exp-var">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-[.95rem] font-semibold">הוצאות</h3>
            <div id="catBadge" class="chip hidden text-[.7rem]" aria-live="polite"></div>
          </div>
          <form id="formExpense" class="grid grid-cols-1 gap-3 mb-3" role="form">
            <input id="expAmount" class="input text-right" placeholder="סכום (למשל 129.9)" inputmode="decimal" required />
            <input id="expMerchant" class="input" placeholder="ספק/תיאור" />
            <select id="catSelect" class="input" required></select>
            <input type="date" id="expDate" class="input" />
            <button class="btn btn-prim">הוסף הוצאה</button>
          </form>
          <div class="rounded-xl p-3 mb-3 grid grid-cols-1 gap-2 bg-[#0f172a]" role="group" aria-label="מסננים">
            <input id="filterText" class="input" placeholder="חיפוש ספק/תיאור" aria-label="חיפוש" />
            <select id="filterCat" class="input" aria-label="סינון לפי קטגוריה"></select>
            <div class="grid grid-cols-2 gap-2">
              <input type="date" id="filterFrom" class="input" aria-label="מתאריך" />
              <input type="date" id="filterTo" class="input" aria-label="עד תאריך" />
            </div>
            <select id="sortBy" class="input" aria-label="מיון">
              <option value="date_desc">מיין: תאריך ↓</option>
              <option value="date_asc">מיין: תאריך ↑</option>
              <option value="amt_desc">מיין: סכום ↓</option>
              <option value="amt_asc">מיין: סכום ↑</option>
            </select>
          </div>
          <ul id="expenseList" class="text-[.92rem] space-y-1 max-h-[60vh] overflow-auto mt-1" role="list" aria-live="polite"></ul>
        </div>
      </div>

      <!-- Fixed -->
      <div id="exp-fixed" class="space-y-3 hidden" data-subpanel="exp-fixed">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">הוצאות קבועות חודשיות</h3>
          <form id="formFixedAdd" class="grid grid-cols-2 gap-2 mb-3">
            <select id="fixName" class="input">
              <option>שכירות</option><option>ארנונה</option><option>ועד בית</option>
              <option>חנייה</option><option>אינטרנט</option><option>חשמל</option>
              <option>מים</option><option>סלולרי</option><option>אחר</option>
            </select>
            <input id="fixAmount" class="input text-right" placeholder="סכום" inputmode="decimal" />
            <input type="date" id="fixStart" class="input" placeholder="מתאריך" />
            <input type="date" id="fixUntil" class="input" placeholder="עד תאריך (אופציונלי)" />
            <button class="btn btn-prim col-span-2" type="submit">הוסף/עדכן</button>
          </form>
          <ul id="fixedList" class="space-y-2"></ul>
        </div>
      </div>
    </section>

    <!-- VIEW: SAVINGS -->
    <section id="view-savings" class="space-y-4 hidden" data-view-panel="savings">
      <div class="seg card p-1" role="tablist" aria-label="חיסכון – סוגים">
        <button class="on" data-subview="sav-pension" aria-selected="true" type="button">פנסיה</button>
        <button data-subview="sav-kran" aria-selected="false" type="button">קרן השתלמות</button>
        <button data-subview="sav-deposit" aria-selected="false" type="button">פיקדון כללי</button>
        <button data-subview="sav-goal" aria-selected="false" type="button">תוכנית חיסכון</button>
      </div>

      <div id="sav-pension" data-subpanel="sav-pension" class="space-y-3">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">פנסיה</h3>
          <form id="formPensionAdd" class="grid grid-cols-2 gap-2 mb-2">
            <input id="penOwner" class="input col-span-2" placeholder="בעל/ת החשבון" />
            <input id="penBalance" class="input text-right" inputmode="decimal" placeholder="יתרה חד-פעמית" />
            <input id="penMonthly" class="input text-right" inputmode="decimal" placeholder="הכנסה חודשית" />
            <button class="btn btn-prim col-span-2">הוסף/עדכן</button>
          </form>
          <div class="kpi flex items-center justify-between"><span>סה״כ פנסיה</span><b id="penTotal">₪0</b></div>
          <ul id="pensionList" class="text-sm space-y-2 mt-2 max-h-48 overflow-auto"></ul>
        </div>
      </div>

      <div id="sav-kran" data-subpanel="sav-kran" class="space-y-3 hidden">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">קרן השתלמות</h3>
          <form id="formKeren" class="grid grid-cols-2 gap-2 mb-2">
            <input id="krName" class="input col-span-2" placeholder="שם הקרן" />
            <input id="krBalance" class="input text-right" inputmode="decimal" placeholder="יתרה התחלתית (אוג׳ 2025)" />
            <input id="krMonthly" class="input text-right" inputmode="decimal" placeholder="הפקדה חודשית" />
            <button class="btn btn-prim col-span-2">שמור</button>
          </form>
          <ul id="krList" class="space-y-2"></ul>
        </div>
      </div>

      <div id="sav-deposit" data-subpanel="sav-deposit" class="space-y-3 hidden">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">פיקדון כללי / קרן כספית</h3>
          <form id="formDeposit" class="grid grid-cols-2 gap-2 mb-2">
            <input id="depName" class="input col-span-2" placeholder="שם החשבון" />
            <input id="depBalance" class="input text-right" inputmode="decimal" placeholder="יתרה התחלתית (אוג׳ 2025)" />
            <input id="depAdd" class="input text-right" inputmode="decimal" placeholder="הפקדה חודשית" />
            <button class="btn btn-prim col-span-2">שמור</button>
          </form>
          <ul id="depList" class="space-y-2"></ul>
        </div>
      </div>

      <div id="sav-goal" data-subpanel="sav-goal" class="space-y-3 hidden">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">תכנית חיסכון ייעודית</h3>
        <form id="formGoal" class="grid grid-cols-2 gap-2 mb-2">
            <input id="goalName" class="input col-span-2" placeholder="מטרה (חופשה/ירח דבש/הוצאה מסוימת)" />
            <input id="goalTarget" class="input text-right" inputmode="decimal" placeholder="יעד ₪" />
            <input id="goalMonthly" class="input text-right" inputmode="decimal" placeholder="הפקדה חודשית" />
            <button class="btn btn-prim col-span-2">שמור</button>
          </form>
          <ul id="goalList" class="space-y-2"></ul>
        </div>
      </div>
    </section>

    <footer class="text-center text-[.7rem] text-slate-500 py-14" role="contentinfo">
      v10 • מובייל (iPhone 14) • כל חודש נשמר בנפרד • RTL • Dark
    </footer>
  </main>

  <!-- Sticky Quick Bar -->
  <nav class="fixed inset-x-0 bottom-0 bg-[#0f172a]/95 backdrop-blur border-t border-slate-800 p-3 z-30" role="navigation" aria-label="פעולות מהירות">
    <div class="container flex items-center justify-around gap-2">
      <button id="quickAddExpense" class="btn btn-prim text-sm w-full" type="button">+ הוצאה</button>
      <button id="quickAddIncome" class="btn btn-ghost text-sm w-full" type="button">+ הכנסה</button>
      <button id="quickAddRecurring" class="btn btn-ghost text-sm w-full" type="button">+ חיוב ↻</button>
    </div>
  </nav>

  <!-- Toasts -->
  <div id="toastWrap" class="fixed bottom-[92px] right-4 flex flex-col gap-2 z-40" aria-live="polite" aria-atomic="true"></div>

  <!-- Edit Modal -->
  <div id="editModal" class="hidden fixed inset-0 z-40 items-end md:items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative card w-full md:w-[520px] p-5 m-0 md:mx-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 id="editTitle" class="text-base font-semibold">עריכת רשומה</h3>
        <button id="editClose" class="min-h-[44px] min-w-[44px] text-slate-300 hover:text-white" aria-label="סגור" type="button">✕</button>
      </div>
      <form id="formEdit" class="grid grid-cols-2 gap-2" role="form">
        <input type="hidden" name="id" id="editId" />
        <label class="label" for="editType">סוג</label>
        <select name="type" id="editType" class="input">
          <option value="expense">הוצאה</option>
          <option value="income">הכנסה</option>
        </select>
        <label class="label" for="editAmount">סכום</label>
        <input name="amount" id="editAmount" class="input text-right" inputmode="decimal" />
        <label class="label" for="editMerchant">ספק/תיאור</label>
        <input name="merchant" id="editMerchant" class="input" />
        <label class="label" for="editCategory">קטגוריה</label>
        <select name="category" id="editCategory" class="input"></select>
        <label class="label" for="editDate">תאריך</label>
        <input type="date" name="date" id="editDate" class="input" />
        <div class="col-span-2 flex justify-between mt-2">
          <button id="editDelete" type="button" class="btn btn-danger">מחק</button>
          <div class="flex gap-2">
            <button type="button" id="editCancel" class="btn btn-ghost">בטל</button>
            <button class="btn btn-prim">שמור</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Month Picker Modal -->
  <div id="monthPicker" class="hidden fixed inset-0 z-40 items-end md:items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="mpTitle">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative card w-full md:w-[520px] p-5 m-0 md:mx-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 id="mpTitle" class="text-base font-semibold">בחירת חודש</h3>
        <button id="mpClose" class="min-h-[44px] min-w-[44px] text-slate-300 hover:text-white" aria-label="סגור" type="button">✕</button>
      </div>
      <div id="mpGrid" class="grid grid-cols-3 gap-2"></div>
    </div>
  </div>

  <script>
    /* ========= חיבור ל-Supabase בתוך הסקריפט הראשי ========= */
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    /* ========= UTIL ========= */
    const ILS = new Intl.NumberFormat('he-IL',{ style:'currency', currency:'ILS', minimumFractionDigits:0, maximumFractionDigits:0 });
    const ils = n => ILS.format(Math.round(Number(n||0)));
    const pad = n => String(n).padStart(2,'0');
    const ym = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
    const toInputDate = iso => { const d=new Date(iso); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    const toNumber = v => { if (v==null) return 0; const s=String(v).replace(/[₪,\s]/g,''); const n=Number(s); return Number.isFinite(n)?n:0; };
    const uuid = () => (crypto?.randomUUID?.() || 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);} ));
    const esc = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

    function toast(msg){
      const wrap=document.getElementById('toastWrap');
      const t=document.createElement('div');
      t.className='card p-3 text-sm flex items-center gap-3';
      t.textContent=msg; wrap.appendChild(t);
      setTimeout(()=>{t.remove();},3000);
    }

    /* ========= CATEGORIES ========= */
    const FIXED = ["שכירות","ארנונה","ועד בית","אינטרנט","חשמל","מים","סלולרי","ביטוחים","רכב – ביטוח/טסט/דלק","חנייה","מנויים","חינוך/גן","אחר"];
    const VARIABLE = ["מזון","מסעדות/בילויים/חיי לילה","קניות/אופנה","פארם/טיפוח","שונות","מתנות","תחבורה ציבורית/מוניות","נסיעות/טיסות","תחזוקת בית","בריאות/תרופות"];
    const CATEGORIES = [...new Set([ ...FIXED, ...VARIABLE ])];

    /* ========= STORAGE (הקיים – נשאר) ========= */
    const ROOT_KEY = 'smartwallet_v10_root';
    function defaultMonthState(){
      return {
        totalBudget: 0,
        overdraft: 0,          // ===== NEW: עובר ושב פר חודש =====
        transactions: [],      // {id,date,type:'income'|'expense',amount,gross?,category,merchant}
        pensions: [],          // {id,owner,balance,monthly,lastUpdate}
        recurring: [],         // {id,name,amount,start,until}
        savings:{ krans:[], deposits:[], goals:[] }
      };
    }
    function loadRoot(){ try{ return JSON.parse(localStorage.getItem(ROOT_KEY)) || {}; } catch{ return {}; } }
    function saveRoot(){ localStorage.setItem(ROOT_KEY, JSON.stringify(ROOT)); }

    // ===== NEW: עזרי חודשים לחישוב גלגול עובר-ושב =====
    function prevMonthKey(key){
      const [y,m] = key.split('-').map(Number);
      const d = new Date(y, m-2, 1);
      return ym(d);
    }
    function isSameMonth(iso, key=ROOT.current){
      const d=new Date(iso); const [y,m]=key.split('-').map(Number);
      return d.getFullYear()===y && (d.getMonth()+1)===m;
    }
    function monthlyTotalsFor(key){
      const state = ROOT.months[key] || defaultMonthState();
      // totals per selected month
      let net=0, gross=0, exp=0;
      for(const t of state.transactions||[]){
        if(!isSameMonth(t.date, key)) continue;
        if(t.type==='income'){ net += toNumber(t.amount); gross += toNumber(t.gross || t.amount); }
        else { exp += toNumber(t.amount); }
      }
      // fixed this month
      const d = new Date(key+'-01');
      const fixed = (state.recurring||[]).filter(r=>{
        const s=new Date(r.start); const u=r.until? new Date(r.until):null;
        return s <= d && (!u || u >= d);
      }).reduce((s,r)=> s + toNumber(r.amount||0), 0);
      return { net, gross, exp, fixed, surplus: net - (exp + fixed) };
    }

    function ensureMonth(key){
      if(!ROOT.months[key]){
        ROOT.months[key] = defaultMonthState();
        // ===== NEW: גלגול עובר ושב מחודש קודם + העודף שהוצג בו =====
        const pk = prevMonthKey(key);
        const prev = ROOT.months[pk];
        if (prev){
          const { surplus } = monthlyTotalsFor(pk);
          ROOT.months[key].overdraft = toNumber(prev.overdraft||0) + surplus;
        }
      }
    }
    function S(){ return ROOT.months[ROOT.current]; }

    /* Initialize starting at Aug 2025 */
    let ROOT = loadRoot();
    if(!ROOT.months) ROOT.months = {};
    if(!ROOT.current) ROOT.current = '2025-08';
    ensureMonth(ROOT.current); saveRoot();

    /* ========= CLOUD SYNC ADDON (תוספת – לא מוחק לוקאלי) ========= */
    async function loadRootFromCloud() {
      try {
        const { data, error } = await sb
          .from('wallet')
          .select('data')
          .eq('household', HOUSEHOLD_ID)
          .maybeSingle();
        if (error) { console.warn('[cloud] load error:', error); return null; }
        return data?.data || null;
      } catch (e) { console.warn('[cloud] load exception:', e); return null; }
    }

    let __cloudSaveTimer = null;
    async function saveRootToCloudNow() {
      try {
        const { error } = await sb.from('wallet').upsert({ household: HOUSEHOLD_ID, data: ROOT });
        if (error) console.warn('[cloud] save error:', error);
      } catch (e) { console.warn('[cloud] save exception:', e); }
    }
    function saveRootToCloud() {
      if (__cloudSaveTimer) clearTimeout(__cloudSaveTimer);
      __cloudSaveTimer = setTimeout(saveRootToCloudNow, 300);
    }
    const __origSaveRoot = saveRoot;
    saveRoot = function () {
      __origSaveRoot();
      saveRootToCloud();
    };

    (async function initCloudSync(){
      const cloud = await loadRootFromCloud();
      if (cloud && typeof cloud === 'object' && Object.keys(cloud).length) {
        ROOT = cloud;
        if(!ROOT.months) ROOT.months = {};
        if(!ROOT.current) ROOT.current = '2025-08';
        ensureMonth(ROOT.current);
        try { renderAll && renderAll(); } catch {}
      } else {
        // אין בענן – נעלה את המקומי
        await saveRootToCloudNow();
      }
      try {
        const { data, error } = await sb.from('wallet').select('household').eq('household', HOUSEHOLD_ID).maybeSingle();
        if (error) console.warn('Supabase check error:', error);
        else console.log('Supabase ready for household:', data?.household || HOUSEHOLD_ID);
      } catch {}
    })();

    /* ========= MONTH UI ========= */
    function monthLabel(key){ const d=new Date(key+'-01'); return d.toLocaleDateString('he-IL',{month:'long',year:'numeric'}); }
    function buildMonthStrip(){
      const WR = document.getElementById('monthsWrap'); WR.innerHTML='';
      const start = new Date(2025,7,1); // Aug=7
      const now = new Date();
      const end = new Date(now.getFullYear(), now.getMonth()+11, 1);
      for(let d=new Date(start); d<=end; d.setMonth(d.getMonth()+1)){
        const key = ym(d);
        ensureMonth(key);
        const btn=document.createElement('button');
        btn.type='button';
        btn.className = 'chip ' + (key===ROOT.current? 'bg-emerald-900 text-emerald-200' : '');
        btn.textContent = d.toLocaleDateString('he-IL',{month:'short', year:'2-digit'});
        btn.setAttribute('data-key', key);
        btn.addEventListener('click', ()=>{ ROOT.current=key; ensureMonth(key); saveRoot(); syncTodayInputs(); renderAll(); highlightMonthChip(); });
        WR.appendChild(btn);
      }
      highlightMonthChip();
    }
    function highlightMonthChip(){
      document.querySelectorAll('#monthsWrap .chip').forEach(chip=>{
        chip.classList.remove('bg-emerald-900','text-emerald-200');
        if(chip.getAttribute('data-key')===ROOT.current){ chip.classList.add('bg-emerald-900','text-emerald-200'); }
      });
      document.getElementById('currentMonthLabel').textContent = monthLabel(ROOT.current);
    }

    function openMonthPicker(){
      const grid = document.getElementById('mpGrid');
      grid.innerHTML='';
      const start = new Date(2025,7,1);
      const end = new Date(new Date().getFullYear(), new Date().getMonth()+11, 1);
      for(let d=new Date(start); d<=end; d.setMonth(d.getMonth()+1)){
        const key=ym(d);
        const b=document.createElement('button');
        b.type='button';
        b.className='btn btn-ghost';
        b.textContent=d.toLocaleDateString('he-IL',{month:'long',year:'2-digit'});
        b.addEventListener('click',()=>{ ROOT.current=key; ensureMonth(key); saveRoot(); renderAll(); toggleMP(false); });
        grid.appendChild(b);
      }
      toggleMP(true);
    }
    function toggleMP(show){
      const m=document.getElementById('monthPicker');
      if(show){m.classList.remove('hidden'); m.classList.add('flex');}
      else {m.classList.add('hidden'); m.classList.remove('flex');}
    }

    /* ========= HELPERS ========= */
    // isSameMonth הועבר למעלה לשימושים כלליים

    /* ========= GAUGE ========= */
    const gaugeColor = (p) => p<=0.75? 'var(--accent)' : p<=0.9? 'var(--warn)' : p<=1.0? '#f97316' : 'var(--danger)';
    function setGauge(p, spent, left){
      const clamped = Math.max(0, Math.min(1.2, Number.isFinite(p)? p : 0));
      const path = document.getElementById('gValue');
      const len = path.getTotalLength ? path.getTotalLength() : 125.6;
      const draw = Math.min(len, len * Math.min(1, clamped));
      path.setAttribute('stroke-dasharray', `${draw} 999`);
      path.setAttribute('stroke', gaugeColor(clamped));
      const pct = Math.round((clamped||0)*100);
      document.getElementById('gaugePctText').textContent = pct+'%';
      document.getElementById('centerPct').textContent = pct+'%';
      document.getElementById('spentLabel').textContent = ils(spent);
      const leftEl = document.getElementById('leftLabel');
      leftEl.textContent = ils(left);
      leftEl.className = (left < 0 ? 'text-red-400 ' : '') + 'font-semibold';
    }

    /* ========= TOTALS ========= */
    function totals(){
      let net=0, gross=0, exp=0; const incomes=[], expenses=[];
      for(const t of S().transactions){
        if(!isSameMonth(t.date)) continue;
        if(t.type==='income'){ net += toNumber(t.amount); gross += toNumber(t.gross || t.amount); incomes.push(t); }
        else { exp += toNumber(t.amount); expenses.push(t); }
      }
      return {net,gross,exp,incomes,expenses};
    }

    /* ========= RENDER ========= */
    function initCategorySelects(){
      const selAdd = document.getElementById('catSelect');
      const selEdit = document.getElementById('editCategory');
      const selFilter = document.getElementById('filterCat');
      [selAdd, selEdit, selFilter].forEach((sel)=>{
        if(!sel || sel.dataset.inited) return;
        const list = sel===selFilter ? ["כל הקטגוריות", ...VARIABLE] : ["— בחר קטגוריה —", ...VARIABLE];
        list.forEach((c,i)=>{ const o=document.createElement('option'); o.value=i?c:''; o.textContent=c; sel.appendChild(o);});
        sel.dataset.inited='1';
      });
    }
    function updateCatBadge(){
      const sel = document.getElementById('catSelect'); const badge = document.getElementById('catBadge');
      if(!sel || !badge) return;
      const cat = sel.value;
      badge.classList.toggle('hidden', !cat);
      if(cat){ badge.textContent = `קטגוריה: "${cat}"`; }
    }

    function renderIncomeList(){
      const {incomes} = totals();
      const ul = document.getElementById('incomeList'); ul.innerHTML='';
      incomes.sort((a,b)=> new Date(b.date) - new Date(a.date));
      incomes.forEach(x=>{
        const li=document.createElement('li'); li.className='row flex items-center justify-between gap-2';
        li.innerHTML = `
          <div class="flex flex-col">
            <span class="text-emerald-300">הכנסה • ${esc(x.category||'')}</span>
            <span class="text-slate-400 text-xs">${new Date(x.date).toLocaleDateString('he-IL')}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-semibold">${ils(x.amount)} · ברוטו ${ils(x.gross||x.amount)}</span>
            <button class="btn btn-ghost text-xs min-h-[36px]" data-edit="${esc(x.id)}" type="button">⋯</button>
          </div>`;
        li.querySelector('[data-edit]')?.addEventListener('click', ()=> openEdit(x.id));
        ul.appendChild(li);
      });
      document.getElementById('grossSum').textContent = ils(totals().gross);
      document.getElementById('netSum').textContent   = ils(totals().net);
    }

    function renderPensions(){
      const list = document.getElementById('pensionList'); if(!list) return; list.innerHTML='';
      const total = S().pensions.reduce((s,p)=> s + toNumber(p.balance||0), 0);
      const totalEl = document.getElementById('penTotal'); if(totalEl) totalEl.textContent = ils(total);
      if(S().pensions.length===0){
        const li=document.createElement('li'); li.className='text-slate-400 text-sm'; li.textContent='אין חשבונות פנסיה—הוסף/י למעלה.'; list.appendChild(li);
      } else {
        S().pensions.forEach(p=>{
          const li=document.createElement('li'); li.className='row card p-3 flex items-center justify-between';
          li.innerHTML=`
            <div>
              <div class="font-medium">${esc(p.owner)}</div>
              <div class="text-xs text-slate-500">עודכן: ${new Date(p.lastUpdate).toLocaleDateString('he-IL')}</div>
            </div>
            <div class="flex items-center gap-4">
              <div class="text-sm">יתרה: ${ils(p.balance)}</div>
              <div class="text-sm">הכנסה חודשית: ${ils(p.monthly)}</div>
              <button class="btn btn-danger text-xs" data-del="${esc(p.id)}" type="button">מחק</button>
            </div>`;
          li.querySelector('[data-del]')?.addEventListener('click', ()=> deletePension(p.id));
          list.appendChild(li);
        });
      }
    }

    function renderExpensesList(){
      const ul = document.getElementById('expenseList'); ul.innerHTML='';
      const q = (document.getElementById('filterText').value||'').trim().toLowerCase();
      const fcat = document.getElementById('filterCat').value||'';
      const df = document.getElementById('filterFrom').value||'';
      const dt = document.getElementById('filterTo').value||'';
      const sortBy = document.getElementById('sortBy').value||'date_desc';

      let list = S().transactions.filter(x=> x.type==='expense' && isSameMonth(x.date));
      if(q) list = list.filter(x=> (x.merchant||'').toLowerCase().includes(q) || (x.category||'').toLowerCase().includes(q));
      if(fcat) list = list.filter(x=> x.category===fcat);
      if(df){ const from = new Date(df); list = list.filter(x=> new Date(x.date)>=from); }
      if(dt){ const to = new Date(dt); to.setHours(23,59,59,999); list = list.filter(x=> new Date(x.date)<=to); }

      list.sort((a,b)=>{
        if(sortBy==='date_desc') return new Date(b.date) - new Date(a.date);
        if(sortBy==='date_asc') return new Date(a.date) - new Date(b.date);
        if(sortBy==='amt_desc') return toNumber(b.amount) - toNumber(a.amount);
        if(sortBy==='amt_asc') return toNumber(a.amount) - toNumber(b.amount);
        return 0;
      });

      list.forEach(x=>{
        const li=document.createElement('li'); li.className='row flex items-center justify-between gap-2';
        li.innerHTML = `
          <div class="flex flex-col">
            <span>${esc(x.category)}${x.merchant ? ' • '+esc(x.merchant) : ''}</span>
            <span class="text-slate-400 text-xs">${new Date(x.date).toLocaleDateString('he-IL')}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-semibold">${ils(x.amount)}</span>
            <button class="btn btn-ghost text-xs min-h-[36px]" data-edit="${esc(x.id)}" type="button">⋯</button>
          </div>`;
        li.querySelector('[data-edit]')?.addEventListener('click', ()=> openEdit(x.id));
        ul.appendChild(li);
      });

      document.getElementById('kpiCurExp').textContent = ils(totals().exp);
    }

    function renderFixed(){
      const ul=document.getElementById('fixedList'); if(!ul) return; ul.innerHTML='';
      S().recurring.forEach(r=>{
        const li=document.createElement('li'); li.className='row card p-3 flex items-center justify-between';
        li.innerHTML=`
          <div>
            <div class="font-medium">${esc(r.name)}</div>
            <div class="text-xs text-slate-500">מ-${new Date(r.start).toLocaleDateString('he-IL')}${r.until? ' עד '+new Date(r.until).toLocaleDateString('he-IL'):''}</div>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-sm">${ils(r.amount)} לחודש</div>
            <button class="btn btn-danger text-xs" data-del="${esc(r.id)}" type="button">מחק</button>
          </div>`;
        li.querySelector('[data-del]')?.addEventListener('click',()=>{
          const i=S().recurring.findIndex(x=>x.id===r.id);
          if(i>-1){S().recurring.splice(i,1); saveRoot(); renderAll();}
        });
        ul.appendChild(li);
      });
    }

    function renderSavings(){
      const krList=document.getElementById('krList');
      if(krList){
        krList.innerHTML='';
        S().savings.krans.forEach(k=>{
          const li=document.createElement('li');
          li.className='row card p-3 flex items-center justify-between';
          li.innerHTML=`<div class="font-medium">${esc(k.name)}</div><div class="text-sm">יתרה: ${ils(k.balance)} · חודשי: ${ils(k.monthly)}</div>`;
          krList.appendChild(li);
        });
      }
      const depList=document.getElementById('depList');
      if(depList){
        depList.innerHTML='';
        S().savings.deposits.forEach(d=>{
          const li=document.createElement('li');
          li.className='row card p-3 flex items-center justify-between';
          li.innerHTML=`<div class="font-medium">${esc(d.name)}</div><div class="text-sm">יתרה: ${ils(d.balance)} · חודשי: ${ils(d.monthly)}</div>`;
          depList.appendChild(li);
        });
      }
      const goalList=document.getElementById('goalList');
      if(goalList){
        goalList.innerHTML='';
        S().savings.goals.forEach(g=>{
          const pct=Math.min(100, Math.round((toNumber(g.balance||0)/Math.max(1,toNumber(g.target||0)))*100));
          const li=document.createElement('li');
          li.className='card p-3';
          li.innerHTML=`<div class="flex items-center justify-between mb-1"><div class="font-medium">${esc(g.name)}</div><div class="text-sm">${ils(g.balance||0)} / ${ils(g.target||0)} · ${pct}%</div></div><div class="progress"><div style="width:${pct}%"></div></div>`;
          goalList.appendChild(li);
        });
      }
    }

    function renderHeaderAndGauge(){
      const t = totals();
      document.getElementById('kpiBudget').textContent = ils(S().totalBudget);
      document.getElementById('kpiNet').textContent    = ils(t.net);
      document.getElementById('grossSum').textContent  = ils(t.gross);
      document.getElementById('netSum').textContent    = ils(t.net);
      document.getElementById('totalBudget').textContent = ils(S().totalBudget);

      // include fixed for current month
      const fixedThisMonth = S().recurring.filter(r=>{
        const d = new Date(ROOT.current+'-01');
        const s = new Date(r.start);
        const u = r.until ? new Date(r.until) : null;
        return s <= d && (!u || u >= d);
      }).reduce((s,r)=> s + toNumber(r.amount||0), 0);

      const spent = t.exp + fixedThisMonth;
      const monthlySurplus = t.net - spent;
      document.getElementById('kpiSavings').textContent = ils(monthlySurplus);
      document.getElementById('kpiCurExp').textContent  = ils(t.exp);

      const left  = (S().totalBudget||0) - spent;
      const pct   = S().totalBudget>0 ? spent/S().totalBudget : 0;
      setGauge(pct, spent, left);

      // ===== NEW: הצגת/הסתרת עובר ושב =====
      const overdraftRow = document.getElementById('overdraftRow');
      const overdraftBtn = document.getElementById('btnOverdraft');
      if (S().totalBudget > 0) {
        if (overdraftRow) overdraftRow.classList.add('hidden');
        if (overdraftBtn) {
          overdraftBtn.classList.remove('hidden');
          overdraftBtn.textContent = 'עובר ושב: ' + ils(S().overdraft || 0) + ' ▾';
        }
      } else {
        if (overdraftRow) {
          overdraftRow.classList.remove('hidden');
          const v = document.getElementById('overdraftVal'); if (v) v.textContent = ils(S().overdraft || 0);
        }
        if (overdraftBtn) overdraftBtn.classList.add('hidden');
      }
      // ===== END NEW =====
    }

    function renderAll(){
      buildMonthStrip();
      initCategorySelects();
      syncTodayInputs();
      renderHeaderAndGauge();
      renderIncomeList();
      renderPensions();
      renderExpensesList();
      renderFixed();
      renderSavings();
      updateCatBadge();
    }

    /* ========= MUTATIONS ========= */
    function addIncome({net,gross,source,date}){
      const amountNet   = Math.max(0, toNumber(net));
      const amountGross = Math.max(0, toNumber(gross || net));
      const src = String(source||'הכנסה').trim().slice(0,60);
      const dt = date ? new Date(date) : new Date();
      S().transactions.unshift({ id: uuid(), date: dt.toISOString(), type:'income', amount: amountNet, gross: amountGross, category: src, merchant: src });
      saveRoot(); renderAll(); toast('הכנסה נוספה');
    }
    function addExpense({amount,category,merchant,date}){
      const a = Math.max(0, toNumber(amount));
      const cat = String(category||'שונות').trim().slice(0,60);
      const mer = String(merchant||'').trim().slice(0,80);
      const dt = date ? new Date(date) : new Date();
      S().transactions.unshift({ id: uuid(), date: dt.toISOString(), type:'expense', amount:a, category:cat, merchant:mer });
      saveRoot(); renderAll(); toast('הוצאה נוספה');
    }
    function upsertPension({owner,balance,monthly}){
      const nm = String(owner||'').trim().slice(0,40);
      if(!nm) { toast('צריך למלא שם'); return; }
      const bal = Math.max(0, toNumber(balance));
      const mon = Math.max(0, toNumber(monthly));
      const ex = S().pensions.find(p=> p.owner===nm);
      if (ex){ ex.balance = bal; ex.monthly = mon; ex.lastUpdate = new Date().toISOString(); toast(`עודכן "${nm}"`); }
      else { S().pensions.unshift({ id:uuid(), owner:nm, balance:bal, monthly:mon, lastUpdate:new Date().toISOString() }); toast(`נוסף "${nm}"`); }
      saveRoot(); renderAll();
    }
    function deletePension(id){
      const idx = S().pensions.findIndex(p=>p.id===id);
      if(idx<0) return;
      S().pensions.splice(idx,1); saveRoot(); renderAll(); toast('חשבון הוסר');
    }

    /* ========= EDIT ========= */
    function openEdit(id){
      const t = S().transactions.find(x=> x.id===id); if(!t) return;
      document.getElementById('editId').value = t.id;
      document.getElementById('editType').value = t.type;
      document.getElementById('editAmount').value = t.amount;
      document.getElementById('editMerchant').value = t.merchant||'';
      document.getElementById('editCategory').value = t.category||'';
      document.getElementById('editDate').value = toInputDate(t.date);
      toggleModal(true);
    }
    function toggleModal(show){
      const m = document.getElementById('editModal');
      if(show){ m.classList.remove('hidden'); m.classList.add('flex'); }
      else { m.classList.add('hidden'); m.classList.remove('flex'); }
    }
    function saveEdit(form){
      const id = form.querySelector('#editId').value;
      const t = S().transactions.find(x=> x.id===id); if(!t) return;
      t.type     = form.type.value==='income' ? 'income' : 'expense';
      t.amount   = Math.max(0, toNumber(form.amount.value));
      t.merchant = String(form.merchant.value||'').slice(0,80);
      t.category = String(form.category.value||'').slice(0,60);
      t.date     = new Date(form.date.value||new Date()).toISOString();
      if (t.type==='income' && !t.gross) t.gross = t.amount;
      saveRoot(); renderAll(); toast('עודכן'); toggleModal(false);
    }
    function deleteRow(id){
      const idx = S().transactions.findIndex(x=> x.id===id);
      if(idx<0) return;
      S().transactions.splice(idx,1); saveRoot(); renderAll(); toast('נמחק'); toggleModal(false);
    }

    /* ========= EVENTS ========= */
    // main tabs
    document.querySelectorAll('.seg [data-view]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const seg = btn.closest('.seg');
        seg.querySelectorAll('button').forEach(b=>{ b.classList.remove('on'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('on'); btn.setAttribute('aria-selected','true');
        const view = btn.getAttribute('data-view');
        document.querySelectorAll('[data-view-panel]').forEach(p=>{
          p.classList.toggle('hidden', p.getAttribute('data-view-panel')!==view);
        });
      });
    });

    // expenses sub tabs
    document.querySelectorAll('#view-expenses .seg [data-subview]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const seg = btn.closest('.seg');
        seg.querySelectorAll('button').forEach(b=>{ b.classList.remove('on'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('on'); btn.setAttribute('aria-selected','true');
        const v=btn.getAttribute('data-subview');
        document.querySelectorAll('#view-expenses [data-subpanel]').forEach(p=>{
          p.classList.toggle('hidden', p.getAttribute('data-subpanel')!==v);
        });
      });
    });

    // savings sub tabs
    document.querySelectorAll('#view-savings .seg [data-subview]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const seg = btn.closest('.seg');
        seg.querySelectorAll('button').forEach(b=>{ b.classList.remove('on'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('on'); btn.setAttribute('aria-selected','true');
        const v=btn.getAttribute('data-subview');
        document.querySelectorAll('#view-savings [data-subpanel]').forEach(p=>{
          p.classList.toggle('hidden', p.getAttribute('data-subpanel')!==v);
        });
      });
    });

    // budget
    document.getElementById('formTotalBudget')?.addEventListener('submit', e=>{
      e.preventDefault();
      const v=toNumber(document.getElementById('totalBudgetInput').value);
      S().totalBudget=v; saveRoot(); renderAll(); toast('התקציב עודכן');
      e.currentTarget.reset();
    });

    // ===== NEW: כפתור עריכת עובר ושב (כאשר יש תקציב) =====
    document.getElementById('btnOverdraft')?.addEventListener('click', () => {
      const newVal = prompt('הזן סכום עובר ושב', S().overdraft || 0);
      if (newVal !== null) {
        S().overdraft = toNumber(newVal);
        saveRoot(); renderAll(); toast('עודכן עובר ושב');
      }
    });
    // ===== END NEW =====

    // income add
    document.getElementById('btnAddIncomeInline')?.addEventListener('click', ()=>{
      const f=document.getElementById('formIncomeInline');
      f.classList.toggle('hidden');
      if(!f.classList.contains('hidden')) document.getElementById('incomeNet').focus();
    });
    document.getElementById('formIncomeInline')?.addEventListener('submit', e=>{
      e.preventDefault();
      const f=e.currentTarget;
      addIncome({
        net:f.querySelector('#incomeNet').value,
        gross:f.querySelector('#incomeGross').value,
        source:f.querySelector('#incomeSource').value,
        date:f.querySelector('#incomeDate').value
      });
      f.reset(); f.classList.add('hidden');
    });

    // expenses add
    document.getElementById('formExpense')?.addEventListener('submit', e=>{
      e.preventDefault();
      const f=e.currentTarget;
      if(!f.querySelector('#catSelect').value) { toast('בחר קטגוריה'); f.querySelector('#catSelect').focus(); return; }
      if(!f.querySelector('#expAmount').value) { toast('מלא/י סכום'); f.querySelector('#expAmount').focus(); return; }
      addExpense({
        amount:f.querySelector('#expAmount').value,
        category:f.querySelector('#catSelect').value,
        merchant:f.querySelector('#expMerchant').value,
        date:f.querySelector('#expDate').value
      });
      f.reset(); updateCatBadge();
    });
    // filters
    ['filterText','filterCat','filterFrom','filterTo','sortBy'].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      el.addEventListener('input', renderExpensesList);
      el.addEventListener('change', renderExpensesList);
    });
    // cat badge on change
    document.getElementById('catSelect')?.addEventListener('change', updateCatBadge);

    // fixed add/update
    document.getElementById('formFixedAdd')?.addEventListener('submit', e=>{
      e.preventDefault();
      const name=document.getElementById('fixName').value;
      const amount=toNumber(document.getElementById('fixAmount').value);
      const start=document.getElementById('fixStart').value || (ROOT.current+'-01');
      const until=document.getElementById('fixUntil').value || null;
      if(!name || !amount){ toast('שם וסכום נדרשים'); return; }
      const ex=S().recurring.find(r=>r.name===name);
      if(ex){ ex.amount=amount; ex.start=new Date(start).toISOString(); ex.until=until? new Date(until).toISOString():null; }
      else { S().recurring.push({id:uuid(), name, amount, start:new Date(start).toISOString(), until:until? new Date(until).toISOString():null}); }
      saveRoot(); renderAll(); toast('עודכן חיוב קבוע'); e.currentTarget.reset();
    });

    // pension form
    document.getElementById('formPensionAdd')?.addEventListener('submit', e=>{
      e.preventDefault();
      const f=e.currentTarget;
      upsertPension({
        owner:f.querySelector('#penOwner').value,
        balance:f.querySelector('#penBalance').value,
        monthly:f.querySelector('#penMonthly').value
      });
      f.reset();
    });

    // savings forms
    document.getElementById('formKeren')?.addEventListener('submit', e=>{
      e.preventDefault();
      const n=document.getElementById('krName').value.trim();
      const b=toNumber(document.getElementById('krBalance').value);
      const m=toNumber(document.getElementById('krMonthly').value);
      if(!n){toast('שם קרן נדרש');return;}
      const ex=S().savings.krans.find(x=>x.name===n);
      if(ex){ ex.balance=b; ex.monthly=m; } else { S().savings.krans.push({id:uuid(), name:n, balance:b, monthly:m}); }
      saveRoot(); renderAll(); toast('קרן השתלמות נשמרה'); e.currentTarget.reset();
    });
    document.getElementById('formDeposit')?.addEventListener('submit', e=>{
      e.preventDefault();
      const n=document.getElementById('depName').value.trim();
      const b=toNumber(document.getElementById('depBalance').value);
      const m=toNumber(document.getElementById('depAdd').value);
      if(!n){toast('שם חשבון נדרש');return;}
      const ex=S().savings.deposits.find(x=>x.name===n);
      if(ex){ ex.balance=b; ex.monthly=m; } else { S().savings.deposits.push({id:uuid(), name:n, balance:b, monthly:m}); }
      saveRoot(); renderAll(); toast('פיקדון נשמר'); e.currentTarget.reset();
    });
    document.getElementById('formGoal')?.addEventListener('submit', e=>{
      e.preventDefault();
      const n=document.getElementById('goalName').value.trim();
      const t=toNumber(document.getElementById('goalTarget').value);
      const m=toNumber(document.getElementById('goalMonthly').value);
      if(!n||!t){toast('שם ויעד נדרשים');return;}
      const ex=S().savings.goals.find(x=>x.name===n);
      if(ex){ ex.target=t; ex.monthly=m; ex.balance=ex.balance||0; }
      else { S().savings.goals.push({id:uuid(), name:n, target:t, monthly:m, balance:0}); }
      saveRoot(); renderAll(); toast('תכנית חיסכון נשמרה'); e.currentTarget.reset();
    });

    // quick bar
    document.getElementById('quickAddExpense')?.addEventListener('click', ()=>{
      document.querySelector('.seg [data-view="expenses"]').click();
      document.getElementById('expAmount').focus();
    });
    document.getElementById('quickAddIncome')?.addEventListener('click', ()=>{
      document.querySelector('.seg [data-view="home"]').click();
      const f=document.getElementById('formIncomeInline'); if(f && f.classList.contains('hidden')) f.classList.remove('hidden');
      document.getElementById('incomeNet').focus();
    });
    document.getElementById('quickAddRecurring')?.addEventListener('click', ()=>{
      document.querySelector('.seg [data-view="expenses"]').click();
      document.querySelector('#view-expenses .seg [data-subview="exp-fixed"]').click();
      document.getElementById('fixName').focus();
    });

    // edit modal events
    document.getElementById('editClose')?.addEventListener('click', ()=> toggleModal(false));
    document.getElementById('editCancel')?.addEventListener('click', ()=> toggleModal(false));
    document.getElementById('formEdit')?.addEventListener('submit', e=>{ e.preventDefault(); saveEdit(e.currentTarget); });
    document.getElementById('editDelete')?.addEventListener('click', ()=> deleteRow(document.getElementById('editId').value));

    // month picker events
    document.getElementById('btnMonthPicker')?.addEventListener('click', openMonthPicker);
    document.getElementById('mpClose')?.addEventListener('click', ()=> toggleMP(false));

    function syncTodayInputs(){
      const d = new Date(ROOT.current+'-01');
      const dateStr = `${d.getFullYear()}-${pad(d.getMonth()+1)}-01`;
      ['incomeDate','expDate','fixStart'].forEach(id=>{
        const el=document.getElementById(id); if(el) el.value=dateStr;
      });
    }

    function initCategoryFilters(){
      const selFilter = document.getElementById('filterCat');
      if(!selFilter || selFilter.dataset.initedFilter) return;
      ["כל הקטגוריות", ...VARIABLE].forEach((c,i)=>{
        const o=document.createElement('option'); o.value=i?c:''; o.textContent=c; selFilter.appendChild(o);
      });
      selFilter.dataset.initedFilter='1';
    }

    function initUI(){
      initCategorySelects();
      initCategoryFilters();
      buildMonthStrip();
      syncTodayInputs();
      renderAll();
    }

    initUI();
  </script>
</body>
</html>
