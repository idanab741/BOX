<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ארנק חכם – V11</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- pdfmake (לייצוא PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/vfs_fonts.js"></script>

  <style>
    :root{
      --card:#0E1527;
      --page:linear-gradient(to bottom,#0A0F1F,#0B1120);
      --ink:#E5E7EB;
      --muted:#9CA3AF;
      --accent:#10b981;
      --accent-2:#34d399;
      --danger:#ef4444;
      --warn:#f59e0b;
      --orange:#f97316;
      --radius:16px;
      --tap:44px;
      --glass:rgba(255,255,255,.06);
    }
    html{font-size:16px}
    body{
      font-family:'Rubik',ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--page);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:calc(env(safe-area-inset-bottom) + 56px);
    }
    .container{max-width:28rem;margin-inline:auto}
    .card{border-radius:var(--radius);background:var(--card);box-shadow:0 12px 30px rgba(0,0,0,.35);border:1px solid var(--glass)}
    .chip{border-radius:9999px;padding:.35rem .6rem;background:#0f172a;color:#a7f3d0;font-weight:600;font-size:.8rem;white-space:nowrap;border:1px solid rgba(16,185,129,.35)}
    .row{min-height:var(--tap); padding:.55rem .75rem; border-radius:12px}
    .row:hover{background:#0f172a}
    .btn{border-radius:12px; font-weight:700; min-height:var(--tap); padding:.625rem .9rem}
    .btn-prim{background:var(--accent);color:#001b12}
    .btn-ghost{background:#0f172a;color:var(--ink);border:1px solid var(--glass)}
    .btn-danger{background:#7f1d1d;color:#fecaca;border:1px solid rgba(239,68,68,.45)}
    .kpi{background:#0f172a;border-radius:14px;padding:.55rem .75rem}
    .progress{height:8px;border-radius:999px;background:#1f2937;overflow:hidden}
    .progress > div{height:100%;background:var(--accent)}
    .progress.warn > div{background:var(--warn)}
    .progress.danger > div{background:var(--danger)}
    *{touch-action:manipulation}
    :focus-visible{outline:3px solid var(--accent-2); outline-offset:2px}
    ::placeholder{color:#64748b}
    .seg{background:#0f172a;padding:4px;border-radius:12px;display:flex;gap:4px;border:1px solid var(--glass)}
    .seg button{flex:1;border-radius:10px;padding:.5rem .75rem;font-weight:700;color:var(--muted);font-size:.9rem}
    .seg .on{background:var(--card);color:#a7f3d0;box-shadow:0 1px 2px rgba(0,0,0,.25);border:1px solid rgba(16,185,129,.35)}
    .months::-webkit-scrollbar{display:none}
    .months{scrollbar-width:none}
    .input{border-radius:12px;border:1px solid var(--glass);background:#0f172a;color:#0be5b3;padding:.75rem .85rem;min-height:var(--tap)}
    input[type="date"].input{appearance:none;-webkit-appearance:none;line-height:1.2}
    .label{color:var(--muted);font-size:.8rem}
    .no-top-gap > *:first-child{margin-top:0 !important}
    .fab{position:fixed;bottom:92px;left:50%;transform:translateX(-50%);z-index:40}
    .fab .btn{box-shadow:0 10px 30px rgba(16,185,129,.35)}
    .shadow-s{box-shadow:0 6px 18px rgba(0,0,0,.22)}
    .num{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
<main class="container p-3 space-y-4">

  <!-- AUTH VIEW -->
  <section id="authView" class="card p-5 hidden">
    <h1 class="text-xl font-bold mb-2">ארנק חכם – התחברות</h1>
    <p class="text-sm text-slate-400 mb-3">הכנס/י מייל. נשלח קישור כניסה מאובטח (Magic Link).</p>
    <form id="formLogin" class="grid grid-cols-1 gap-3 mb-2">
      <input id="loginEmail" class="input" type="email" placeholder="your@email.com" required />
      <button class="btn btn-prim" type="submit">שלח קישור כניסה</button>
    </form>
    <p id="loginMsg" class="text-sm text-emerald-300 hidden"></p>
  </section>

  <!-- SETUP HOUSEHOLD -->
  <section id="setupView" class="card p-5 hidden">
    <h2 class="text-lg font-semibold mb-2">הקמת משק בית</h2>
    <p class="text-sm text-slate-400 mb-3">שם משק הבית + הגדרות פתיחה מהירות.</p>
    <form id="formSetup" class="grid grid-cols-1 gap-2">
      <input id="setupName" class="input" placeholder="לדוגמה: Idan & Lital" required />
      <input id="setupBudget" class="input text-right" inputmode="decimal" placeholder="תקציב חודשי (₪)" />
      <input id="setupOverdraft" class="input text-right" inputmode="decimal" placeholder="יתרת עו״ש התחלתית (₪)" />
      <button class="btn btn-prim" type="submit">צור משק בית</button>
    </form>
  </section>

  <!-- TOP BAR -->
  <section id="topBar" class="card p-4 hidden">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-[.75rem] text-slate-400">חודש נוכחי</div>
        <div id="currentMonthLabel" class="font-semibold"></div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnMonthPicker" class="chip text-xs" type="button">בחר חודש ▾</button>
        <button id="btnExport" class="chip text-xs" type="button" title="ייצוא PDF/CSV">ייצוא</button>
        <button id="btnSignOut" class="chip text-xs" type="button">התנתק</button>
      </div>
    </div>
  </section>

  <!-- MAIN TABS -->
  <nav id="mainTabs" class="seg card p-1 hidden" role="tablist" aria-label="ניווט">
    <button class="on" role="tab" aria-selected="true" aria-controls="view-home" data-view="home" type="button">ניהול מעקב</button>
    <button role="tab" aria-selected="false" aria-controls="view-expenses" data-view="expenses" type="button">הוצאות</button>
    <button role="tab" aria-selected="false" aria-controls="view-savings" data-view="savings" type="button">חיסכון</button>
  </nav>

  <!-- VIEW: HOME -->
  <section id="view-home" class="space-y-4 hidden" data-view-panel="home">
    <!-- KPIs -->
    <header class="card p-4 flex flex-col gap-3" role="banner">
      <div class="grid grid-cols-2 gap-2 text-[.9rem]" role="group" aria-label="מדדים חודשיים">
        <div class="kpi flex items-center justify-between"><span class="text-slate-400">הוצאות</span><b id="kpiCurExp" class="num">₪0</b></div>
        <div class="kpi flex items-center justify-between"><span class="text-slate-400">תקציב</span><b id="kpiBudget" class="num">₪0</b></div>
        <div class="kpi flex items-center justify-between"><span class="text-slate-400">עודף</span><b id="kpiSurplus" class="num">₪0</b></div>
        <div class="kpi flex items-center justify-between"><span class="text-slate-400">עו"ש</span><b id="kpiOverdraft" class="num">₪0</b></div>
        <div class="kpi flex items-center justify-between"><span class="text-slate-400">חיסכון</span><b id="kpiSavingsTotal" class="num">₪0</b></div>
        <div class="kpi flex items-center justify-between"><span class="text-slate-400">פנסיה</span><b id="kpiPensionTotal" class="num">₪0</b></div>
      </div>
    </header>

    <!-- Gauge -->
    <section class="grid grid-cols-1 gap-4">
      <div class="card p-4 relative" role="region" aria-labelledby="ghead">
        <div class="absolute top-3 right-3 text-[.7rem] text-slate-400">מעקב חודשי</div>
        <div class="flex items-center justify-end mb-2">
          <button id="btnBudgetQuickEdit" class="chip text-xs" type="button">תקציב חודשי ▾</button>
        </div>
        <div class="relative w-full" style="aspect-ratio:2/1" aria-hidden="true">
          <svg id="gsvg" class="absolute inset-0" viewBox="0 0 100 60" preserveAspectRatio="xMidYMid meet">
            <path id="gTrack" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="#1f2937" stroke-width="12" stroke-linecap="round"></path>
            <path id="gValue" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999"></path>
            <text id="centerPct" x="50" y="42" text-anchor="middle" style="font-size:14px;fill:#e5e7eb;font-weight:800">0%</text>
          </svg>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2 text-[.8rem]">
          <div class="bg-[#0f172a] rounded-lg p-2">הוצא עד כה: <b id="spentLabel" class="num">₪0</b></div>
          <div class="bg-[#0f172a] rounded-lg p-2 text-right">נותר/חריגה: <b id="leftLabel" class="num">₪0</b></div>
        </div>
      </div>
    </section>

    <!-- Quick Add FAB -->
    <div class="fab">
      <div class="card p-2 shadow-s flex gap-2">
        <button id="fabAddExpense" class="btn btn-prim text-sm">+ הוצאה</button>
        <button id="fabAddIncome" class="btn btn-ghost text-sm">+ הכנסה</button>
        <button id="fabAddNote" class="btn btn-ghost text-sm">+ הערה</button>
      </div>
    </div>

    <!-- Incomes (compact) -->
    <div class="grid grid-cols-1 gap-4">
      <div class="card p-4" role="region" aria-labelledby="sec-income">
        <div class="flex items-center justify-between mb-3">
          <h3 id="sec-income" class="text-[.95rem] font-semibold">הכנסות</h3>
          <button id="btnAddIncomeInline" type="button" class="btn btn-prim text-xs">+ מקור</button>
        </div>
        <div class="flex items-center justify-between mb-2 text-[.9rem]">
          <div class="space-y-1">
            <div class="text-xs text-slate-400">ברוטו</div>
            <div id="grossSum" class="text-lg font-semibold num">₪0</div>
          </div>
          <div class="space-y-1 text-right">
            <div class="text-xs text-slate-400">נטו</div>
            <div id="netSum" class="text-lg font-semibold num">₪0</div>
          </div>
        </div>
        <form id="formIncomeInline" class="hidden space-y-2 mb-3" role="form">
          <input id="incomeNet" class="input w-full text-right" placeholder="נטו" inputmode="decimal" />
          <input id="incomeGross" class="input w-full text-right" placeholder="ברוטו (אופציונלי)" inputmode="decimal" />
          <input id="incomeSource" class="input w-full" placeholder="מקור (שכר/פרילנס...)" />
          <input type="date" id="incomeDate" class="input w-full text-right" />
          <button class="btn btn-prim w-full" type="submit">הוסף הכנסה</button>
        </form>
        <ul id="incomeList" class="text-[.9rem] space-y-1 max-h-40 overflow-auto" role="list"></ul>
      </div>
    </div>
  </section>

  <!-- VIEW: EXPENSES -->
  <section id="view-expenses" class="space-y-4 hidden" data-view-panel="expenses">
    <div class="seg card p-1" role="tablist" aria-label="סוג הוצאות">
      <button class="on" data-subview="exp-var" aria-selected="true" type="button">משתנות</button>
      <button data-subview="exp-fixed" aria-selected="false" type="button">קבועות</button>
    </div>

    <!-- Variable -->
    <div id="exp-var" class="space-y-3" data-subpanel="exp-var">
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-[.95rem] font-semibold">הוצאות</h3>
          <div id="catBadge" class="chip hidden text-[.7rem]" aria-live="polite"></div>
        </div>

        <form id="formExpense" class="grid grid-cols-1 gap-3 mb-3" role="form">
          <input id="expAmount" class="input text-right" placeholder="סכום (למשל 129.9)" inputmode="decimal" required />
          <input id="expMerchant" class="input" placeholder="ספק/תיאור" />
          <select id="catSelect" class="input" required></select>
          <input type="date" id="expDate" class="input text-right" />
          <button class="btn btn-prim" type="submit">הוסף הוצאה</button>
        </form>

        <div class="rounded-xl p-3 mb-3 grid grid-cols-1 gap-2 bg-[#0f172a]" role="group" aria-label="מסננים">
          <input id="filterText" class="input" placeholder="חיפוש ספק/תיאור" aria-label="חיפוש" />
          <select id="filterCat" class="input" aria-label="סינון לפי קטגוריה"></select>
          <div class="grid grid-cols-2 gap-2">
            <input type="date" id="filterFrom" class="input text-right" aria-label="מתאריך" />
            <input type="date" id="filterTo" class="input text-right" aria-label="עד תאריך" />
          </div>
          <select id="sortBy" class="input" aria-label="מיון">
            <option value="date_desc">מיין: תאריך ↓</option>
            <option value="date_asc">מיין: תאריך ↑</option>
            <option value="amt_desc">מיין: סכום ↓</option>
            <option value="amt_asc">מיין: סכום ↑</option>
          </select>
        </div>

        <ul id="expenseList" class="text-[.92rem] space-y-1 max-h-[60vh] overflow-auto mt-1" role="list" aria-live="polite"></ul>
      </div>
    </div>

    <!-- Fixed -->
    <div id="exp-fixed" class="space-y-3 hidden" data-subpanel="exp-fixed">
      <div class="card p-4">
        <h3 class="text-[.95rem] font-semibold mb-3">הוצאות קבועות חודשיות</h3>
        <form id="formFixedAdd" class="grid grid-cols-2 gap-2 mb-3">
          <select id="fixName" class="input">
            <option>שכירות</option><option>ארנונה</option><option>ועד בית</option>
            <option>חנייה</option><option>אינטרנט</option><option>חשמל</option>
            <option>מים</option><option>סלולרי</option><option>ביטוחים</option>
            <option>‌رכב – ביטוח/טסט/דלק</option><option>חנייה</option><option>מנויים</option>
            <option>חינוך/גן</option><option>אחר</option>
          </select>
          <input id="fixAmount" class="input text-right" placeholder="סכום" inputmode="decimal" />
          <input id="fixNote" class="input col-span-2" placeholder="הערה / פירוט (למשל: ״Netflix 42, Spotify 22״)" />
          <button class="btn btn-prim col-span-2" type="submit">הוסף</button>
        </form>
        <ul id="fixedList" class="space-y-2"></ul>
      </div>
    </div>
  </section>

  <!-- VIEW: SAVINGS -->
  <section id="view-savings" class="space-y-4 hidden" data-view-panel="savings">
    <div class="seg card p-1" role="tablist" aria-label="חיסכון – סוגים">
      <button class="on" data-subview="sav-pension" aria-selected="true" type="button">פנסיה</button>
      <button data-subview="sav-kran" aria-selected="false" type="button">קרן השתלמות</button>
      <button data-subview="sav-deposit" aria-selected="false" type="button">פיקדון כללי</button>
      <button data-subview="sav-goal" aria-selected="false" type="button">תוכנית חיסכון</button>
    </div>

    <div id="sav-pension" data-subpanel="sav-pension" class="space-y-3">
      <div class="card p-4">
        <h3 class="text-[.95rem] font-semibold mb-3">פנסיה</h3>
        <form id="formPensionAdd" class="grid grid-cols-2 gap-2 mb-2">
          <input id="penOwner" class="input col-span-2" placeholder="בעל/ת החשבון" />
          <input id="penBalance" class="input text-right" inputmode="decimal" placeholder="יתרה חד-פעמית" />
          <input id="penMonthly" class="input text-right" inputmode="decimal" placeholder="הכנסה חודשית" />
          <button class="btn btn-prim col-span-2" type="submit">הוסף/עדכן</button>
        </form>
        <div class="kpi flex items-center justify-between"><span>סה״כ פנסיה</span><b id="penTotal" class="num">₪0</b></div>
        <ul id="pensionList" class="text-sm space-y-2 mt-2 max-h-48 overflow-auto"></ul>
      </div>
    </div>

    <div id="sav-kran" data-subpanel="sav-kran" class="space-y-3 hidden">
      <div class="card p-4">
        <h3 class="text-[.95rem] font-semibold mb-3">קרן השתלמות</h3>
        <form id="formKeren" class="grid grid-cols-2 gap-2 mb-2">
          <input id="krName" class="input col-span-2" placeholder="שם הקרן" />
          <input id="krBalance" class="input text-right" inputmode="decimal" placeholder="יתרה התחלתית" />
          <div class="col-span-2 flex items-center gap-2">
            <input id="krHasMonthly" type="checkbox" class="h-5 w-5" />
            <label for="krHasMonthly" class="text-sm text-slate-300">יש הפקדה חודשית</label>
          </div>
          <input id="krMonthly" class="input text-right col-span-2" inputmode="decimal" placeholder="הפקדה חודשית" disabled />
          <button class="btn btn-prim col-span-2" type="submit">שמור</button>
        </form>
        <ul id="krList" class="space-y-2"></ul>
      </div>
    </div>

    <div id="sav-deposit" data-subpanel="sav-deposit" class="space-y-3 hidden">
      <div class="card p-4">
        <h3 class="text-[.95rem] font-semibold mb-3">פיקדון כללי / קרן כספית</h3>
        <form id="formDeposit" class="grid grid-cols-2 gap-2 mb-2">
          <input id="depName" class="input col-span-2" placeholder="שם החשבון" />
          <input id="depBalance" class="input text-right" inputmode="decimal" placeholder="יתרה התחלתית" />
          <div class="col-span-2 flex items-center gap-2">
            <input id="depHasMonthly" type="checkbox" class="h-5 w-5" />
            <label for="depHasMonthly" class="text-sm text-slate-300">יש הפקדה חודשית</label>
          </div>
          <input id="depAdd" class="input text-right col-span-2" inputmode="decimal" placeholder="הפקדה חודשית" disabled />
          <button class="btn btn-prim col-span-2" type="submit">שמור</button>
        </form>
        <ul id="depList" class="space-y-2"></ul>
      </div>
    </div>

    <div id="sav-goal" data-subpanel="sav-goal" class="space-y-3 hidden">
      <div class="card p-4">
        <h3 class="text-[.95rem] font-semibold mb-3">תכנית חיסכון ייעודית</h3>
        <form id="formGoal" class="grid grid-cols-2 gap-2 mb-2">
          <input id="goalName" class="input col-span-2" placeholder="מטרה (חופשה/אירוע/הוצאה מסוימת)" />
          <input id="goalTarget" class="input text-right" inputmode="decimal" placeholder="יעד ₪" />
          <input id="goalMonthly" class="input text-right" inputmode="decimal" placeholder="הפקדה חודשית" />
          <button class="btn btn-prim col-span-2" type="submit">שמור</button>
        </form>
        <ul id="goalList" class="space-y-2"></ul>
      </div>
    </div>
  </section>

  <!-- QUICK NAV -->
  <nav class="fixed inset-x-0 bottom-0 bg-[#0f172a]/95 backdrop-blur border-t border-slate-800 p-3 z-30" role="navigation" aria-label="ניווט מהיר">
    <div class="container grid grid-cols-3 gap-2">
      <button id="navHome" class="btn btn-prim text-sm w-full" type="button">ארנק דיגיטלי</button>
      <button id="navPetty" class="btn btn-ghost text-sm w-full" type="button">קופה קטנה</button>
      <button id="navNotes" class="btn btn-ghost text-sm w-full" type="button">הערות</button>
    </div>
  </nav>

  <!-- VIEW: PETTY -->
  <section id="view-petty" class="hidden container p-3 space-y-4" data-view-panel="petty">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-[.95rem] font-semibold">קופה קטנה</h3>
        <button id="pettyBudgetBtn" class="chip text-xs" type="button">תקציב ▾</button>
      </div>
      <div class="relative w-full" style="aspect-ratio:2/1" aria-hidden="true">
        <svg class="absolute inset-0" viewBox="0 0 100 60" preserveAspectRatio="xMidYMid meet">
          <path id="pettyTrack" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="#1f2937" stroke-width="12" stroke-linecap="round"></path>
          <path id="pettyVal" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999"></path>
          <text id="pettyPct" x="50" y="42" text-anchor="middle" style="font-size:14px;fill:#e5e7eb;font-weight:800">0%</text>
        </svg>
      </div>
      <div class="mt-3 grid grid-cols-2 gap-2 text-[.8rem]">
        <div class="bg-[#0f172a] rounded-lg p-2">הוצא עד כה: <b id="pettySpent" class="num">₪0</b></div>
        <div class="bg-[#0f172a] rounded-lg p-2 text-right">נותר/חריגה: <b id="pettyLeft" class="num">₪0</b></div>
      </div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[.95rem] font-semibold">הוצאות קופה קטנה</h3>
      </div>
      <form id="formPettyExpense" class="grid grid-cols-1 gap-3 mb-3">
        <input id="pettyAmount" class="input text-right" placeholder="סכום" inputmode="decimal" required />
        <input id="pettyMerchant" class="input" placeholder="ספק/תיאור" />
        <select id="pettyCat" class="input" required></select>
        <input type="date" id="pettyDate" class="input text-right" />
        <button class="btn btn-prim" type="submit">הוסף הוצאה</button>
      </form>
      <ul id="pettyList" class="text-[.92rem] space-y-1 max-h-[60vh] overflow-auto mt-1"></ul>
    </div>
  </section>

  <!-- VIEW: NOTES -->
  <section id="view-notes" class="hidden container p-3 no-top-gap" data-view-panel="notes">
    <div class="card p-4">
      <h3 class="text-[.95rem] font-semibold mb-2">הערות</h3>
      <form id="formNote" class="grid grid-cols-1 gap-2 mb-3">
        <input id="noteTitle" class="input" placeholder="כותרת קצרה" />
        <textarea id="noteBody" class="input" rows="3" placeholder="הערה / משימות בשורות"></textarea>
        <input type="date" id="noteDue" class="input text-right" />
        <button class="btn btn-prim" type="submit">הוסף הערה</button>
      </form>

      <h4 class="text-sm text-slate-300 mt-2">הערות כלליות</h4>
      <ul id="notesGeneral" class="space-y-2 mb-3"></ul>

      <div id="calendarWrap" class="mb-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-slate-300" id="calTitle"></div>
          <div class="flex gap-2">
            <button id="calPrev" type="button" class="chip text-xs">«</button>
            <button id="calNext" type="button" class="chip text-xs">»</button>
          </div>
        </div>
        <div class="grid grid-cols-7 gap-1 text-[.72rem] text-slate-400 mb-1">
          <div>א׳</div><div>ב׳</div><div>ג׳</div><div>ד׳</div><div>ה׳</div><div>ו׳</div><div>ש׳</div>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>
      </div>

      <h4 class="text-sm text-slate-300 mt-2">הערות לתאריך נבחר</h4>
      <ul id="notesDay" class="space-y-2"></ul>
    </div>
  </section>

  <!-- Month Picker Modal -->
  <div id="monthPicker" class="hidden fixed inset-0 z-40 items-end md:items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="mpTitle">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative card w-full md:w-[520px] p-5 m-0 md:mx-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 id="mpTitle" class="text-base font-semibold">בחירת חודש</h3>
        <button id="mpClose" class="min-h-[44px] min-w-[44px] text-slate-300 hover:text-white" aria-label="סגור" type="button">✕</button>
      </div>
      <div class="flex items-center mb-2 gap-2">
        <input id="mpSearch" class="input flex-1" placeholder="חיפוש (לדוגמה: 2025-12 או 'דצמבר')" />
      </div>
      <div id="mpGrid" class="grid grid-cols-3 gap-2"></div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastWrap" class="fixed bottom-[92px] right-4 flex flex-col gap-2 z-40" aria-live="polite" aria-atomic="true"></div>

</main>

<script>
/* ========= CONFIG ========= */
const SUPABASE_URL = 'https://zxzopuruaccfjfhrjxqg.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4em9wdXJ1YWNjZmpmaHJqeHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzgwMTUsImV4cCI6MjA3MDkxNDAxNX0.Fk80JHLEFe4W1UDGRABnxRqI1roDOv2dNGOLKqmRV5k';

const PRODUCT_CONFIG = {
  priceILS: 100,
  deviceLimit: 3,
  householdMembersLimit: 2,
  defaultMonth: new Date().toISOString().slice(0,7), // YYYY-MM
  variableCats: ["מזון","מסעדות/בילויים/חיי לילה","קניות/אופנה","פארם/טיפוח","שונות","מתנות","תחבורה ציבורית/מוניות","נסיעות/טיסות","תחזוקת בית","בריאות/תרופות"],
  fixedCats: ["שכירות","ארנונה","ועד בית","אינטרנט","חשמל","מים","סלולרי","ביטוחים","רכב – ביטוח/טסט/דלק","חנייה","מנויים","חינוך/גן","אחר"]
};

/* ========= INIT ========= */
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const ILS = new Intl.NumberFormat('he-IL',{ style:'currency', currency:'ILS', minimumFractionDigits:0, maximumFractionDigits:0 });
const ils = n => ILS.format(Math.round(Number(n||0)));
const pad = n => String(n).padStart(2,'0');
const ym = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
const toInputDate = iso => { const d=new Date(iso); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
const toNumber = v => { if (v==null) return 0; const s=String(v).replace(/[₪,\s]/g,''); const n=Number(s); return Number.isFinite(n)?n:0; };
const uuid = () => (crypto?.randomUUID?.() || 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);} ));
const esc = (s) => String(s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

/* ========= TOAST ========= */
function toast(msg){
  const wrap=document.getElementById('toastWrap');
  const t=document.createElement('div');
  t.className='card p-3 text-sm flex items-center gap-3';
  t.textContent=msg;
  wrap.appendChild(t);
  setTimeout(()=>{t.remove();},3000);
}

/* ========= AUTH ========= */
let SESSION = null, USER = null, HOUSEHOLD = null;
async function initAuth(){
  const { data:{ session } } = await sb.auth.getSession();
  SESSION = session || null;
  USER = session?.user || null;

  sb.auth.onAuthStateChange(async (_event, sess)=>{
    SESSION = sess || null;
    USER = sess?.user || null;
    if (USER){
      await afterLogin();
    } else {
      showOnly('auth');
    }
  });

  if (USER){ await afterLogin(); } else { showOnly('auth'); }
}

document.getElementById('formLogin')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  if(!email) return;
  const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: window.location.origin } });
  if(error){ toast('שגיאה בשליחת קישור'); console.warn(error); return; }
  const m=document.getElementById('loginMsg');
  m.textContent='שלחנו קישור כניסה למייל. התחבר/י עם אותו מייל שבו שמרת את הנתונים.';
  m.classList.remove('hidden');
});

document.getElementById('btnSignOut')?.addEventListener('click', async ()=>{
  await sb.auth.signOut();
  HOUSEHOLD=null;
  showOnly('auth');
});

/* ========= HOUSEHOLD ========= */
async function loadHousehold(){
  const { data:mems, error } = await sb
    .from('household_members')
    .select('household_id, role, households(id,name)')
    .eq('user_id', USER.id);

  if(error){ console.warn(error); return null; }
  if(mems && mems.length){
    HOUSEHOLD = { id: mems[0].household_id, name: mems[0].households?.name || 'משק בית' };
    return HOUSEHOLD;
  }
  return null;
}

document.getElementById('formSetup')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = (document.getElementById('setupName').value || 'משק בית').trim();
  const budget = toNumber(document.getElementById('setupBudget').value);
  const overdraft = toNumber(document.getElementById('setupOverdraft').value);

  const { data:hh, error:hErr } = await sb.from('households').insert({ name }).select('id').single();
  if(hErr){ toast('שגיאה ביצירת משק בית'); console.warn(hErr); return; }

  await sb.from('household_members').insert({ household_id:hh.id, user_id: USER.id, role:'owner' });

  const month_key = PRODUCT_CONFIG.defaultMonth;
  await sb.from('months').insert({ household_id: hh.id, year_month: month_key, total_budget: budget, overdraft });
  HOUSEHOLD = { id: hh.id, name };
  await detectInitialMonth(); // יבחר את החודש שהרגע נוצר
  await renderAll();
  showOnly('app');
  toast('משק בית הוקם');
});

/* ========= MONTH CHOICE (RESTORE EXISTING DATA) ========= */
let CURRENT_MONTH = PRODUCT_CONFIG.defaultMonth;

async function detectInitialMonth(){
  // לוקח את החודש האחרון שבו קיימים טרנזקציות או הגדרת חודש
  let key = PRODUCT_CONFIG.defaultMonth;

  const { data: txLatest } = await sb
    .from('transactions')
    .select('date')
    .eq('household_id', HOUSEHOLD.id)
    .order('date', { ascending:false })
    .limit(1);

  if (txLatest && txLatest.length){
    const d = new Date(txLatest[0].date);
    key = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
  } else {
    const { data: monthsLatest } = await sb
      .from('months')
      .select('year_month')
      .eq('household_id', HOUSEHOLD.id)
      .order('year_month', { ascending:false })
      .limit(1);
    if(monthsLatest && monthsLatest.length) key = monthsLatest[0].year_month;
  }

  CURRENT_MONTH = key;

  // דואג שקיים רשומת חודש – בלי למחוק/לאפס נתונים קיימים
  const { data: exists } = await sb
    .from('months')
    .select('year_month')
    .eq('household_id', HOUSEHOLD.id)
    .eq('year_month', key)
    .maybeSingle();

  if(!exists){
    // מנסה "לסחוב" עו"ש מהחודש האחרון שקיים
    let prevOverdraft = 0;
    const { data: lastMonth } = await sb
      .from('months')
      .select('overdraft, year_month')
      .eq('household_id', HOUSEHOLD.id)
      .order('year_month', { ascending:false })
      .limit(1);
    if(lastMonth && lastMonth.length) prevOverdraft = toNumber(lastMonth[0].overdraft || 0);

    await sb.from('months').insert({
      household_id: HOUSEHOLD.id,
      year_month: key,
      total_budget: 0,
      overdraft: prevOverdraft
    });
  }
}

async function afterLogin(){
  const hh = await loadHousehold();
  if(!hh){ showOnly('setup'); return; }
  await detectInitialMonth();   // ← זה מה שמחזיר את הדאטה הקיים במקום לאפס לחודש חדש
  await renderAll();
  showOnly('app');
}

/* ========= DB HELPERS ========= */
const CAT = { VARIABLE: PRODUCT_CONFIG.variableCats, FIXED: PRODUCT_CONFIG.fixedCats };

async function qTransactions(){
  const { data, error } = await sb.from('transactions')
    .select('*')
    .eq('household_id', HOUSEHOLD.id)
    .gte('date', CURRENT_MONTH+'-01')
    .lte('date', CURRENT_MONTH+'-31')
    .order('date', { ascending:false });
  if(error){ console.warn(error); return []; }
  return data||[];
}
async function qMonth(){
  const { data, error } = await sb.from('months')
    .select('*')
    .eq('household_id', HOUSEHOLD.id)
    .eq('year_month', CURRENT_MONTH)
    .maybeSingle();
  if(error){ console.warn(error); return null; }
  return data;
}
async function qRecurring(){
  const { data } = await sb.from('recurring')
    .select('*')
    .eq('household_id', HOUSEHOLD.id)
    .order('created_at', { ascending:false });
  return data||[];
}
async function qPensions(){
  const { data } = await sb.from('pensions')
    .select('*')
    .eq('household_id', HOUSEHOLD.id)
    .order('updated_at', { ascending:false });
  return data||[];
}
async function qSavings(kind){
  const { data } = await sb.from('savings_accounts')
    .select('*')
    .eq('household_id', HOUSEHOLD.id)
    .eq('kind', kind)
    .order('created_at', { ascending:false });
  return data||[];
}
async function qPetty(){
  const { data:pc } = await sb.from('petty_cash').select('*').eq('household_id', HOUSEHOLD.id).maybeSingle();
  const { data:tx } = await sb.from('petty_tx').select('*').eq('household_id', HOUSEHOLD.id).order('date', { ascending:false });
  return { pc: pc||{budget_cap:0}, tx: tx||[] };
}
async function qNotes(){
  const { data } = await sb.from('notes').select('*').eq('household_id', HOUSEHOLD.id).order('created_at',{ascending:false});
  return data||[];
}

/* ========= TOTALS / RENDER ========= */
function setGauge(p, spent, left){
  const path = document.getElementById('gValue');
  if(!path) return;
  const len = path.getTotalLength ? path.getTotalLength() : 125.6;
  const clamped = Math.max(0, Math.min(1.2, Number.isFinite(p)? p : 0));
  const draw = Math.min(len, len * Math.min(1, clamped));
  path.setAttribute('stroke-dasharray', `${draw} 999`);
  path.setAttribute('stroke', p<=0.75? 'var(--accent)' : p<=0.9? 'var(--warn)' : p<=1.0? 'var(--orange)' : 'var(--danger)');
  const pct = Math.round((clamped||0)*100);
  const center = document.getElementById('centerPct');
  if(center) center.textContent = pct+'%';
  document.getElementById('spentLabel').textContent = ils(spent);
  const leftEl = document.getElementById('leftLabel');
  leftEl.textContent = ils(left);
  leftEl.className = (left < 0 ? 'text-red-400 ' : '') + 'font-semibold num';
}

async function computeTotals(){
  const [month, tx, rec, pens] = await Promise.all([qMonth(), qTransactions(), qRecurring(), qPensions()]);
  let net=0, gross=0, exp=0;
  const incomes=[], expenses=[];
  (tx||()).forEach?.(()=>{}); // guard for older browsers
  (tx||[]).forEach(t=>{
    if(t.type==='income'){ net += toNumber(t.amount); gross += toNumber(t.gross || t.amount); incomes.push(t); }
    else { exp += toNumber(t.amount); expenses.push(t); }
  });
  const fixed = (rec||[]).reduce((s,r)=> s + toNumber(r.amount||0), 0);
  const budget = toNumber(month?.total_budget||0);
  const overdraft = toNumber(month?.overdraft||0);
  const surplus = net - budget; // לפי האפיון
  const pensTotal = (pens||[]).reduce((s,p)=> s+toNumber(p.balance||0), 0);
  return { month, net, gross, exp, fixed, budget, overdraft, surplus, incomes, expenses, pensTotal };
}

function fillSelect(sel, list, firstLabel){
  if(!sel) return;
  sel.innerHTML='';
  const arr = firstLabel ? [firstLabel, ...list] : list.slice();
  arr.forEach((c,i)=>{
    const o=document.createElement('option');
    o.value=i?(c||'') : '';
    o.textContent=c;
    sel.appendChild(o);
  });
}

function initCategorySelects(){
  fillSelect(document.getElementById('catSelect'), CAT.VARIABLE, "— בחר קטגוריה —");
  fillSelect(document.getElementById('filterCat'), CAT.VARIABLE, "כל הקטגוריות");
  fillSelect(document.getElementById('pettyCat'), CAT.VARIABLE, "— בחר קטגוריה —");
  const editCat = document.getElementById('editCategory');
  if (editCat) fillSelect(editCat, CAT.VARIABLE, null);
}

async function renderHeaderAndGauge(){
  const t = await computeTotals();
  document.getElementById('kpiBudget').textContent = ils(t.budget);
  document.getElementById('grossSum').textContent = ils(t.gross);
  document.getElementById('netSum').textContent = ils(t.net);
  document.getElementById('kpiPensionTotal').textContent = ils(t.pensTotal);

  const [kr, dep, goals] = await Promise.all([qSavings('keren'), qSavings('deposit'), qSavings('goal')]);
  const savingsOther = (kr||[]).reduce((s,x)=> s+toNumber(x.balance||0),0)
      + (dep||[]).reduce((s,x)=> s+toNumber(x.balance||0),0)
      + (goals||[]).reduce((s,x)=> s+toNumber(x.balance||0),0);
  document.getElementById('kpiSavingsTotal').textContent = ils(savingsOther);

  document.getElementById('kpiCurExp').textContent = ils(t.exp);
  document.getElementById('kpiOverdraft').textContent = ils(t.overdraft||0);
  document.getElementById('kpiSurplus').textContent = ils(t.surplus);

  const spent = t.exp + t.fixed;
  const left = t.budget - spent;
  const pct = t.budget>0 ? spent/t.budget : 0;
  setGauge(pct, spent, left);
}

async function renderIncomeList(){
  const t = await computeTotals();
  const ul = document.getElementById('incomeList');
  ul.innerHTML='';
  t.incomes.sort((a,b)=> new Date(b.date) - new Date(a.date));
  t.incomes.forEach(x=>{
    const li=document.createElement('li');
    li.className='row flex items-center justify-between gap-2';
    li.innerHTML = `
      <div class="flex flex-col">
        <span class="text-emerald-300">הכנסה • ${esc(x.category||'')}</span>
        <span class="text-slate-400 text-xs">${new Date(x.date).toLocaleDateString('he-IL')}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="font-semibold num">${ils(x.amount)} · ברוטו ${ils(x.gross||x.amount)}</span>
        <button class="btn btn-ghost text-xs min-h-[36px]" data-edit="${esc(x.id)}" type="button">⋯</button>
      </div>`;
    li.querySelector('[data-edit]')?.addEventListener('click', ()=> openEdit(x.id));
    ul.appendChild(li);
  });
}

<script>
/* ========= EXPENSES (VARIABLE) ========= */
async function renderExpenses(){
  const tx = await qTransactions();

  // מסננים
  const text  = (document.getElementById('filterText')?.value || '').trim().toLowerCase();
  const cat   = document.getElementById('filterCat')?.value || '';
  const fFrom = document.getElementById('filterFrom')?.value || '';
  const fTo   = document.getElementById('filterTo')?.value || '';
  const sort  = document.getElementById('sortBy')?.value || 'date_desc';

  let items = (tx||[]).filter(t => t.type==='expense');

  if (text){
    items = items.filter(t =>
      (t.merchant||'').toLowerCase().includes(text) ||
      (t.category||'').toLowerCase().includes(text)
    );
  }
  if (cat)   items = items.filter(t => (t.category||'') === cat);
  if (fFrom) items = items.filter(t => toInputDate(t.date) >= fFrom);
  if (fTo)   items = items.filter(t => toInputDate(t.date) <= fTo);

  const cmpDate = (a,b)=> new Date(a.date) - new Date(b.date);
  const cmpAmt  = (a,b)=> toNumber(a.amount) - toNumber(b.amount);
  if (sort==='date_desc') items.sort((a,b)=> cmpDate(b,a));
  if (sort==='date_asc')  items.sort(cmpDate);
  if (sort==='amt_desc')  items.sort((a,b)=> cmpAmt(b,a));
  if (sort==='amt_asc')   items.sort(cmpAmt);

  const ul = document.getElementById('expenseList');
  if (!ul) return;
  ul.innerHTML='';

  if (!items.length){
    const li=document.createElement('li');
    li.className='text-slate-400 text-sm p-2';
    li.textContent='אין הוצאות לחודש זה';
    ul.appendChild(li);
    return;
  }

  items.forEach(x=>{
    const li=document.createElement('li');
    li.className='row flex items-center justify-between gap-3';
    li.innerHTML = `
      <div class="flex flex-col min-w-0">
        <span class="truncate">${esc(x.merchant||'ללא תיאור')}</span>
        <span class="text-slate-400 text-xs">${esc(x.category||'כללי')} • ${new Date(x.date).toLocaleDateString('he-IL')}</span>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <span class="font-semibold num">${ils(x.amount)}</span>
        <button class="btn btn-ghost text-xs min-h-[36px]" data-edit="${esc(x.id)}" type="button" title="עריכה">⋯</button>
      </div>`;
    li.querySelector('[data-edit]')?.addEventListener('click', ()=> openEdit(x.id));
    ul.appendChild(li);
  });
}

/* ========= FIXED (RECURRING) ========= */
async function renderFixedList(){
  const list = await qRecurring();
  const ul = document.getElementById('fixedList');
  if(!ul) return;
  ul.innerHTML = '';
  if(!list.length){
    const li=document.createElement('li');
    li.className='text-slate-400 text-sm p-2';
    li.textContent='אין הוצאות קבועות';
    ul.appendChild(li);
    return;
  }
  list.forEach(r=>{
    const li=document.createElement('li');
    li.className='row flex items-center justify-between gap-2 bg-[#0f172a]';
    li.innerHTML = `
      <div class="flex flex-col">
        <span class="font-medium">${esc(r.name||'פריט קבוע')}</span>
        <span class="text-slate-400 text-xs">${esc(r.note||'')}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="num font-semibold">${ils(r.amount||0)}</span>
        <button class="btn btn-ghost text-xs" data-fxedit="${esc(r.id)}" type="button">⋯</button>
      </div>`;
    li.querySelector('[data-fxedit]')?.addEventListener('click', ()=> openFixedEdit(r.id));
    ul.appendChild(li);
  });
}

document.getElementById('formFixedAdd')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name   = document.getElementById('fixName').value || 'פריט קבוע';
  const amount = toNumber(document.getElementById('fixAmount').value);
  const note   = document.getElementById('fixNote').value || '';
  if(!HOUSEHOLD?.id){ toast('נדרש משק בית'); return; }
  const { error } = await sb.from('recurring').insert({
    household_id: HOUSEHOLD.id, name, amount, note
  });
  if(error){ console.warn(error); toast('שגיאה בשמירת קבוע'); return; }
  document.getElementById('fixAmount').value='';
  document.getElementById('fixNote').value='';
  await renderFixedList();
  await renderHeaderAndGauge();
});

/* ========= SAVINGS ========= */
// פנסיה
async function renderPensions(){
  const list = await qPensions();
  const ul = document.getElementById('pensionList');
  const totEl = document.getElementById('penTotal');
  if(!ul) return;
  ul.innerHTML='';
  let total=0;
  (list||[]).forEach(p=>{
    total += toNumber(p.balance||0);
    const li=document.createElement('li');
    li.className='row flex items-center justify-between gap-2 bg-[#0f172a]';
    li.innerHTML = `
      <div class="flex flex-col">
        <span>${esc(p.owner||'בעל/ת חשבון')}</span>
        <span class="text-slate-400 text-xs">חודשי: ${ils(p.monthly||0)}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="num font-semibold">${ils(p.balance||0)}</span>
        <button class="btn btn-ghost text-xs" data-penedit="${esc(p.id)}" type="button">⋯</button>
      </div>`;
    li.querySelector('[data-penedit]')?.addEventListener('click', ()=> openPensionEdit(p.id));
    ul.appendChild(li);
  });
  if(totEl) totEl.textContent = ils(total);
}

document.getElementById('formPensionAdd')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const owner   = document.getElementById('penOwner').value || '';
  const balance = toNumber(document.getElementById('penBalance').value);
  const monthly = toNumber(document.getElementById('penMonthly').value);
  if(!HOUSEHOLD?.id){ toast('נדרש משק בית'); return; }
  const { error } = await sb.from('pensions').insert({
    household_id: HOUSEHOLD.id, owner, balance, monthly
  });
  if(error){ console.warn(error); toast('שגיאה בפנסיה'); return; }
  document.getElementById('penOwner').value='';
  document.getElementById('penBalance').value='';
  document.getElementById('penMonthly').value='';
  await renderPensions();
  await renderHeaderAndGauge();
});

// קרן השתלמות / פיקדון / מטרה
function bindMonthlyToggle(checkboxId, inputId){
  const cb=document.getElementById(checkboxId);
  const inp=document.getElementById(inputId);
  cb?.addEventListener('change', ()=>{ inp.disabled = !cb.checked; if(!cb.checked) inp.value=''; });
}
bindMonthlyToggle('krHasMonthly','krMonthly');
bindMonthlyToggle('depHasMonthly','depAdd');

document.getElementById('formKeren')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = document.getElementById('krName').value || '';
  const balance = toNumber(document.getElementById('krBalance').value);
  const monthly = document.getElementById('krHasMonthly').checked ? toNumber(document.getElementById('krMonthly').value) : 0;
  const { error } = await sb.from('savings_accounts').insert({
    household_id: HOUSEHOLD.id, kind:'keren', name, balance, monthly
  });
  if(error){ console.warn(error); toast('שגיאה בקרן'); return; }
  document.getElementById('krName').value='';
  document.getElementById('krBalance').value='';
  document.getElementById('krHasMonthly').checked=false;
  document.getElementById('krMonthly').value=''; document.getElementById('krMonthly').disabled=true;
  await renderSavingsTabs();
  await renderHeaderAndGauge();
});

document.getElementById('formDeposit')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = document.getElementById('depName').value || '';
  const balance = toNumber(document.getElementById('depBalance').value);
  const monthly = document.getElementById('depHasMonthly').checked ? toNumber(document.getElementById('depAdd').value) : 0;
  const { error } = await sb.from('savings_accounts').insert({
    household_id: HOUSEHOLD.id, kind:'deposit', name, balance, monthly
  });
  if(error){ console.warn(error); toast('שגיאה בפיקדון'); return; }
  document.getElementById('depName').value='';
  document.getElementById('depBalance').value='';
  document.getElementById('depHasMonthly').checked=false;
  document.getElementById('depAdd').value=''; document.getElementById('depAdd').disabled=true;
  await renderSavingsTabs();
  await renderHeaderAndGauge();
});

document.getElementById('formGoal')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = document.getElementById('goalName').value || '';
  const balance = toNumber(document.getElementById('goalTarget').value);
  const monthly = toNumber(document.getElementById('goalMonthly').value);
  const { error } = await sb.from('savings_accounts').insert({
    household_id: HOUSEHOLD.id, kind:'goal', name, balance, monthly
  });
  if(error){ console.warn(error); toast('שגיאה בתכנית'); return; }
  document.getElementById('goalName').value='';
  document.getElementById('goalTarget').value='';
  document.getElementById('goalMonthly').value='';
  await renderSavingsTabs();
  await renderHeaderAndGauge();
});

async function renderSavingsList(kind, listId){
  const list = await qSavings(kind);
  const ul = document.getElementById(listId);
  if(!ul) return;
  ul.innerHTML='';
  if(!list.length){
    const li=document.createElement('li');
    li.className='text-slate-400 text-sm p-2';
    li.textContent='אין רשומות';
    ul.appendChild(li);
    return;
  }
  list.forEach(x=>{
    const li=document.createElement('li');
    li.className='row flex items-center justify-between gap-2 bg-[#0f172a]';
    li.innerHTML = `
      <div class="flex flex-col">
        <span>${esc(x.name||'ללא שם')}</span>
        <span class="text-slate-400 text-xs">חודשי: ${ils(x.monthly||0)}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="num font-semibold">${ils(x.balance||0)}</span>
        <button class="btn btn-ghost text-xs" data-savedit="${esc(x.id)}" type="button">⋯</button>
      </div>`;
    li.querySelector('[data-savedit]')?.addEventListener('click', ()=> openSavingsEdit(x.id));
    ul.appendChild(li);
  });
}

async function renderSavingsTabs(){
  await Promise.all([
    renderPensions(),
    renderSavingsList('keren','krList'),
    renderSavingsList('deposit','depList'),
    renderSavingsList('goal','goalList'),
  ]);
}

/* ========= PETTY CASH ========= */
function setPettyGauge(p, spent, left){
  const path = document.getElementById('pettyVal');
  if(!path) return;
  const len = path.getTotalLength ? path.getTotalLength() : 125.6;
  const clamped = Math.max(0, Math.min(1.2, Number.isFinite(p)? p : 0));
  const draw = Math.min(len, len * Math.min(1, clamped));
  path.setAttribute('stroke-dasharray', `${draw} 999`);
  path.setAttribute('stroke', p<=0.75? 'var(--accent)' : p<=0.9? 'var(--warn)' : p<=1.0? 'var(--orange)' : 'var(--danger)');
  document.getElementById('pettyPct').textContent = Math.round((clamped||0)*100)+'%';
  document.getElementById('pettySpent').textContent = ils(spent);
  const leftEl = document.getElementById('pettyLeft');
  leftEl.textContent = ils(left);
  leftEl.className = (left < 0 ? 'text-red-400 ' : '') + 'font-semibold num';
}

async function renderPetty(){
  const { pc, tx } = await qPetty();
  const cap = toNumber(pc.budget_cap||0);
  const spent = (tx||[]).reduce((s,t)=> s+toNumber(t.amount||0),0);
  const left = cap - spent;
  setPettyGauge(cap>0 ? spent/cap : 0, spent, left);

  const ul = document.getElementById('pettyList');
  if(!ul) return;
  ul.innerHTML='';
  (tx||[]).forEach(x=>{
    const li=document.createElement('li');
    li.className='row flex items-center justify-between gap-2';
    li.innerHTML=`
      <div class="flex flex-col">
        <span>${esc(x.merchant||'ללא תיאור')}</span>
        <span class="text-slate-400 text-xs">${esc(x.category||'')} • ${new Date(x.date).toLocaleDateString('he-IL')}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="num font-semibold">${ils(x.amount||0)}</span>
        <button class="btn btn-ghost text-xs" data-pedit="${esc(x.id)}" type="button">⋯</button>
      </div>`;
    li.querySelector('[data-pedit]')?.addEventListener('click', ()=> openPettyEdit(x.id));
    ul.appendChild(li);
  });
}

document.getElementById('pettyBudgetBtn')?.addEventListener('click', async ()=>{
  const cur = (await qPetty()).pc?.budget_cap || 0;
  const v = prompt('תקציב קופה קטנה (₪):', String(cur));
  if (v==null) return;
  const cap = toNumber(v);
  if(!HOUSEHOLD?.id){ toast('נדרש משק בית'); return; }
  const { error } = await sb
    .from('petty_cash')
    .upsert({ household_id: HOUSEHOLD.id, budget_cap: cap }, { onConflict:'household_id' });
  if(error){ console.warn(error); toast('שגיאה בתקציב'); return; }
  await renderPetty();
});

document.getElementById('formPettyExpense')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const amount = toNumber(document.getElementById('pettyAmount').value);
  const merchant= document.getElementById('pettyMerchant').value || '';
  const category= document.getElementById('pettyCat').value || '';
  const date    = document.getElementById('pettyDate').value || new Date().toISOString();
  if(!amount || !category){ toast('סכום וקטגוריה חובה'); return; }
  const { error } = await sb.from('petty_tx').insert({
    id: uuid(), household_id: HOUSEHOLD.id, amount, merchant, category, date
  });
  if(error){ console.warn(error); toast('שגיאה בהוספה'); return; }
  document.getElementById('pettyAmount').value='';
  document.getElementById('pettyMerchant').value='';
  document.getElementById('pettyCat').value='';
  document.getElementById('pettyDate').value='';
  await renderPetty();
});

/* ========= NOTES & CALENDAR ========= */
let CAL_CURSOR = new Date();
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

async function buildCalendar(){
  const grid = document.getElementById('calendarGrid');
  const title= document.getElementById('calTitle');
  if(!grid) return;
  grid.innerHTML='';
  const s = startOfMonth(CAL_CURSOR);
  const e = endOfMonth(CAL_CURSOR);
  title.textContent = s.toLocaleDateString('he-IL', { month:'long', year:'numeric' });

  const startDay = (s.getDay()+6)%7; // הפוך ל-שני=0 אם תרצה; כאן א'=0 כבר בפריסה שלנו
  for(let i=0;i<startDay;i++){
    const cell=document.createElement('div');
    cell.className='p-2 h-10 rounded';
    grid.appendChild(cell);
  }
  const notes = await qNotes();
  for(let d=1; d<=e.getDate(); d++){
    const cell=document.createElement('button');
    cell.type='button';
    cell.className='p-2 h-10 rounded bg-[#0f172a] hover:bg-slate-800 text-sm';
    cell.textContent = String(d);
    const dayISO = new Date(s.getFullYear(), s.getMonth(), d).toISOString().slice(0,10);
    const has = (notes||[]).some(n => (n.due_date||'').slice(0,10)===dayISO);
    if(has) cell.classList.add('ring-1','ring-emerald-500/40');
    cell.addEventListener('click', ()=> renderNotesDay(dayISO));
    grid.appendChild(cell);
  }
}

async function renderNotes(){
  const notes = await qNotes();
  const gen = document.getElementById('notesGeneral');
  if(gen){
    gen.innerHTML='';
    (notes||[]).filter(n=>!n.due_date).forEach(n=>{
      const li=document.createElement('li');
      li.className='row bg-[#0f172a] flex items-center justify-between gap-2';
      li.innerHTML=`
        <div class="flex flex-col min-w-0">
          <span class="font-medium truncate">${esc(n.title||'ללא כותרת')}</span>
          <span class="text-slate-400 text-xs whitespace-pre-line">${esc(n.body||'')}</span>
        </div>
        <button class="btn btn-ghost text-xs" data-nedit="${esc(n.id)}" type="button">⋯</button>`;
      li.querySelector('[data-nedit]')?.addEventListener('click', ()=> openNoteEdit(n.id));
      gen.appendChild(li);
    });
  }
  await buildCalendar();
  await renderNotesDay(new Date().toISOString().slice(0,10));
}

async function renderNotesDay(dayISO){
  const wrap = document.getElementById('notesDay');
  if(!wrap) return;
  const notes = await qNotes();
  wrap.innerHTML='';
  (notes||[]).filter(n => (n.due_date||'').slice(0,10)===dayISO).forEach(n=>{
    const li=document.createElement('li');
    li.className='row bg-[#0f172a] flex items-center justify-between gap-2';
    li.innerHTML=`
      <div class="flex flex-col min-w-0">
        <span class="font-medium truncate">${esc(n.title||'ללא כותרת')}</span>
        <span class="text-slate-400 text-xs whitespace-pre-line">${esc(n.body||'')}</span>
      </div>
      <button class="btn btn-ghost text-xs" data-ndedit="${esc(n.id)}" type="button">⋯</button>`;
    li.querySelector('[data-ndedit]')?.addEventListener('click', ()=> openNoteEdit(n.id));
    wrap.appendChild(li);
  });
}

document.getElementById('formNote')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const title = document.getElementById('noteTitle').value || '';
  const body  = document.getElementById('noteBody').value || '';
  const due   = document.getElementById('noteDue').value || null;
  const { error } = await sb.from('notes').insert({
    id: uuid(), household_id: HOUSEHOLD.id, title, body, due_date: due
  });
  if(error){ console.warn(error); toast('שגיאה בהערה'); return; }
  document.getElementById('noteTitle').value='';
  document.getElementById('noteBody').value='';
  document.getElementById('noteDue').value='';
  await renderNotes();
});

/* ========= MONTH PICKER ========= */
function updateMonthLabel(){
  const el = document.getElementById('currentMonthLabel');
  if(el){
    const [y,m]=CURRENT_MONTH.split('-').map(n=>Number(n));
    el.textContent = new Date(y, m-1, 1).toLocaleDateString('he-IL', { month:'long', year:'numeric' });
  }
}

document.getElementById('btnMonthPicker')?.addEventListener('click', ()=> openMonthPicker());
document.getElementById('mpClose')?.addEventListener('click', ()=> closeMonthPicker());
document.getElementById('mpSearch')?.addEventListener('input', buildMonthGrid);

function openMonthPicker(){
  const dlg = document.getElementById('monthPicker');
  dlg?.classList.remove('hidden');
  buildMonthGrid();
}
function closeMonthPicker(){
  const dlg = document.getElementById('monthPicker');
  dlg?.classList.add('hidden');
}

async function buildMonthGrid(){
  const grid = document.getElementById('mpGrid');
  if(!grid) return;
  grid.innerHTML='';
  const q = (document.getElementById('mpSearch')?.value || '').trim().toLowerCase();
  // 24 חודשים אחורה + 12 קדימה
  const base = new Date();
  const months=[];
  for(let i=24;i>=0;i--){
    const d=new Date(base.getFullYear(), base.getMonth()-i, 1);
    months.push(d);
  }
  for(let i=1;i<=12;i++){
    const d=new Date(base.getFullYear(), base.getMonth()+i, 1);
    months.push(d);
  }
  months
    .map(d=>({ key: ym(d), label: d.toLocaleDateString('he-IL',{ month:'long', year:'numeric' }) }))
    .filter(m => !q || m.key.includes(q) || m.label.includes(q))
    .forEach(m=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='input text-left hover:bg-slate-800';
      b.textContent = `${m.label} (${m.key})`;
      if (m.key===CURRENT_MONTH) b.classList.add('ring-1','ring-emerald-500/40');
      b.addEventListener('click', async ()=>{
        CURRENT_MONTH = m.key;
        closeMonthPicker();
        await renderAll();
      });
      grid.appendChild(b);
    });
}

/* ========= QUICK ACTIONS ========= */
document.getElementById('btnBudgetQuickEdit')?.addEventListener('click', async ()=>{
  const m = await qMonth();
  const cur = toNumber(m?.total_budget||0);
  const v = prompt('תקציב חודשי (₪):', String(cur));
  if(v==null) return;
  const { error } = await sb.from('months').upsert({
    household_id: HOUSEHOLD.id, year_month: CURRENT_MONTH, total_budget: toNumber(v), overdraft: m?.overdraft||0
  }, { onConflict:'household_id,year_month' });
  if(error){ console.warn(error); toast('שגיאה בעדכון תקציב'); return; }
  await renderHeaderAndGauge();
});

document.getElementById('btnExport')?.addEventListener('click', ()=> exportCSV());

/* ========= EXPORT CSV ========= */
async function exportCSV(){
  const tx = await qTransactions();
  const rows = [
    ['type','amount','gross','merchant','category','date'].join(',')
  ];
  (tx||[]).forEach(t=>{
    const line = [
      t.type||'',
      toNumber(t.amount||0),
      toNumber(t.gross||0),
      `"${String(t.merchant||'').replace(/"/g,'""')}"`,
      `"${String(t.category||'').replace(/"/g,'""')}"`,
      (t.date||'')
    ].join(',');
    rows.push(line);
  });
  const blob = new Blob([rows.join('\n')], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=`wallet_${CURRENT_MONTH}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ========= ADD/EDIT TRANSACTIONS ========= */
document.getElementById('formExpense')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const amount = toNumber(document.getElementById('expAmount').value);
  const merchant= document.getElementById('expMerchant').value || '';
  const category= document.getElementById('catSelect').value || '';
  const date    = document.getElementById('expDate').value || new Date().toISOString();
  if(!amount || !category){ toast('סכום וקטגוריה חובה'); return; }
  const { error } = await sb.from('transactions').insert({
    id: uuid(), household_id: HOUSEHOLD.id, type:'expense', amount, merchant, category, date
  });
  if(error){ console.warn(error); toast('שגיאה בהוספה'); return; }
  document.getElementById('expAmount').value='';
  document.getElementById('expMerchant').value='';
  document.getElementById('catSelect').value='';
  document.getElementById('expDate').value='';
  await renderExpenses();
  await renderHeaderAndGauge();
});

document.getElementById('btnAddIncomeInline')?.addEventListener('click', ()=>{
  document.getElementById('formIncomeInline')?.classList.toggle('hidden');
});

document.getElementById('formIncomeInline')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const net   = toNumber(document.getElementById('incomeNet').value);
  const gross = toNumber(document.getElementById('incomeGross').value||net);
  const src   = document.getElementById('incomeSource').value || '';
  const date  = document.getElementById('incomeDate').value || new Date().toISOString();
  if(!net){ toast('נטו חובה'); return; }
  const { error } = await sb.from('transactions').insert({
    id: uuid(), household_id: HOUSEHOLD.id, type:'income', amount: net, gross, category: src, merchant: 'הכנסה', date
  });
  if(error){ console.warn(error); toast('שגיאה בהכנסה'); return; }
  document.getElementById('incomeNet').value='';
  document.getElementById('incomeGross').value='';
  document.getElementById('incomeSource').value='';
  document.getElementById('incomeDate').value='';
  await renderIncomeList();
  await renderHeaderAndGauge();
});

/* ========= SIMPLE EDITORS ========= */
async function openEdit(id){
  const { data, error } = await sb.from('transactions').select('*').eq('id', id).maybeSingle();
  if(error || !data){ toast('לא נמצא'); return; }
  const kind = data.type==='income' ? 'הכנסה' : 'הוצאה';
  const v = prompt(`${kind} • עדכון סכום (₪) – או ריק למחיקה`, String(toNumber(data.amount||0)));
  if(v===null) return;
  if(v===''){
    await sb.from('transactions').delete().eq('id', id);
  }else{
    await sb.from('transactions').update({ amount: toNumber(v) }).eq('id', id);
  }
  await renderHeaderAndGauge();
  await renderIncomeList();
  await renderExpenses();
}
async function openFixedEdit(id){
  const { data } = await sb.from('recurring').select('*').eq('id', id).maybeSingle();
  if(!data) return;
  const v = prompt(`קבוע "${data.name}" – סכום (₪) – ריק למחיקה`, String(toNumber(data.amount||0)));
  if(v===null) return;
  if(v===''){ await sb.from('recurring').delete().eq('id', id); }
  else{ await sb.from('recurring').update({ amount: toNumber(v) }).eq('id', id); }
  await renderFixedList();
  await renderHeaderAndGauge();
}
async function openSavingsEdit(id){
  const { data } = await sb.from('savings_accounts').select('*').eq('id', id).maybeSingle();
  if(!data) return;
  const v = prompt(`"${data.name}" – יתרה (₪) – ריק למחיקה`, String(toNumber(data.balance||0)));
  if(v===null) return;
  if(v===''){ await sb.from('savings_accounts').delete().eq('id', id); }
  else{ await sb.from('savings_accounts').update({ balance: toNumber(v) }).eq('id', id); }
  await renderSavingsTabs();
  await renderHeaderAndGauge();
}
async function openPensionEdit(id){
  const { data } = await sb.from('pensions').select('*').eq('id', id).maybeSingle();
  if(!data) return;
  const v = prompt(`"${data.owner}" – יתרה (₪) – ריק למחיקה`, String(toNumber(data.balance||0)));
  if(v===null) return;
  if(v===''){ await sb.from('pensions').delete().eq('id', id); }
  else{ await sb.from('pensions').update({ balance: toNumber(v) }).eq('id', id); }
  await renderPensions();
  await renderHeaderAndGauge();
}
async function openPettyEdit(id){
  const { data } = await sb.from('petty_tx').select('*').eq('id', id).maybeSingle();
  if(!data) return;
  const v = prompt(`קופה קטנה – סכום (₪) – ריק למחיקה`, String(toNumber(data.amount||0)));
  if(v===null) return;
  if(v===''){ await sb.from('petty_tx').delete().eq('id', id); }
  else{ await sb.from('petty_tx').update({ amount: toNumber(v) }).eq('id', id); }
  await renderPetty();
}
async function openNoteEdit(id){
  const { data } = await sb.from('notes').select('*').eq('id', id).maybeSingle();
  if(!data) return;
  const v = prompt(`עדכון כותרת (ריק למחיקה):`, data.title||'');
  if(v===null) return;
  if(v===''){ await sb.from('notes').delete().eq('id', id); }
  else{ await sb.from('notes').update({ title: v }).eq('id', id); }
  await renderNotes();
}

/* ========= TABS & NAV ========= */
function switchMainTab(view){
  document.querySelectorAll('[data-view-panel]').forEach(el=> el.classList.add('hidden'));
  document.getElementById(`view-${view}`)?.classList.remove('hidden');

  document.querySelectorAll('#mainTabs [data-view]').forEach(b=>{
    b.classList.toggle('on', b.dataset.view===view);
    b.setAttribute('aria-selected', b.dataset.view===view ? 'true' : 'false');
  });

  // סאב-טאבים בכל תת-מסך
  if(view==='expenses') switchSub('exp-var');
  if(view==='savings')  switchSub('sav-pension');
}

function switchSub(key){
  document.querySelectorAll('[data-subpanel]').forEach(el=> el.classList.add('hidden'));
  document.getElementById(key)?.classList.remove('hidden');

  document.querySelectorAll('[data-subview]').forEach(b=>{
    const on = b.dataset.subview===key;
    b.classList.toggle('on', on);
    b.setAttribute('aria-selected', on ? 'true' : 'false');
  });
}

document.querySelectorAll('#mainTabs [data-view]')?.forEach(b=>{
  b.addEventListener('click', ()=> switchMainTab(b.dataset.view));
});
document.querySelectorAll('[data-subview]')?.forEach(b=>{
  b.addEventListener('click', ()=> switchSub(b.dataset.subview));
});

// כפתורי ניווט תחתונים
document.getElementById('navHome')?.addEventListener('click', ()=>{
  switchMainTab('home');
});
document.getElementById('navPetty')?.addEventListener('click', ()=>{
  document.querySelectorAll('[data-view-panel]').forEach(el=> el.classList.add('hidden'));
  document.getElementById('view-petty')?.classList.remove('hidden');
});
document.getElementById('navNotes')?.addEventListener('click', ()=>{
  document.querySelectorAll('[data-view-panel]').forEach(el=> el.classList.add('hidden'));
  document.getElementById('view-notes')?.classList.remove('hidden');
});

/* ========= FILTER HOOKS ========= */
['filterText','filterCat','filterFrom','filterTo','sortBy'].forEach(id=>{
  document.getElementById(id)?.addEventListener('input', ()=> renderExpenses());
});

/* ========= SHOW / RENDER ========= */
function showOnly(stage){
  const auth = document.getElementById('authView');
  const setup= document.getElementById('setupView');
  const bar  = document.getElementById('topBar');
  const tabs = document.getElementById('mainTabs');
  const home = document.getElementById('view-home');

  [auth,setup,bar,tabs,home].forEach(el=> el?.classList.add('hidden'));

  if(stage==='auth'){ auth?.classList.remove('hidden'); return; }
  if(stage==='setup'){ setup?.classList.remove('hidden'); return; }
  if(stage==='app'){
    bar?.classList.remove('hidden');
    tabs?.classList.remove('hidden');
    home?.classList.remove('hidden');
  }
}

async function renderAll(){
  initCategorySelects();
  updateMonthLabel();
  await Promise.all([
    renderHeaderAndGauge(),
    renderIncomeList(),
    renderExpenses(),
    renderFixedList(),
    renderSavingsTabs(),
    renderPetty(),
    renderNotes()
  ]);
}

/* ========= BOOT ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  initAuth();
});
</script>
</body> </html>
