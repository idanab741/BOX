<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ארנק חכם – v10 Mobile (iPhone 14)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- ========= Supabase SDK (לא חובה אם CLOUD_SYNC=false) ========= -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ========= Supabase / App Config ========= -->
  <script>
    // ====== עריכה: אם לא רוצים ענן – להשאיר false ======
    const CLOUD_SYNC   = false;

    // אם תרצה ענן: הזן את הנתונים ושנה CLOUD_SYNC=true
    const SUPABASE_URL  = 'https://zxzopuruaccfjfhrjxqg.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4em9wdXJ1YWNjZmpmaHJqeHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzgwMTUsImV4cCI6MjA3MDkxNDAxNX0.Fk80JHLEFe4W1UDGRABnxRqI1roDOv2dNGOLKqmRV5k';

    // מזהה משותף (לא חובה אם אין ענן)
    const HH_KEY = 'smartwallet_household';
    let HOUSEHOLD_ID = localStorage.getItem(HH_KEY) || 'idan-lital';
  </script>

  <style>
    :root{
      --card:#111827; /* dark slate-900 */
      --page:linear-gradient(to bottom,#0b1020,#0d1324);
      --ink:#e5e7eb; /* text slate-200 */
      --muted:#94a3b8; /* slate-400 */
      --accent:#10b981; /* emerald-500 */
      --accent-2:#34d399; /* emerald-400 */
      --danger:#ef4444; /* red-500 */
      --warn:#f59e0b; /* amber-500 */
      --radius:16px;
      --tap:44px;
    }
    html{font-size:16px}
    body{
      font-family:'Rubik',ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--page);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:calc(env(safe-area-inset-bottom) + 56px);
    }
    .container{max-width:28rem;margin-inline:auto}
    .card{border-radius:var(--radius);background:var(--card);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .chip{border-radius:9999px;padding:.35rem .6rem;background:#0f172a;color:#a7f3d0;font-weight:600;font-size:.8rem;white-space:nowrap;border:1px solid rgba(16,185,129,.35)}
    .row{min-height:var(--tap); padding:.55rem .75rem; border-radius:12px}
    .row:hover{background:#0f172a}
    .btn{border-radius:12px; font-weight:700; min-height:var(--tap); padding:.625rem .9rem}
    .btn-prim{background:var(--accent);color:#001b12}
    .btn-ghost{background:#0f172a;color:var(--ink);border:1px solid rgba(255,255,255,.06)}
    .btn-danger{background:#7f1d1d;color:#fecaca;border:1px solid rgba(239,68,68,.45)}
    .kpi{background:#0f172a;border-radius:14px;padding:.55rem .75rem}
    .progress{height:8px;border-radius:999px;background:#1f2937;overflow:hidden}
    .progress > div{height:100%;background:var(--accent)}
    .progress.warn > div{background:var(--warn)}
    .progress.danger > div{background:var(--danger)}
    *{touch-action:manipulation}
    :focus-visible{outline:3px solid var(--accent-2); outline-offset:2px}
    ::placeholder{color:#64748b}
    .seg{background:#0f172a;padding:4px;border-radius:12px;display:flex;gap:4px;border:1px solid rgba(255,255,255,.06)}
    .seg button{flex:1;border-radius:10px;padding:.5rem .75rem;font-weight:700;color:var(--muted);font-size:.9rem}
    .seg .on{background:var(--card);color:#a7f3d0;box-shadow:0 1px 2px rgba(0,0,0,.25);border:1px solid rgba(16,185,129,.35)}
    .months::-webkit-scrollbar{display:none}
    .months{scrollbar-width:none}
    .input{border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0f172a;color:#0be5b3;padding:.75rem .85rem;min-height:var(--tap)}
    input[type="date"].input{appearance:none;-webkit-appearance:none;line-height:1.2}
    .label{color:var(--muted);font-size:.8rem}
    .no-top-gap > *:first-child{margin-top:0 !important}
  </style>
</head>
<body>
  <main class="container p-3 space-y-4">
    <!-- APP NAME BOX -->
    <section class="card p-4" aria-label="שם אפליקציה">
      <div class="flex items-center justify-between">
        <h1 class="text-[clamp(1rem,3.6vw,1.2rem)] font-bold tracking-tight">ארנק חכם</h1>
        <button id="btnMonthPicker" class="chip text-xs" title="בחר חודש" type="button">בחר חודש ▾</button>
      </div>
      <div id="currentMonthLabel" class="text-[.72rem] text-slate-400 mt-2"></div>
    </section>

    <!-- MAIN TABS -->
    <nav id="mainTabs" class="seg card p-1" role="tablist" aria-label="ניווט">
      <button class="on" role="tab" aria-selected="true" aria-controls="view-home" data-view="home" type="button">ניהול מעקב</button>
      <button role="tab" aria-selected="false" aria-controls="view-expenses" data-view="expenses" type="button">הוצאות</button>
      <button role="tab" aria-selected="false" aria-controls="view-savings" data-view="savings" type="button">חיסכון</button>
    </nav>

    <!-- VIEW: HOME -->
    <section id="view-home" class="space-y-4" data-view-panel="home">
      <!-- עו"ש -->
      <section class="card p-4" role="region" aria-labelledby="sec-ovr">
        <div class="flex items-center justify-between">
          <h3 id="sec-ovr" class="text-[.95rem] font-semibold">עובר ושב</h3>
          <button id="ovToggle" class="chip text-xs" type="button" aria-expanded="true">מזער ▾</button>
        </div>
        <div class="flex items-center justify-between mt-2">
          <div class="text-xs text-slate-400">יתרה נוכחית</div>
          <div id="ovHomeVal" class="text-xl font-semibold">₪0</div>
        </div>
        <form id="formOverdraftHome" class="mt-3 space-y-2" aria-hidden="false">
          <input id="ovHomeInput" class="input w-full text-right" placeholder="סכום עו״ש לחודש הנוכחי" inputmode="decimal" />
          <button class="btn btn-prim w-full" type="submit">שמור</button>
        </form>
        <p class="text-xs text-slate-500 mt-1">היתרה מתגלגלת קדימה עד שינוי ידני.</p>
      </section>

      <!-- KPIs -->
      <header class="card p-4 flex flex-col gap-3" role="banner">
        <div class="grid grid-cols-2 gap-2 text-[.9rem]" role="group" aria-label="מדדים חודשיים">
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">הוצאות</span><b id="kpiCurExp">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">תקציב</span><b id="kpiBudget">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">עודף</span><b id="kpiSurplus">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">עו"ש</span><b id="kpiOverdraft">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">חיסכון</span><b id="kpiSavingsTotal">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">פנסיה</span><b id="kpiPensionTotal">₪0</b></div>
        </div>
      </header>

      <!-- Gauge -->
      <section class="grid grid-cols-1 gap-4">
        <div class="card p-4 relative" role="region" aria-labelledby="ghead">
          <div class="absolute top-3 right-3 text-[.7rem] text-slate-400">מעקב חודשי</div>
          <div class="flex items-center justify-end mb-2">
            <button id="btnBudgetQuickEdit" class="chip text-xs" type="button">תקציב חודשי ▾</button>
          </div>
          <div class="relative w-full" style="aspect-ratio:2/1" aria-hidden="true">
            <svg id="gsvg" class="absolute inset-0" viewBox="0 0 100 60" preserveAspectRatio="xMidYMid meet">
              <path id="gTrack" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="#1f2937" stroke-width="12" stroke-linecap="round"/>
              <path id="gValue" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999"/>
              <text id="centerPct" x="50" y="42" text-anchor="middle" style="font-size:14px;fill:#e5e7eb;font-weight:800">0%</text>
            </svg>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-2 text-[.8rem]">
            <div class="bg-[#0f172a] rounded-lg p-2">הוצא עד כה: <b id="spentLabel">₪0</b></div>
            <div class="bg-[#0f172a] rounded-lg p-2 text-right">נותר/חריגה: <b id="leftLabel">₪0</b></div>
          </div>
        </div>
      </section>

      <!-- Incomes -->
      <div class="grid grid-cols-1 gap-4">
        <div class="card p-4" role="region" aria-labelledby="sec-income">
          <div class="flex items-center justify-between mb-3">
            <h3 id="sec-income" class="text-[.95rem] font-semibold">הכנסות</h3>
            <button id="btnAddIncomeInline" type="button" class="btn btn-prim text-xs">+ מקור</button>
          </div>
          <div class="flex items-center justify-between mb-2 text-[.9rem]">
            <div class="space-y-1">
              <div class="text-xs text-slate-400">ברוטו</div>
              <div id="grossSum" class="text-lg font-semibold">₪0</div>
            </div>
            <div class="space-y-1 text-right">
              <div class="text-xs text-slate-400">נטו</div>
              <div id="netSum" class="text-lg font-semibold">₪0</div>
            </div>
          </div>
          <form id="formIncomeInline" class="hidden space-y-2 mb-3" role="form">
            <input id="incomeNet" class="input w-full text-right" placeholder="נטו" inputmode="decimal" />
            <input id="incomeGross" class="input w-full text-right" placeholder="ברוטו (אופציונלי)" inputmode="decimal" />
            <input id="incomeSource" class="input w-full" placeholder="מקור (שכר/פרילנס...)" />
            <input type="date" id="incomeDate" class="input w-full text-right" />
            <button class="btn btn-prim w-full">הוסף הכנסה</button>
          </form>
          <ul id="incomeList" class="text-[.9rem] space-y-1 max-h-40 overflow-auto" role="list"></ul>
        </div>
      </div>
    </section>

    <!-- VIEW: EXPENSES -->
    <section id="view-expenses" class="space-y-4 hidden" data-view-panel="expenses">
      <div class="seg card p-1" role="tablist" aria-label="סוג הוצאות">
        <button class="on" data-subview="exp-var" aria-selected="true" type="button">משתנות</button>
        <button data-subview="exp-fixed" aria-selected="false" type="button">קבועות</button>
      </div>

      <!-- Variable -->
      <div id="exp-var" class="space-y-3" data-subpanel="exp-var">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-[.95rem] font-semibold">הוצאות</h3>
            <div id="catBadge" class="chip hidden text-[.7rem]" aria-live="polite"></div>
          </div>
          <form id="formExpense" class="grid grid-cols-1 gap-3 mb-3" role="form">
            <input id="expAmount" class="input text-right" placeholder="סכום (למשל 129.9)" inputmode="decimal" required />
            <input id="expMerchant" class="input" placeholder="ספק/תיאור" />
            <select id="catSelect" class="input" required></select>
            <input type="date" id="expDate" class="input text-right" />
            <button class="btn btn-prim">הוסף הוצאה</button>
          </form>
          <div class="rounded-xl p-3 mb-3 grid grid-cols-1 gap-2 bg-[#0f172a]" role="group" aria-label="מסננים">
            <input id="filterText" class="input" placeholder="חיפוש ספק/תיאור" aria-label="חיפוש" />
            <select id="filterCat" class="input" aria-label="סינון לפי קטגוריה"></select>
            <div class="grid grid-cols-2 gap-2">
              <input type="date" id="filterFrom" class="input text-right" aria-label="מתאריך" />
              <input type="date" id="filterTo" class="input text-right" aria-label="עד תאריך" />
            </div>
            <select id="sortBy" class="input" aria-label="מיון">
              <option value="date_desc">מיין: תאריך ↓</option>
              <option value="date_asc">מיין: תאריך ↑</option>
              <option value="amt_desc">מיין: סכום ↓</option>
              <option value="amt_asc">מיין: סכום ↑</option>
            </select>
          </div>
          <ul id="expenseList" class="text-[.92rem] space-y-1 max-h-[60vh] overflow-auto mt-1" role="list" aria-live="polite"></ul>
        </div>
      </div>

      <!-- Fixed -->
      <div id="exp-fixed" class="space-y-3 hidden" data-subpanel="exp-fixed">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">הוצאות קבועות חודשיות</h3>
          <form id="formFixedAdd" class="grid grid-cols-2 gap-2 mb-3">
            <select id="fixName" class="input">
              <option>שכירות</option><option>ארנונה</option><option>ועד בית</option>
              <option>חנייה</option><option>אינטרנט</option><option>חשמל</option>
              <option>מים</option><option>סלולרי</option><option>ביטוחים</option>
              <option>רכב – ביטוח/טסט/דלק</option><option>מנויים</option><option>חינוך/גן</option><option>אחר</option>
            </select>
            <input id="fixAmount" class="input text-right" placeholder="סכום" inputmode="decimal" />
            <input id="fixNote" class="input col-span-2" placeholder="הערה / פירוט (למשל: ״Netflix 42, Spotify 22״)" />
            <button class="btn btn-prim col-span-2" type="submit">הוסף</button>
          </form>
          <ul id="fixedList" class="space-y-2"></ul>
        </div>
      </div>
    </section>

    <!-- VIEW: SAVINGS -->
    <section id="view-savings" class="space-y-4 hidden" data-view-panel="savings">
      <div class="seg card p-1" role="tablist" aria-label="חיסכון – סוגים">
        <button class="on" data-subview="sav-pension" aria-selected="true" type="button">פנסיה</button>
        <button data-subview="sav-kran" aria-selected="false" type="button">קרן השתלמות</button>
        <button data-subview="sav-deposit" aria-selected="false" type="button">פיקדון כללי</button>
        <button data-subview="sav-goal" aria-selected="false" type="button">תוכנית חיסכון</button>
      </div>

      <div id="sav-pension" data-subpanel="sav-pension" class="space-y-3">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">פנסיה</h3>
          <form id="formPensionAdd" class="grid grid-cols-2 gap-2 mb-2">
            <input id="penOwner" class="input col-span-2" placeholder="בעל/ת החשבון" />
            <input id="penBalance" class="input text-right" inputmode="decimal" placeholder="יתרה חד-פעמית" />
            <input id="penMonthly" class="input text-right" inputmode="decimal" placeholder="הכנסה חודשית" />
            <button class="btn btn-prim col-span-2">הוסף/עדכן</button>
          </form>
          <div class="kpi flex items-center justify-between"><span>סה״כ פנסיה</span><b id="penTotal">₪0</b></div>
          <ul id="pensionList" class="text-sm space-y-2 mt-2 max-h-48 overflow-auto"></ul>
        </div>
      </div>

      <div id="sav-kran" data-subpanel="sav-kran" class="space-y-3 hidden">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">קרן השתלמות</h3>
          <form id="formKeren" class="grid grid-cols-2 gap-2 mb-2">
            <input id="krName" class="input col-span-2" placeholder="שם הקרן" />
            <input id="krBalance" class="input text-right" inputmode="decimal" placeholder="יתרה התחלתית (אוג׳ 2025)" />
            <div class="col-span-2 flex items-center gap-2">
              <input id="krHasMonthly" type="checkbox" class="h-5 w-5" />
              <label for="krHasMonthly" class="text-sm text-slate-300">יש הפקדה חודשית</label>
            </div>
            <input id="krMonthly" class="input text-right col-span-2" inputmode="decimal" placeholder="הפקדה חודשית" disabled />
            <button class="btn btn-prim col-span-2">שמור</button>
          </form>
          <ul id="krList" class="space-y-2"></ul>
        </div>
      </div>

      <div id="sav-deposit" data-subpanel="sav-deposit" class="space-y-3 hidden">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">פיקדון כללי / קרן כספית</h3>
          <form id="formDeposit" class="grid grid-cols-2 gap-2 mb-2">
            <input id="depName" class="input col-span-2" placeholder="שם החשבון" />
            <input id="depBalance" class="input text-right" inputmode="decimal" placeholder="יתרה התחלתית (אוג׳ 2025)" />
            <div class="col-span-2 flex items-center gap-2">
              <input id="depHasMonthly" type="checkbox" class="h-5 w-5" />
              <label for="depHasMonthly" class="text-sm text-slate-300">יש הפקדה חודשית</label>
            </div>
            <input id="depAdd" class="input text-right col-span-2" inputmode="decimal" placeholder="הפקדה חודשית" disabled />
            <button class="btn btn-prim col-span-2">שמור</button>
          </form>
          <ul id="depList" class="space-y-2"></ul>
        </div>
      </div>

      <div id="sav-goal" data-subpanel="sav-goal" class="space-y-3 hidden">
        <div class="card p-4">
          <h3 class="text-[.95rem] font-semibold mb-3">תכנית חיסכון ייעודית</h3>
          <form id="formGoal" class="grid grid-cols-2 gap-2 mb-2">
            <input id="goalName" class="input col-span-2" placeholder="מטרה (חופשה/ירח דבש/הוצאה מסוימת)" />
            <input id="goalTarget" class="input text-right" inputmode="decimal" placeholder="יעד ₪" />
            <input id="goalMonthly" class="input text-right" inputmode="decimal" placeholder="הפקדה חודשית" />
            <button class="btn btn-prim col-span-2">שמור</button>
          </form>
          <ul id="goalList" class="space-y-2"></ul>
        </div>
      </div>
    </section>

    <footer class="text-center text-[.7rem] text-slate-500 py-6" role="contentinfo">
      v10 • מובייל (iPhone 14) • כל חודש נשמר בנפרד • RTL • Dark
    </footer>
  </main>

  <!-- Sticky Quick Bar -->
  <nav class="fixed inset-x-0 bottom-0 bg-[#0f172a]/95 backdrop-blur border-t border-slate-800 p-3 z-30" role="navigation" aria-label="ניווט מהיר">
    <div class="container grid grid-cols-3 gap-2">
      <button id="navHome"  class="btn btn-prim text-sm w-full" type="button">ארנק דיגיטלי</button>
      <button id="navPetty" class="btn btn-ghost text-sm w-full" type="button">קופה קטנה</button>
      <button id="navNotes" class="btn btn-ghost text-sm w-full" type="button">הערות</button>
    </div>
  </nav>

  <!-- Toasts -->
  <div id="toastWrap" class="fixed bottom-[92px] right-4 flex flex-col gap-2 z-40" aria-live="polite" aria-atomic="true"></div>

  <!-- Edit Modal -->
  <div id="editModal" class="hidden fixed inset-0 z-40 items-end md:items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative card w-full md:w-[520px] p-5 m-0 md:mx-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 id="editTitle" class="text-base font-semibold">עריכת רשומה</h3>
        <button id="editClose" class="min-h-[44px] min-w-[44px] text-slate-300 hover:text-white" aria-label="סגור" type="button">✕</button>
      </div>
      <form id="formEdit" class="grid grid-cols-2 gap-2" role="form">
        <input type="hidden" name="id" id="editId" />
        <label class="label" for="editType">סוג</label>
        <select name="type" id="editType" class="input">
          <option value="expense">הוצאה</option>
          <option value="income">הכנסה</option>
        </select>
        <label class="label" for="editAmount">סכום</label>
        <input name="amount" id="editAmount" class="input text-right" inputmode="decimal" />
        <label class="label" for="editMerchant">ספק/תיאור</label>
        <input name="merchant" id="editMerchant" class="input" />
        <label class="label" for="editCategory" id="editCategoryLabel">קטגוריה</label>
        <select name="category" id="editCategory" class="input"></select>
        <label class="label" for="editDate">תאריך</label>
        <input type="date" name="date" id="editDate" class="input text-right" />
        <div class="col-span-2 flex justify-between mt-2">
          <button id="editDelete" type="button" class="btn btn-danger">מחק</button>
          <div class="flex gap-2">
            <button type="button" id="editCancel" class="btn btn-ghost">בטל</button>
            <button class="btn btn-prim">שמור</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Month Picker Modal -->
  <div id="monthPicker" class="hidden fixed inset-0 z-40 items-end md:items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="mpTitle">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative card w-full md:w-[520px] p-5 m-0 md:mx-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 id="mpTitle" class="text-base font-semibold">בחירת חודש</h3>
        <button id="mpClose" class="min-h-[44px] min-w-[44px] text-slate-300 hover:text-white" aria-label="סגור" type="button">✕</button>
      </div>
      <div id="mpGrid" class="grid grid-cols-3 gap-2"></div>
    </div>
  </div>

  <!-- VIEW: PETTY -->
  <section id="view-petty" class="hidden container p-3 space-y-4" data-view-panel="petty">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-[.95rem] font-semibold">קופה קטנה</h3>
        <button id="pettyBudgetBtn" class="chip text-xs" type="button">תקציב ▾</button>
      </div>
      <div class="relative w-full" style="aspect-ratio:2/1" aria-hidden="true">
        <svg class="absolute inset-0" viewBox="0 0 100 60" preserveAspectRatio="xMidYMid meet">
          <path id="pettyTrack" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="#1f2937" stroke-width="12" stroke-linecap="round"/>
          <path id="pettyVal" d="M10,50 A40,40 0 0 1 90,50" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999"/>
          <text id="pettyPct" x="50" y="42" text-anchor="middle" style="font-size:14px;fill:#e5e7eb;font-weight:800">0%</text>
        </svg>
      </div>
      <div class="mt-3 grid grid-cols-2 gap-2 text-[.8rem]">
        <div class="bg-[#0f172a] rounded-lg p-2">הוצא עד כה: <b id="pettySpent">₪0</b></div>
        <div class="bg-[#0f172a] rounded-lg p-2 text-right">נותר/חריגה: <b id="pettyLeft">₪0</b></div>
      </div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[.95rem] font-semibold">הוצאות קופה קטנה</h3>
      </div>
      <form id="formPettyExpense" class="grid grid-cols-1 gap-3 mb-3">
        <input id="pettyAmount" class="input text-right" placeholder="סכום" inputmode="decimal" required />
        <input id="pettyMerchant" class="input" placeholder="ספק/תיאור" />
        <select id="pettyCat" class="input" required></select>
        <input type="date" id="pettyDate" class="input text-right" />
        <button class="btn btn-prim" type="submit">הוסף הוצאה</button>
      </form>
      <ul id="pettyList" class="text-[.92rem] space-y-1 max-h-[60vh] overflow-auto mt-1"></ul>
    </div>

    <footer class="text-center text-[.7rem] text-slate-500 py-6">
      v10 • מובייל (iPhone 14) • כל חודש נשמר בנפרד • RTL • Dark
    </footer>
  </section>

  <!-- VIEW: NOTES -->
  <section id="view-notes" class="hidden container p-3 no-top-gap" data-view-panel="notes">
    <div class="card p-4">
      <h3 class="text-[.95rem] font-semibold mb-2">הערות</h3>
      <form id="formNote" class="grid grid-cols-1 gap-2 mb-3">
        <input id="noteTitle" class="input" placeholder="כותרת קצרה" />
        <textarea id="noteBody" class="input" rows="3" placeholder="הערה / משימות בשורות"></textarea>
        <input type="date" id="noteDue" class="input text-right" />
        <button class="btn btn-prim" type="submit">הוסף הערה</button>
      </form>

      <h4 class="text-sm text-slate-300 mt-2">הערות כלליות</h4>
      <ul id="notesGeneral" class="space-y-2 mb-3"></ul>

      <div id="calendarWrap" class="mb-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-slate-300" id="calTitle"></div>
          <div class="flex gap-2">
            <button id="calPrev" type="button" class="chip text-xs">«</button>
            <button id="calNext" type="button" class="chip text-xs">»</button>
          </div>
        </div>
        <div class="grid grid-cols-7 gap-1 text-[.72rem] text-slate-400 mb-1">
          <div>א׳</div><div>ב׳</div><div>ג׳</div><div>ד׳</div><div>ה׳</div><div>ו׳</div><div>ש׳</div>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>
      </div>

      <h4 class="text-sm text-slate-300 mt-2">הערות לתאריך נבחר</h4>
      <ul id="notesDay" class="space-y-2"></ul>
    </div>

    <footer class="text-center text-[.7rem] text-slate-500 py-6">
      v10 • מובייל (iPhone 14) • כל חודש נשמר בנפרד • RTL • Dark
    </footer>
  </section>

  <script>
    /* ========= Supabase client (אם צריך) ========= */
    const sb = (CLOUD_SYNC && window.supabase)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON)
      : null;

    /* ========= UTIL ========= */
    const ILS = new Intl.NumberFormat('he-IL',{ style:'currency', currency:'ILS', minimumFractionDigits:0, maximumFractionDigits:0 });
    const ils = n => ILS.format(Math.round(Number(n||0)));
    const pad = n => String(n).padStart(2,'0');
    const ym = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
    const toInputDate = iso => { const d=new Date(iso); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    const toNumber = v => { if (v==null) return 0; const s=String(v).replace(/[₪,\s]/g,''); const n=Number(s); return Number.isFinite(n)?n:0; };
    const uuid = () => (crypto?.randomUUID?.() || 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);} ));
    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    function toast(msg){
      const wrap=document.getElementById('toastWrap');
      const t=document.createElement('div');
      t.className='card p-3 text-sm flex items-center gap-3';
      t.textContent=msg; wrap.appendChild(t);
      setTimeout(()=>{t.remove();},3000);
    }

    /* ========= CATEGORIES ========= */
    const FIXED = ["שכירות","ארנונה","ועד בית","אינטרנט","חשמל","מים","סלולרי","ביטוחים","רכב – ביטוח/טסט/דלק","חנייה","מנויים","חינוך/גן","אחר"];
    const VARIABLE = ["מזון","מסעדות/בילויים/חיי לילה","קניות/אופנה","פארם/טיפוח","שונות","מתנות","תחבורה ציבורית/מוניות","נסיעות/טיסות","תחזוקת בית","בריאות/תרופות"];

    /* ========= STORAGE ========= */
    const ROOT_KEY = 'smartwallet_v10_root';
    function defaultMonthState(){
      return {
        totalBudget: 0,
        overdraft: 0,
        transactions: [],
        pensions: [],
        recurring: [],
        savings:{ krans:[], deposits:[], goals:[] }
      };
    }
    function loadRoot(){ try{ return JSON.parse(localStorage.getItem(ROOT_KEY)) || {}; } catch{ return {}; } }
    function persistLocal(){ localStorage.setItem(ROOT_KEY, JSON.stringify(ROOT)); }
    let saveRoot = persistLocal;

    function prevMonthKey(key){
      const [y,m] = key.split('-').map(Number);
      const d = new Date(y, m-2, 1);
      return ym(d);
    }
    function isSameMonth(iso, key=ROOT.current){
      const d=new Date(iso); const [y,m]=key.split('-').map(Number);
      return d.getFullYear()===y && (d.getMonth()+1)===m;
    }
    function ensureMonth(key){
      if(!ROOT.months[key]){
        ROOT.months[key] = defaultMonthState();
        const pk = prevMonthKey(key);
        const prev = ROOT.months[pk];
        if (prev){
          const { surplus } = monthlyTotalsFor(pk);
          ROOT.months[key].overdraft = toNumber(prev.overdraft||0) + surplus;
          ROOT.months[key].recurring = JSON.parse(JSON.stringify(prev.recurring||[]));
          ROOT.months[key].pensions  = JSON.parse(JSON.stringify(prev.pensions||[]));
          ROOT.months[key].savings   = JSON.parse(JSON.stringify(prev.savings||{krans:[],deposits:[],goals:[]}));
        }
      }
    }
    function S(){ return ROOT.months[ROOT.current]; }

    /* ========= INIT ========= */
    let ROOT = loadRoot() || {};
    if(!ROOT.months) ROOT.months = {};
    if(!ROOT.current) ROOT.current = '2025-08';
    if(!ROOT.petty) ROOT.petty = { budgetCap:0, transactions:[] };
    if(!ROOT.notes) ROOT.notes = [];
    ensureMonth(ROOT.current); // חשוב: לא נשמור כאן כדי לא לדרוס

    /* ========= CLOUD SYNC (אופציונלי ובטוח) ========= */
    function hasRealData(root){
      if (!root || typeof root !== 'object') return false;
      const months = root.months || {};
      return Object.keys(months).some(k=>{
        const m = months[k] || {};
        return (Number(m.totalBudget||0) > 0) ||
               (Number(m.overdraft||0)   > 0) ||
               (Array.isArray(m.transactions) && m.transactions.length) ||
               (Array.isArray(m.recurring)    && m.recurring.length)    ||
               (Array.isArray(m.pensions)     && m.pensions.length)     ||
               (m.savings && (
                 (m.savings.krans||[]).length ||
                 (m.savings.deposits||[]).length ||
                 (m.savings.goals||[]).length
               ));
      });
    }

    async function cloudLoad(hh){
      if(!CLOUD_SYNC || !sb) return null;
      try{
        const { data, error } = await sb.from('wallet').select('data').eq('household', hh).maybeSingle();
        if(error){ console.warn('[cloud] load', error); return null; }
        return data?.data || null;
      }catch(e){ console.warn('[cloud] ex', e); return null; }
    }

    async function cloudSaveNow(){
      if(!CLOUD_SYNC || !sb) return;
      if(!hasRealData(ROOT)){ console.warn('[cloud] skip empty'); return; }
      try{ await sb.from('wallet').upsert({ household: HOUSEHOLD_ID, data: ROOT }); }
      catch(e){ console.warn('[cloud] save ex', e); }
    }
    let __cloudTimer=null;
    function cloudSave(){ if(!CLOUD_SYNC) return; clearTimeout(__cloudTimer); __cloudTimer=setTimeout(cloudSaveNow,300); }

    if(CLOUD_SYNC){
      const orig = saveRoot;
      saveRoot = function(){ orig(); cloudSave(); };
    }

    async function initCloudSync(){
      if(!CLOUD_SYNC) return;
      const cloud = await cloudLoad(HOUSEHOLD_ID);
      if (cloud && hasRealData(cloud)){
        ROOT = cloud;
        if(!ROOT.months) ROOT.months={};
        if(!ROOT.current) ROOT.current='2025-08';
        if(!ROOT.petty) ROOT.petty={budgetCap:0,transactions:[]};
        if(!ROOT.notes) ROOT.notes=[];
        ensureMonth(ROOT.current);
        localStorage.setItem(HH_KEY, HOUSEHOLD_ID);
      } else {
        // אין ענן/ריק – לא כותבים אפס לענן, נשארים לוקאלית
        if(!hasRealData(ROOT)){
          ROOT = { months:{}, current:'2025-08', petty:{budgetCap:0,transactions:[]}, notes:[] };
          ensureMonth(ROOT.current);
        }
      }
    }

    /* ========= HELPERS ========= */
    function monthLabel(key){ const d=new Date(key+'-01'); return d.toLocaleDateString('he-IL',{month:'long',year:'numeric'}); }
    function setCurrentMonthLabel(){ const el=document.getElementById('currentMonthLabel'); if(el) el.textContent = monthLabel(ROOT.current); }

    function monthlyTotalsFor(key){
      const state = ROOT.months[key] || defaultMonthState();
      let net=0, gross=0, exp=0;
      for(const t of state.transactions||[]){
        if(!isSameMonth(t.date, key)) continue;
        if(t.type==='income'){ net += toNumber(t.amount); gross += toNumber(t.gross || t.amount); }
        else { exp += toNumber(t.amount); }
      }
      const fixed = (state.recurring||[]).reduce((s,r)=> s + toNumber(r.amount||0), 0);
      return { net, gross, exp, fixed, surplus: net - (exp + fixed) };
    }

    function savingsOtherTotalFor(state){
      const k = (state.savings?.krans||[]).reduce((s,x)=> s + toNumber(x.balance||0), 0);
      const d = (state.savings?.deposits||[]).reduce((s,x)=> s + toNumber(x.balance||0), 0);
      const g = (state.savings?.goals||[]).reduce((s,x)=> s + toNumber(x.balance||0), 0);
      return k+d+g;
    }
    function pensionTotalFor(state){
      return (state.pensions||[]).reduce((s,p)=> s + toNumber(p.balance||0), 0);
    }

    /* ========= FORWARD ========= */
    function monthsOnOrAfter(currentKey){
      return Object.keys(ROOT.months).filter(k=> k>=currentKey).sort();
    }
    function propagateOverdraftForward(value){
      monthsOnOrAfter(ROOT.current).forEach(k=>{
        if(!ROOT.months[k]) ROOT.months[k]=defaultMonthState();
        ROOT.months[k].overdraft = toNumber(value);
      });
    }
    function propagateSavingsForward(){
      const src = JSON.parse(JSON.stringify(S().savings||{krans:[],deposits:[],goals:[]}));
      monthsOnOrAfter(ROOT.current).forEach(k=>{
        ensureMonth(k);
        ROOT.months[k].savings = JSON.parse(JSON.stringify(src));
      });
    }
    function propagatePensionsForward(){
      const src = JSON.parse(JSON.stringify(S().pensions||[]));
      monthsOnOrAfter(ROOT.current).forEach(k=>{
        ensureMonth(k);
        ROOT.months[k].pensions = JSON.parse(JSON.stringify(src));
      });
    }
    function propagateRecurringForward(){
      const src = JSON.parse(JSON.stringify(S().recurring||[]));
      monthsOnOrAfter(ROOT.current).forEach(k=>{
        ensureMonth(k);
        ROOT.months[k].recurring = JSON.parse(JSON.stringify(src));
      });
    }

    /* ========= GAUGES ========= */
    const gaugeColor = (p) => p<=0.75? 'var(--accent)' : p<=0.9? 'var(--warn)' : p<=1.0? '#f97316' : 'var(--danger)';
    function setGauge(p, spent, left){
      const clamped = Math.max(0, Math.min(1.2, Number.isFinite(p)? p : 0));
      const path = document.getElementById('gValue');
      const len = path.getTotalLength ? path.getTotalLength() : 125.6;
      const draw = Math.min(len, len * Math.min(1, clamped));
      path.setAttribute('stroke-dasharray', `${draw} 999`);
      path.setAttribute('stroke', gaugeColor(clamped));
      const pct = Math.round((clamped||0)*100);
      const center = document.getElementById('centerPct'); if(center) center.textContent = pct+'%';
      document.getElementById('spentLabel').textContent = ils(spent);
      const leftEl = document.getElementById('leftLabel');
      leftEl.textContent = ils(left);
      leftEl.className = (left < 0 ? 'text-red-400 ' : '') + 'font-semibold';
    }
    function setPettyGauge(p, spent, left){
      const path = document.getElementById('pettyVal');
      const len = path.getTotalLength ? path.getTotalLength() : 125.6;
      const draw = Math.min(len, len * Math.max(0, Math.min(1, p||0)));
      path.setAttribute('stroke-dasharray', `${draw} 999`);
      path.setAttribute('stroke', gaugeColor(p||0));
      const pct = Math.round(Math.max(0, Math.min(1, p||0))*100);
      const t = document.getElementById('pettyPct'); if(t) t.textContent = pct+'%';
      document.getElementById('pettySpent').textContent = ils(spent);
      const L = document.getElementById('pettyLeft'); L.textContent = ils(left); L.className = (left<0?'text-red-400 ':'')+'font-semibold';
    }

    /* ========= TOTALS / RENDER ========= */
    function totals(){
      let net=0, gross=0, exp=0; const incomes=[], expenses=[];
      for(const t of S().transactions){
        if(!isSameMonth(t.date)) continue;
        if(t.type==='income'){ net += toNumber(t.amount); gross += toNumber(t.gross || t.amount); incomes.push(t); }
        else { exp += toNumber(t.amount); expenses.push(t); }
      }
      return {net,gross,exp,incomes,expenses};
    }

    function initCategorySelects(){
      const selAdd = document.getElementById('catSelect');
      const selEdit = document.getElementById('editCategory');
      const selFilter = document.getElementById('filterCat');
      const pettyCat  = document.getElementById('pettyCat');
      const fill = (sel, list, firstLabel) => {
        if(!sel) return;
        sel.innerHTML='';
        const arr = firstLabel ? [firstLabel, ...list] : list.slice();
        arr.forEach((c,i)=>{ const o=document.createElement('option'); o.value=i?(c||'') : ''; o.textContent=c; sel.appendChild(o);});
      };
      fill(selAdd, VARIABLE, "— בחר קטגוריה —");
      fill(selFilter, VARIABLE, "כל הקטגוריות");
      fill(selEdit, VARIABLE, null);
      fill(pettyCat, VARIABLE, "— בחר קטגוריה —");
    }
    function updateCatBadge(){
      const sel = document.getElementById('catSelect'); const badge = document.getElementById('catBadge');
      if(!sel || !badge) return;
      const cat = sel.value;
      badge.classList.toggle('hidden', !cat);
      if(cat){ badge.textContent = `קטגוריה: "${cat}"`; }
    }

    function renderIncomeList(){
      const {incomes, gross, net} = totals();
      const ul = document.getElementById('incomeList'); ul.innerHTML='';
      incomes.sort((a,b)=> new Date(b.date) - new Date(a.date));
      incomes.forEach(x=>{
        const li=document.createElement('li'); li.className='row flex items-center justify-between gap-2';
        li.innerHTML = `
          <div class="flex flex-col">
            <span class="text-emerald-300">הכנסה • ${esc(x.category||'')}</span>
            <span class="text-slate-400 text-xs">${new Date(x.date).toLocaleDateString('he-IL')}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-semibold">${ils(x.amount)} · ברוטו ${ils(x.gross||x.amount)}</span>
            <button class="btn btn-ghost text-xs min-h-[36px]" data-edit="${esc(x.id)}" type="button">⋯</button>
          </div>`;
        li.querySelector('[data-edit]')?.addEventListener('click', ()=> openEdit(x.id));
        ul.appendChild(li);
      });
      document.getElementById('grossSum').textContent = ils(gross);
      document.getElementById('netSum').textContent   = ils(net);
    }

    function renderPensions(){
      const list = document.getElementById('pensionList'); if(!list) return; list.innerHTML='';
      const total = pensionTotalFor(S());
      const totalEl = document.getElementById('penTotal'); if(totalEl) totalEl.textContent = ils(total);
      if((S().pensions||[]).length===0){
        const li=document.createElement('li'); li.className='text-slate-400 text-sm'; li.textContent='אין חשבונות פנסיה—הוסף/י למעלה.'; list.appendChild(li);
      } else {
        S().pensions.forEach(p=>{
          const li=document.createElement('li'); li.className='row card p-3 flex items-center justify-between';
          li.innerHTML= `
            <div>
              <div class="font-medium">${esc(p.owner)}</div>
              <div class="text-xs text-slate-500">עודכן: ${new Date(p.lastUpdate).toLocaleDateString('he-IL')}</div>
            </div>
            <div class="flex items-center gap-4">
              <div class="text-sm">יתרה: ${ils(p.balance)}</div>
              <div class="text-sm">הכנסה חודשית: ${ils(p.monthly)}</div>
              <button class="btn btn-danger text-xs" data-del="${esc(p.id)}" type="button">מחק</button>
            </div>`;
          li.querySelector('[data-del]')?.addEventListener('click', ()=> deletePension(p.id));
          list.appendChild(li);
        });
      }
    }

    function renderExpensesList(){
      const ul = document.getElementById('expenseList'); if(!ul) return; ul.innerHTML='';
      const q = (document.getElementById('filterText').value||'').trim().toLowerCase();
      const fcat = document.getElementById('filterCat').value||'';
      const df = document.getElementById('filterFrom').value||'';
      const dt = document.getElementById('filterTo').value||'';
      const sortBy = document.getElementById('sortBy').value||'date_desc';

      let list = S().transactions.filter(x=> x.type==='expense' && isSameMonth(x.date));
      if(q) list = list.filter(x=> (x.merchant||'').toLowerCase().includes(q) || (x.category||'').toLowerCase().includes(q));
      if(fcat) list = list.filter(x=> x.category===fcat);
      if(df){ const from = new Date(df); list = list.filter(x=> new Date(x.date)>=from); }
      if(dt){ const to = new Date(dt); to.setHours(23,59,59,999); list = list.filter(x=> new Date(x.date)<=to); }

      list.sort((a,b)=>{
        if(sortBy==='date_desc') return new Date(b.date) - new Date(a.date);
        if(sortBy==='date_asc') return new Date(a.date) - new Date(b.date);
        if(sortBy==='amt_desc') return toNumber(b.amount) - toNumber(a.amount);
        if(sortBy==='amt_asc') return toNumber(a.amount) - toNumber(b.amount);
        return 0;
      });

      list.forEach(x=>{
        const li=document.createElement('li'); li.className='row flex items-center justify-between gap-2';
        li.innerHTML = `
          <div class="flex flex-col">
            <span>${esc(x.category)}${x.merchant ? ' • '+esc(x.merchant) : ''}</span>
            <span class="text-slate-400 text-xs">${new Date(x.date).toLocaleDateString('he-IL')}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-semibold">${ils(x.amount)}</span>
            <button class="btn btn-ghost text-xs min-h-[36px]" data-edit="${esc(x.id)}" type="button">⋯</button>
          </div>`;
        li.querySelector('[data-edit]')?.addEventListener('click', ()=> openEdit(x.id));
        ul.appendChild(li);
      });

      document.getElementById('kpiCurExp').textContent = ils(totals().exp);
    }

    function renderFixed(){
      const ul=document.getElementById('fixedList'); if(!ul) return; ul.innerHTML='';
      (S().recurring||[]).forEach(r=>{
        const li=document.createElement('li'); li.className='row card p-3 flex items-center justify-between';
        li.innerHTML= `
          <div>
            <div class="font-medium">${esc(r.name)}</div>
            ${r.note ? `<div class="text-xs text-slate-500 mt-0.5">${esc(r.note)}</div>` : '<div class="text-xs text-slate-500">חיוב חודשי פעיל</div>'}
          </div>
          <div class="flex items-center gap-3">
            <div class="text-sm">${ils(r.amount)} לחודש</div>
            <button class="btn btn-danger text-xs" data-del="${esc(r.id)}" type="button">מחק</button>
          </div>`;
        li.querySelector('[data-del]')?.addEventListener('click',()=>{
          const i=S().recurring.findIndex(x=>x.id===r.id);
          if(i>-1){S().recurring.splice(i,1); propagateRecurringForward(); saveRoot(); renderAll();}
        });
        ul.appendChild(li);
      });
    }

    function renderSavings(){
      const krList=document.getElementById('krList');
      if(krList){
        krList.innerHTML='';
        (S().savings.krans||[]).forEach(k=>{
          const li=document.createElement('li');
          li.className='row card p-3 flex items-center justify-between';
          li.innerHTML= `
            <div class="font-medium">${esc(k.name)}</div>
            <div class="text-sm">יתרה: ${ils(k.balance)} · ${toNumber(k.monthly||0)>0 ? `חודשי: ${ils(k.monthly)}` : 'ללא הפקדה חודשית'}</div>
            <button class="btn btn-danger text-xs" data-del-kr="${esc(k.id)}" type="button">מחק</button>`;
          li.querySelector('[data-del-kr]')?.addEventListener('click', ()=>{
            const i=S().savings.krans.findIndex(x=>x.id===k.id);
            if(i>-1){ S().savings.krans.splice(i,1); propagateSavingsForward(); saveRoot(); renderSavings(); toast('נמחק'); }
          });
          krList.appendChild(li);
        });
      }
      const depList=document.getElementById('depList');
      if(depList){
        depList.innerHTML='';
        (S().savings.deposits||[]).forEach(d=>{
          const li=document.createElement('li');
          li.className='row card p-3 flex items-center justify-between';
          const monthly = toNumber(d.monthly||0)>0 ? ` · חודשי: ${ils(d.monthly)}` : '';
          li.innerHTML= `
            <div class="font-medium">${esc(d.name)}</div>
            <div class="text-sm">יתרה: ${ils(d.balance)}${monthly}</div>
            <button class="btn btn-danger text-xs" data-del-dep="${esc(d.id)}" type="button">מחק</button>`;
          li.querySelector('[data-del-dep]')?.addEventListener('click', ()=>{
            const i=S().savings.deposits.findIndex(x=>x.id===d.id);
            if(i>-1){ S().savings.deposits.splice(i,1); propagateSavingsForward(); saveRoot(); renderSavings(); toast('נמחק'); }
          });
          depList.appendChild(li);
        });
      }
      const goalList=document.getElementById('goalList');
      if(goalList){
        goalList.innerHTML='';
        (S().savings.goals||[]).forEach(g=>{
          const pct=Math.min(100, Math.round((toNumber(g.balance||0)/Math.max(1,toNumber(g.target||0)))*100));
          const li=document.createElement('li');
          li.className='card p-3';
          li.innerHTML= `
            <div class="flex items-center justify-between mb-1">
              <div class="font-medium">${esc(g.name)}</div>
              <div class="text-sm">${ils(g.balance||0)} / ${ils(g.target||0)} · ${pct}%</div>
            </div>
            <div class="progress"><div style="width:${pct}%"></div></div>
            <div class="mt-2 text-right">
              <button class="btn btn-danger text-xs" data-del-goal="${esc(g.id)}" type="button">מחק</button>
            </div>`;
          li.querySelector('[data-del-goal]')?.addEventListener('click', ()=>{
            const i=S().savings.goals.findIndex(x=>x.id===g.id);
            if(i>-1){ S().savings.goals.splice(i,1); propagateSavingsForward(); save
                                 if(i>-1){ S().savings.goals.splice(i,1); propagateSavingsForward(); saveRoot(); renderSavings(); toast('נמחק'); }
          });
          goalList.appendChild(li);
        });
      }
      // סיכומי חיסכון כוללים
      const savTotal = savingsOtherTotalFor(S());
      const penTotal = pensionTotalFor(S());
      const kpiSav = document.getElementById('kpiSavingsTotal'); if(kpiSav) kpiSav.textContent = ils(savTotal);
      const kpiPen = document.getElementById('kpiPensionTotal'); if(kpiPen) kpiPen.textContent = ils(penTotal);
    }

    function renderKPIsAndGauge(){
      const s = S();
      const { net, gross, exp } = totals();
      const fixed = (s.recurring||[]).reduce((sum,r)=> sum + toNumber(r.amount||0), 0);
      const budget = toNumber(s.totalBudget||0);
      const spent = exp + fixed;
      const left = (budget||0) - spent;

      const kpiB = document.getElementById('kpiBudget');      if(kpiB) kpiB.textContent = ils(budget);
      const kpiE = document.getElementById('kpiCurExp');      if(kpiE) kpiE.textContent = ils(exp);
      const kpiS = document.getElementById('kpiSurplus');     if(kpiS) kpiS.textContent = ils(net - spent);
      const kpiO = document.getElementById('kpiOverdraft');   if(kpiO) kpiO.textContent = ils(s.overdraft||0);

      const p = budget>0 ? (spent / budget) : 0;
      setGauge(p, spent, left);
    }

    function renderPetty(){
      const cap = toNumber(ROOT.petty?.budgetCap||0);
      const list = ROOT.petty?.transactions||[];
      let exp = 0;
      list.forEach(x=> exp += toNumber(x.amount||0));
      const left = cap - exp;
      const pct = cap>0 ? (exp/cap) : 0;
      setPettyGauge(pct, exp, left);

      const ul = document.getElementById('pettyList'); if(!ul) return; ul.innerHTML='';
      [...list].sort((a,b)=> new Date(b.date) - new Date(a.date)).forEach(x=>{
        const li = document.createElement('li'); li.className='row flex items-center justify-between gap-2';
        li.innerHTML = `
          <div class="flex flex-col">
            <span>${esc(x.category)}${x.merchant?' • '+esc(x.merchant):''}</span>
            <span class="text-slate-400 text-xs">${new Date(x.date).toLocaleDateString('he-IL')}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-semibold">${ils(x.amount)}</span>
            <button class="btn btn-ghost text-xs min-h-[36px]" data-del="${esc(x.id)}" type="button">מחק</button>
          </div>`;
        li.querySelector('[data-del]')?.addEventListener('click', ()=>{
          const i = ROOT.petty.transactions.findIndex(t=>t.id===x.id);
          if(i>-1){ ROOT.petty.transactions.splice(i,1); saveRoot(); renderPetty(); toast('נמחק'); }
        });
        ul.appendChild(li);
      });
    }

    function renderNotes(){
      const genUL = document.getElementById('notesGeneral'); if(genUL) genUL.innerHTML='';
      const dayUL = document.getElementById('notesDay'); if(dayUL) dayUL.innerHTML='';

      const all = ROOT.notes||[];

      // כללי (ללא due)
      (all.filter(n=>!n.due)).sort((a,b)=> (b.ts||0)-(a.ts||0)).forEach(n=>{
        const li=document.createElement('li'); li.className='row card p-3 flex items-start justify-between';
        li.innerHTML = `
          <div>
            <div class="font-medium">${esc(n.title||'ללא כותרת')}</div>
            ${n.body?`<div class="text-xs text-slate-400 whitespace-pre-line mt-1">${esc(n.body)}</div>`:''}
          </div>
          <button class="btn btn-danger text-xs" data-del="${esc(n.id)}" type="button">מחק</button>`;
        li.querySelector('[data-del]')?.addEventListener('click', ()=>{
          const i=ROOT.notes.findIndex(x=>x.id===n.id);
          if(i>-1){ ROOT.notes.splice(i,1); saveRoot(); renderNotes(); toast('נמחק'); }
        });
        genUL?.appendChild(li);
      });

      // לוח שנה
      buildCalendar();
    }

    function renderAll(){
      setCurrentMonthLabel();
      initCategorySelects();
      updateCatBadge();
      renderIncomeList();
      renderExpensesList();
      renderFixed();
      renderSavings();
      renderKPIsAndGauge();
      renderPetty();
      renderNotes();
    }

    /* ========= EDIT MODAL ========= */
    function openEdit(id){
      const modal = document.getElementById('editModal');
      const s = S();
      const all = [...(s.transactions||[])];
      const t = all.find(x=>x.id===id);
      if(!t) return;
      document.getElementById('editId').value = t.id;
      document.getElementById('editType').value = t.type;
      document.getElementById('editAmount').value = toNumber(t.amount||0);
      document.getElementById('editMerchant').value = t.merchant||'';
      document.getElementById('editCategory').value = t.category||'';
      document.getElementById('editDate').value = toInputDate(t.date);
      document.getElementById('editCategoryLabel').style.display = (t.type==='income' ? 'none' : '');
      document.getElementById('editCategory').disabled = (t.type==='income');
      modal.classList.remove('hidden'); modal.classList.add('flex');
    }
    function closeEdit(){ const m=document.getElementById('editModal'); m.classList.add('hidden'); m.classList.remove('flex'); }

    // שינוי סוג בעורך
    document.getElementById('editType')?.addEventListener('change', (e)=>{
      const isIncome = e.target.value==='income';
      document.getElementById('editCategoryLabel').style.display = isIncome ? 'none' : '';
      document.getElementById('editCategory').disabled = isIncome;
    });

    document.getElementById('editClose')?.addEventListener('click', closeEdit);
    document.getElementById('editCancel')?.addEventListener('click', closeEdit);

    document.getElementById('editDelete')?.addEventListener('click', ()=>{
      const id = document.getElementById('editId').value;
      const i = S().transactions.findIndex(x=>x.id===id);
      if(i>-1){
        const wasIncome = S().transactions[i].type==='income';
        S().transactions.splice(i,1);
        saveRoot(); renderAll(); toast('נמחק');
        closeEdit();
      }
    });

    document.getElementById('formEdit')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = document.getElementById('editId').value;
      const type = document.getElementById('editType').value;
      const amount = toNumber(document.getElementById('editAmount').value);
      const merchant = document.getElementById('editMerchant').value.trim();
      const category = document.getElementById('editCategory').value;
      const date = document.getElementById('editDate').value || new Date().toISOString();

      const t = S().transactions.find(x=>x.id===id);
      if(!t) return;
      t.type = type;
      t.amount = amount;
      t.merchant = merchant;
      t.category = (type==='income') ? (t.category||'שכר') : category;
      t.date = date;
      saveRoot(); renderAll(); toast('נשמר');
      closeEdit();
    });

    /* ========= FORMS ========= */
    // הוצאה משתנה
    document.getElementById('formExpense')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const amount = toNumber(document.getElementById('expAmount').value);
      const merchant = document.getElementById('expMerchant').value.trim();
      const category = document.getElementById('catSelect').value;
      const date = document.getElementById('expDate').value || new Date().toISOString();
      if(!amount || !category){ toast('סכום וקטגוריה חובה'); return; }
      S().transactions.push({ id:uuid(), type:'expense', amount, merchant, category, date });
      saveRoot(); renderExpensesList(); renderKPIsAndGauge(); toast('נוסף');
      e.target.reset(); updateCatBadge();
    });
    document.getElementById('catSelect')?.addEventListener('change', updateCatBadge);
    document.getElementById('filterText')?.addEventListener('input', renderExpensesList);
    document.getElementById('filterCat')?.addEventListener('change', renderExpensesList);
    document.getElementById('filterFrom')?.addEventListener('change', renderExpensesList);
    document.getElementById('filterTo')?.addEventListener('change', renderExpensesList);
    document.getElementById('sortBy')?.addEventListener('change', renderExpensesList);

    // הכנסה
    document.getElementById('btnAddIncomeInline')?.addEventListener('click', ()=>{
      const f = document.getElementById('formIncomeInline');
      f.classList.toggle('hidden');
    });
    document.getElementById('formIncomeInline')?.addEventListener('submit',(e)=>{
      e.preventDefault();
      const net  = toNumber(document.getElementById('incomeNet').value);
      const gross= toNumber(document.getElementById('incomeGross').value||net);
      const src  = document.getElementById('incomeSource').value.trim() || 'שכר';
      const date = document.getElementById('incomeDate').value || new Date().toISOString();
      if(!net){ toast('חסר נטו'); return; }
      S().transactions.push({ id:uuid(), type:'income', amount:net, gross, category:src, date });
      saveRoot(); renderIncomeList(); renderKPIsAndGauge(); toast('נוסף');
      e.target.reset();
    });

    // קבועות
    document.getElementById('formFixedAdd')?.addEventListener('submit',(e)=>{
      e.preventDefault();
      const name = document.getElementById('fixName').value;
      const amount = toNumber(document.getElementById('fixAmount').value);
      const note = document.getElementById('fixNote').value.trim();
      if(!amount){ toast('חסר סכום'); return; }
      S().recurring.push({ id:uuid(), name, amount, note });
      propagateRecurringForward();
      saveRoot(); renderFixed(); renderKPIsAndGauge(); toast('נוסף');
      e.target.reset();
    });

    // פנסיה
    document.getElementById('formPensionAdd')?.addEventListener('submit',(e)=>{
      e.preventDefault();
      const owner = document.getElementById('penOwner').value.trim() || 'ללא שם';
      const balance = toNumber(document.getElementById('penBalance').value||0);
      const monthly = toNumber(document.getElementById('penMonthly').value||0);
      const id = uuid();
      const idx = (S().pensions||[]).findIndex(p=>p.owner===owner);
      const obj = { id, owner, balance, monthly, lastUpdate:new Date().toISOString() };
      if(idx>-1){ S().pensions[idx] = { ...S().pensions[idx], ...obj }; }
      else { if(!S().pensions) S().pensions=[]; S().pensions.push(obj); }
      propagatePensionsForward();
      saveRoot(); renderPensions(); renderSavings(); toast('נשמר');
      e.target.reset();
    });

    // קרן השתלמות
    const krHasMonthly = document.getElementById('krHasMonthly');
    const krMonthly = document.getElementById('krMonthly');
    krHasMonthly?.addEventListener('change', ()=>{ krMonthly.disabled = !krHasMonthly.checked; if(!krHasMonthly.checked) krMonthly.value=''; });
    document.getElementById('formKeren')?.addEventListener('submit',(e)=>{
      e.preventDefault();
      const name = document.getElementById('krName').value.trim() || 'ללא שם';
      const balance = toNumber(document.getElementById('krBalance').value||0);
      const monthly = krHasMonthly?.checked ? toNumber(krMonthly.value||0) : 0;
      if(!S().savings) S().savings={krans:[],deposits:[],goals:[]};
      S().savings.krans.push({ id:uuid(), name, balance, monthly });
      propagateSavingsForward();
      saveRoot(); renderSavings(); toast('נוסף');
      e.target.reset(); if(krMonthly) krMonthly.disabled = true;
    });

    // פיקדון כללי
    const depHasMonthly = document.getElementById('depHasMonthly');
    const depAdd = document.getElementById('depAdd');
    depHasMonthly?.addEventListener('change', ()=>{ depAdd.disabled = !depHasMonthly.checked; if(!depHasMonthly.checked) depAdd.value=''; });
    document.getElementById('formDeposit')?.addEventListener('submit',(e)=>{
      e.preventDefault();
      const name = document.getElementById('depName').value.trim() || 'ללא שם';
      const balance = toNumber(document.getElementById('depBalance').value||0);
      const monthly = depHasMonthly?.checked ? toNumber(depAdd.value||0) : 0;
      if(!S().savings) S().savings={krans:[],deposits:[],goals:[]};
      S().savings.deposits.push({ id:uuid(), name, balance, monthly });
      propagateSavingsForward();
      saveRoot(); renderSavings(); toast('נוסף');
      e.target.reset(); if(depAdd) depAdd.disabled = true;
    });

    // מטרה ייעודית
    document.getElementById('formGoal')?.addEventListener('submit',(e)=>{
      e.preventDefault();
      const name = document.getElementById('goalName').value.trim() || 'ללא שם';
      const target = toNumber(document.getElementById('goalTarget').value||0);
      const monthly = toNumber(document.getElementById('goalMonthly').value||0);
      if(!S().savings) S().savings={krans:[],deposits:[],goals:[]};
      S().savings.goals.push({ id:uuid(), name, target, monthly, balance:0 });
      propagateSavingsForward();
      saveRoot(); renderSavings(); toast('נוסף');
      e.target.reset();
    });

    // עו"ש
    document.getElementById('formOverdraftHome')?.addEventListener('submit',(e)=>{
      e.preventDefault();
      const v = toNumber(document.getElementById('ovHomeInput').value||0);
      propagateOverdraftForward(v);
      saveRoot(); renderKPIsAndGauge(); toast('עודכן לכל החודשים קדימה');
    });
    document.getElementById('ovToggle')?.addEventListener('click', ()=>{
      const f = document.getElementById('formOverdraftHome');
      const cur = f.getAttribute('aria-hidden')==='true';
      f.setAttribute('aria-hidden', String(!cur));
      f.style.display = cur? '' : 'none';
      document.getElementById('ovToggle').setAttribute('aria-expanded', String(cur));
    });

    // תקציב מהיר
    document.getElementById('btnBudgetQuickEdit')?.addEventListener('click', ()=>{
      const val = prompt('תקציב חודשי (₪):', String(S().totalBudget||0));
      if(val!=null){
        S().totalBudget = toNumber(val);
        saveRoot(); renderKPIsAndGauge(); toast('תקציב עודכן');
      }
    });

    /* ========= MONTH PICKER ========= */
    function openMonthPicker(){
      const modal = document.getElementById('monthPicker');
      const grid = document.getElementById('mpGrid'); grid.innerHTML='';
      const base = new Date(ROOT.current+'-01');
      // 18 חודשים אחורה/קדימה
      const months = [];
      for(let i=-12;i<=12;i++){
        const d = new Date(base.getFullYear(), base.getMonth()+i, 1);
        months.push({ key: ym(d), label: d.toLocaleDateString('he-IL',{month:'long',year:'numeric'}) });
      }
      months.forEach(m=>{
        const b=document.createElement('button');
        b.type='button'; b.className='row btn btn-ghost w-full';
        b.textContent = m.label;
        if(m.key===ROOT.current){ b.classList.add('on'); }
        b.addEventListener('click', ()=>{
          ROOT.current = m.key; ensureMonth(ROOT.current); saveRoot(); renderAll(); closeMonthPicker();
        });
        grid.appendChild(b);
      });
      modal.classList.remove('hidden'); modal.classList.add('flex');
    }
    function closeMonthPicker(){ const m=document.getElementById('monthPicker'); m.classList.add('hidden'); m.classList.remove('flex'); }
    document.getElementById('btnMonthPicker')?.addEventListener('click', openMonthPicker);
    document.getElementById('mpClose')?.addEventListener('click', closeMonthPicker);

    /* ========= NAV / TABS ========= */
    function showPanel(name){
      document.querySelectorAll('[data-view-panel]').forEach(p=> p.classList.add('hidden'));
      document.getElementById(`view-${name}`)?.classList.remove('hidden');

      document.querySelectorAll('#mainTabs [role="tab"]').forEach(b=>{
        const on = b.getAttribute('data-view')===name;
        b.classList.toggle('on', on);
        b.setAttribute('aria-selected', String(on));
      });
    }
    document.getElementById('mainTabs')?.addEventListener('click',(e)=>{
      const btn = e.target.closest('button[data-view]');
      if(!btn) return;
      showPanel(btn.getAttribute('data-view'));
    });

    // ניווט בר התחתון
    document.getElementById('navHome')?.addEventListener('click', ()=>{ showPanel('home'); window.scrollTo({top:0,behavior:'smooth'}); });
    document.getElementById('navPetty')?.addEventListener('click', ()=>{
      document.querySelectorAll('main .container, main section[aria-label]').forEach(()=>{});
      document.getElementById('view-petty')?.classList.remove('hidden');
      document.getElementById('view-notes')?.classList.add('hidden');
      document.getElementById('view-home')?.classList.add('hidden');
      document.getElementById('view-expenses')?.classList.add('hidden');
      document.getElementById('view-savings')?.classList.add('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    });
    document.getElementById('navNotes')?.addEventListener('click', ()=>{
      document.getElementById('view-notes')?.classList.remove('hidden');
      document.getElementById('view-petty')?.classList.add('hidden');
      document.getElementById('view-home')?.classList.add('hidden');
      document.getElementById('view-expenses')?.classList.add('hidden');
      document.getElementById('view-savings')?.classList.add('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    });

    /* ========= CALENDAR / NOTES ========= */
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

    let __calDate = new Date(); // חודש מוצג
    function buildCalendar(){
      const wrap = document.getElementById('calendarGrid'); if(!wrap) return; wrap.innerHTML='';
      const title = document.getElementById('calTitle');
      title.textContent = __calDate.toLocaleDateString('he-IL',{month:'long',year:'numeric'});

      const first = startOfMonth(__calDate);
      const last  = endOfMonth(__calDate);

      // יום בשבוע (0=א׳)
      const offset = (first.getDay()+6)%7; // להפוך ל־א׳ ראשון
      for(let i=0;i<offset;i++){
        const div=document.createElement('div'); div.className='p-2 rounded-lg text-slate-600 text-center'; wrap.appendChild(div);
      }
      for(let d=1; d<=last.getDate(); d++){
        const cur = new Date(__calDate.getFullYear(), __calDate.getMonth(), d);
        const key = cur.toISOString().slice(0,10);
        const todays = (ROOT.notes||[]).filter(n=> (n.due||'').slice(0,10)===key);
        const btn=document.createElement('button'); btn.type='button';
        btn.className='p-2 rounded-lg text-center border border-slate-800 hover:bg-slate-800/50';
        btn.innerHTML = `
          <div class="font-semibold">${d}</div>
          ${todays.length? `<div class="text-[10px] text-emerald-300">${todays.length} פתוחות</div>` : ''}`;
        btn.addEventListener('click', ()=> renderNotesForDay(key));
        wrap.appendChild(btn);
      }
      renderNotesForDay(new Date().toISOString().slice(0,10));
    }

    function renderNotesForDay(key){
      const dayUL = document.getElementById('notesDay'); if(!dayUL) return; dayUL.innerHTML='';
      const items = (ROOT.notes||[]).filter(n=> (n.due||'').slice(0,10)===key);
      if(items.length===0){
        const li=document.createElement('li'); li.className='text-sm text-slate-400'; li.textContent='אין הערות לתאריך זה.'; dayUL.appendChild(li); return;
      }
      items.sort((a,b)=> (b.ts||0)-(a.ts||0)).forEach(n=>{
        const li=document.createElement('li'); li.className='row card p-3 flex items-start justify-between';
        li.innerHTML = `
          <div>
            <div class="font-medium">${esc(n.title||'ללא כותרת')}</div>
            ${n.body?`<div class="text-xs text-slate-400 whitespace-pre-line mt-1">${esc(n.body)}</div>`:''}
          </div>
          <button class="btn btn-danger text-xs" data-del="${esc(n.id)}" type="button">מחק</button>`;
        li.querySelector('[data-del]')?.addEventListener('click', ()=>{
          const i=ROOT.notes.findIndex(x=>x.id===n.id);
          if(i>-1){ ROOT.notes.splice(i,1); saveRoot(); renderNotes(); toast('נמחק'); }
        });
        dayUL.appendChild(li);
      });
    }

    document.getElementById('calPrev')?.addEventListener('click', ()=>{ __calDate = new Date(__calDate.getFullYear(), __calDate.getMonth()-1, 1); buildCalendar(); });
    document.getElementById('calNext')?.addEventListener('click', ()=>{ __calDate = new Date(__calDate.getFullYear(), __calDate.getMonth()+1, 1); buildCalendar(); });

    // טופס הערות
    document.getElementById('formNote')?.addEventListener('submit',(e)=>{
      e.preventDefault();
      const title = document.getElementById('noteTitle').value.trim();
      const body  = document.getElementById('noteBody').value.trim();
      const due   = document.getElementById('noteDue').value || '';
      ROOT.notes.push({ id:uuid(), title, body, due, ts: Date.now() });
      saveRoot(); renderNotes(); toast('נוסף');
      e.target.reset();
    });

    /* ========= PETTY BAR ========= */
    document.getElementById('pettyBudgetBtn')?.addEventListener('click', ()=>{
      const v = prompt('תקציב קופה קטנה (₪):', String(toNumber(ROOT.petty?.budgetCap||0)));
      if(v!=null){
        if(!ROOT.petty) ROOT.petty={budgetCap:0,transactions:[]};
        ROOT.petty.budgetCap = toNumber(v);
        saveRoot(); renderPetty(); toast('תקציב עודכן');
      }
    });
    document.getElementById('formPettyExpense')?.addEventListener('submit',(e)=>{
      e.preventDefault();
      const amount = toNumber(document.getElementById('pettyAmount').value||0);
      const merchant = document.getElementById('pettyMerchant').value.trim();
      const category = document.getElementById('pettyCat').value;
      const date = document.getElementById('pettyDate').value || new Date().toISOString();
      if(!amount || !category){ toast('סכום וקטגוריה חובה'); return; }
      if(!ROOT.petty) ROOT.petty={budgetCap:0,transactions:[]};
      ROOT.petty.transactions.push({ id:uuid(), amount, merchant, category, date });
      saveRoot(); renderPetty(); toast('נוסף');
      e.target.reset();
    });

    /* ========= INIT ========= */
    (async function bootstrap(){
      try{
        await initCloudSync();
      } finally {
        // UI init
        document.getElementById('kpiOverdraft').textContent = ils(S().overdraft||0);
        setCurrentMonthLabel();
        renderAll();
      }
    })();
  </script>
</body>
</html>
